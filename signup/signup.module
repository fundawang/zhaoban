<?php

/*
 * This file is licensed under GPLv2+.
*/

/**
 * @file
 * Defines the the progress of signup.
 */
 
include_once(DRUPAL_ROOT . '/' . drupal_get_path('module', 'signup') . '/signup.inc');

function signup_init() {
  drupal_add_css(drupal_get_path('module', 'exams') .'/exams.css');
  drupal_add_js(drupal_get_path('module', 'signup') .'/signup.js');
}

/**
 * Implementation of hook_help().
 */
function signup_help($path, $arg) {
  switch ($path) {
  	case 'user/register':
  	  $output = t('Before you signup, it is suggested you must read the registration guide.');
  	  $output .= l(t('For demo, please click here.'), 'sites/default/files/zhaoban_demo.htm', array('attributes' => array('target' => array('_blank'))));
  	  
  	  break;
    case 'signup/overview':
      $output = t('Get an overview of how many students have signed up as a draft.');
      break;
    case 'signup/validated':
      $output = t('Check how many students who have validated till now.');
      break;
    case 'signup/passround1':
      $output = t('List all the students who have passed round 1.');
      break;
    case 'signup/passround3':
      $output = t('List all the students who have passed round 3.');
      break;
    case 'signup/passroundg':
      $output = t('List all the students who have passed round G.');
      break;
    case 'signup/passthrough':
      $output = t('You may use this feature to preset all the students who should pass through all the exam without attending actual examinations.');
      $output.= t('Those students will be forced to select corresponding profession, and do not need to fulfill all the exams.');
      $output.= t('And, the most important part is, all the scores of those students will be overwritten as 100 automatically by system at all time.');
      break;
  }
  if (isset($output))
  	return '<p>'.$output.'</p>';
}

/**
 * Implementation of hook_permission
 */
function signup_permission() {
  return array(
  	'preset passthrough' => array(
  	  'title' => t('Preset passthrough students'),
  	),
    'view draft' => array(
      'title' => t('View signed-up students'),
    ),
    'view validated' => array(
      'title' => t('View validated students'),
    ),
    'view passround1' => array(
      'title' => t('View those passed the 1st round examination'),
    ),
    'view passround3' => array(
      'title' => t('View those passed the profession examination'),
    ),
    'view passroundg' => array(
      'title' => t('View those is marked'),
    ),
    'view own draft' => array(
      'title' => t('View owned signed-up students'),
    ),
    'view own validated' => array(
      'title' => t('View owned validated students'),
    ),
    'view own passround1' => array(
      'title' => t('View owned those passed the 1st round examination'),
    ),
    'view own passround3' => array(
      'title' => t('View owned those passed the profession examination'),
    ),
    'view own passroundg' => array(
      'title' => t('View owned those marked'),
    ),
    'modify students info' => array(
      'title' => t('Modify students info'),
    ),
    'print user report' => array(
      'title' => t('Print users report'),
    ),
  );
}


/**
 * Implementation of hook_menu().
 */
function signup_menu() {
  $items['signup/schools_autocompletion'] = array(
    'title' => 'School Autocompletion',
    'page callback' => 'signup_schools_autocomplete',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['signup'] = array(
    'title' => 'Students',
    'description' => "Check the progress of students signup",
    'page callback' => 'signup_blocklist',
    'access callback' => 'signup_check_access',
  );

  $items['signup/passthrough'] = array(
    'title' => 'Preset passthrough students',
    'description' => "Preset passthrough students",
    'page callback' => 'drupal_get_form',
    'page arguments' => array('signup_preset_passthrough'),
    'access callback' => 'user_access',
    'access arguments'=> array('preset passthrough'),
  );
  $items['signup/overview'] = array(
    'title' => 'Students overview',
    'description' => "Check the draft of students signup",
    'page callback' => 'signup_overview_by_profession',
    'access callback' => 'signup_access_overview',
    'access arguments'=> array(2),
  );
  $items['signup/overview/profession'] = array(
    'title' => 'By Profession',
    'description' => "Check the draft of students signup",
    'page callback' => 'signup_overview_by_profession',
    'access callback' => 'signup_access_overview',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['signup/overview/profession/%'] = array(
    'title' => 'By Profession',
    'description' => "Check the draft of students signup",
    'page callback' => 'signup_overview_by_profession_detail',
    'page arguments' => array(3),
    'access callback' => 'signup_access_overview',
    'access arguments'=> array(2),
    'type' => MENU_CALLBACK,
  );
  $items['signup/overview/province'] = array(
    'title' => 'By Province',
    'page callback' => 'signup_overview_by_province',
    'type' => MENU_LOCAL_TASK,
    'access callback' => 'user_access',
    'access arguments'=> array('view draft'),
  );
  
  $items['signup/overview/province/%'] = array(
    'title' => 'By Profession',
    'description' => "Check the draft of students signup",
    'page callback' => 'signup_overview_by_province_detail',
    'page arguments' => array(3),
    'access callback' => 'signup_access_overview',
    'access arguments'=> array(2),
    'type' => MENU_CALLBACK,
  );
  $items['signup/2ndround'] = array(
    'title' => 'View 2nd round students',
    'description' => "Check the students which will be enrolled into 2nd round examination",
    'page callback' => 'signup_2nd_round_by_profession',
    'access callback' => 'signup_2nd_overview',
  );
  $items['signup/2ndround/profession'] = array(
    'title' => 'By Profession',
    'description' => "Check the students which will be enrolled into 2nd round examination",
    'page callback' => 'signup_2nd_round_by_profession',
    'access callback' => 'signup_2nd_overview',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['signup/2ndround/profession/%'] = array(
    'title' => 'By Profession',
    'description' => "Check individual profession",
    'page callback' => 'signup_2nd_round_by_profession_detail',
    'page arguments' => array(3),
    'access callback' => 'signup_2nd_overview',
    'type' => MENU_CALLBACK,
  );
  $items['signup/3rdround'] = array(
    'title' => 'View 3rd round students',
    'description' => "Check the students which will be enrolled into 3rd round examination",
    'page callback' => 'signup_3rd_round_by_profession',
    'access callback' => 'signup_3rd_overview',
  );
  $items['signup/3rdround/profession'] = array(
    'title' => 'By Profession',
    'description' => "Check the students which will be enrolled into 3rd round examination",
    'page callback' => 'signup_3rd_round_by_profession',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'access callback' => 'signup_3rd_overview',
  );
  $items['signup/3rdround/profession/%'] = array(
    'title' => 'By Profession',
    'description' => "Check individual profession",
    'page callback' => 'signup_3rd_round_by_profession_detail',
    'page arguments' => array(3),
    'access callback' => 'signup_3rd_overview',
    'type' => MENU_CALLBACK,
  );
  $items['signup/3rdround/province'] = array(
    'title' => 'By Province',
    'description' => "Check the students which will be enrolled into 3rd round examination",
    'page callback' => 'signup_3rd_round_by_province',
    'type' => MENU_LOCAL_TASK,
    'access callback' => 'signup_3rd_overview',
  );
  $items['signup/3rdround/province/%'] = array(
    'title' => 'By Province',
    'description' => "Check individual profession",
    'page callback' => 'signup_3rd_round_by_province_detail',
    'page arguments' => array(3),
    'access callback' => 'signup_3rd_overview',
    'type' => MENU_CALLBACK,
  );
  $items['signup/3rdround/province/%/download'] = array(
    'title' => 'Download database',
    'description' => "Download standard database for this province",
    'page callback' => 'signup_3rd_round_by_province_download',
    'page arguments' => array(3),
    'access callback' => 'signup_3rd_overview',
    'type' => MENU_CALLBACK,
  );
  $items['signup/3rdround/province/%/report'] = array(
    'title' => 'Print Report',
    'description' => "Download printable report for this province",
    'page callback' => 'signup_3rd_round_by_province_report',
    'page arguments' => array(3),
    'access callback' => 'signup_3rd_overview',
    'type' => MENU_CALLBACK,
  );
  $items['user/%user/report'] = array(
    'title' => 'Print Signup Report',
    'page callback' => 'sign_up_report',
    'page arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'access callback' => 'sign_up_report_perm',
    'access arguments'=> array(1),
  );
  $items['user/%user/picture.jpg'] = array(
    'title' => 'Fetch picture of student',
    'page callback' => 'sign_up_picture',
    'page arguments' => array(1),
    'type' => MENU_CALLBACK,
    'access callback' => 'sign_up_picture_perm',
    'access arguments'=> array(1),
  );
  return $items;
}

function signup_access_overview($ar=NULL) {
	if($ar=='province') return user_access('view draft');
	else return user_access('view draft')||user_access('view own draft');
}

function signup_check_access() {
	return user_access('view draft')||user_access('view own draft');
}

function signup_2nd_overview() {
	$r=db_select('students', 's')->fields('s')->condition('pass_round1_major','0','<>')->countQuery()->execute()->fetchField();
	return (user_access('view passround1') || user_access('view own passround1'))&& $r;
}

function signup_3rd_overview() {
	$r=db_select('students', 's')->fields('s')->condition('pass_round3_major','0','<>')->countQuery()->execute()->fetchField();
	return user_access('view passround3') && $r;
}

function sign_up_report_perm($uid) {
	return user_access('print user report') && db_select('students', 's')->fields('s')->condition('uid', $uid->name)->countQuery()->execute()->fetchField();
}

function sign_up_picture_perm($uid) {
	$query=db_select('students','s')->fields('s',array('picture'))->condition('uid', $uid->name);
	$img_tmp=$query->execute()->fetchField();
	if($img_tmp)
		$test=imagecreatefromstring(base64_decode($img_tmp));
	else $test=false;
	if($test)
		imagedestroy($test);
	return user_access('print user report') && db_select('students', 's')->fields('s')->condition('uid', $uid->name)->countQuery()->execute()->fetchField() && $test;
}

/**
 * Provide a single block from the administration menu as a page.
 * This function is often a destination for these blocks.
 * For example, 'admin/content/types' needs to have a destination to be valid
 * in the Drupal menu system, but too much information there might be
 * hidden, so we supply the contents of the block.
 *
 * @return
 *   The output HTML.
 */
function signup_blocklist() {
  $item = menu_get_item();
  $content = system_admin_menu_block($item);

  return theme('admin_block_content', array('content' => $content));
}

function genRandomString($len) 
{ 
    $chars = array( 
        "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k",  
        "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v",  
        "w", "x", "y", "z", "A", "B", "C", "D", "E", "F", "G",  
        "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R",  
        "S", "T", "U", "V", "W", "X", "Y", "Z", "0", "1", "2",  
        "3", "4", "5", "6", "7", "8", "9" 
    ); 
    $charsLen = count($chars) - 1; 
 
    shuffle($chars);
     
    $output = ""; 
    for ($i=0; $i<$len; $i++) 
    { 
        $output .= $chars[mt_rand(0, $charsLen)]; 
    } 
 
    return $output; 
 
}

function signup_get_random_mail_address(){
	return genRandomString(10).'@'.genRandomString(5).'.'.genRandomString(5).".com";
}

function signup_user_load($users) {
	$uids=array_keys($users);
	foreach($uids as $uid) {
		$users[$uid]->ucategory=db_select('students','s')->fields('s',array('ucategory'))->condition('uid',$users[$uid]->name)->execute()->fetchField();
	}
}

function signup_user_delete($account) {
	db_delete('students')
		->condition('uid', $account->name)
		->execute();
	db_delete('students_contact')
		->condition('uid', $account->name)
		->execute();
	db_delete('students_gk')
		->condition('uid', $account->name)
		->execute();
	db_delete('students_going')
		->condition('uid', $account->name)
		->execute();
}

function signup_user_goto($user) {

  if(!array_key_exists('5', $user->roles)) return;

  $r=_signup_determine_period($user);
  //var_dump($r);exit();
  drupal_get_messages('error');
  

  $perm = (user_access('administer users') || $user->uid==$GLOBALS['user']->uid) && $GLOBALS['user']->uid !=1;
  if($perm)
  switch($r) {
          case signup_progress_PERSONALINFORMATION:
                  drupal_goto('user/'.$user->uid.'/edit');
              return;
          case signup_progress_PROFESSION:
                  drupal_goto('user/'.$user->uid.'/edit/'.signup_user_PROFESSION);
              return;
          case signup_progress_EXAM:
                  drupal_goto('user/'.$user->uid.'/edit/'.signup_user_EXAM);
              return;
          case signup_progress_CONTACT:
                  drupal_goto('user/'.$user->uid.'/edit/'.signup_user_CONTACT);
              return;
          case signup_progress_GAOKAO:
                  drupal_goto('user/'.$user->uid.'/edit/'.signup_user_GAOKAO);
              return;
          case signup_progress_FINISH:
                  drupal_get_messages('status');
                  drupal_set_message('<big>'.t('You\'ve finished signing up progress. Please write down your examination ID and your password, then keep them in a safe place.').'</big>');
          	  	  if(arg(2)) drupal_goto('user/'.$user->uid);
  }

}

function signup_form_user_login_alter(&$form, &$form_state) {
	$form['name']['#attributes']['placeholder']=variable_get('zhaoban_current_year',date('Y')).'BXXXX';
	drupal_add_js(
		'jQuery(document).ready(function(){'.
			'deal_input_palceholder();});',
		'inline'
	);
}

function signup_form_user_register_form_alter(&$form, &$form_state) {
	
	// we don't need email address for this site
	$form['account']['mail']['#type']='hidden';
	$form['account']['mail']['#value']=signup_get_random_mail_address();
	
	if(!_is_valid_remote_address()) {
		drupal_access_denied(); exit();
	}
	// If guest is about to register as student
	if(!user_access('administer users')) {
		drupal_set_title(t('Sign up for new users'));

		// we are about to rewrite the whole register form
		unset($form['account']['mail']);
		unset($form['account']['name']);
		unset($form['account']['pass']);
		
		$form["actions"]['submit']['#value'] = t('Begin sign up');
		$form['#validate'] = array('signup_form_user_register_form_validate');
		$form['#submit'] = array('signup_form_user_register_form_submit');
		$form['ucategory'] = array(
			'#type' => 'radios',
			'#required' => TRUE,
			'#options' => array(
				'0' => t('I\'m a student of CCOM, and would like to take a secondary profession.'),
				'1' => t('I\'m a student inside China mainland.'),
				'2' => t('I\'m a Chinese student located in Hong Kong, Macau, Taiwan or outside China.'),
				'3' => t('I\'m a foreigner.'),
			),
			'#default_value' => '1',
		);
	}
	
}

function signup_form_user_register_form_validate($form, $form_state) {
}

// Hook functiono to take over the regsiter routine
function signup_form_user_register_form_submit($form, &$form_state) {
	$data=array();
	
	// Generate a radom password at 6 bit
	$data['pass']=user_password(6);
	$data['status']=1;
	$data['ucategory']=$form_state['values']['ucategory'];
	$data['mail']=signup_get_random_mail_address();
	$data['roles']=array( '5' => 'students');
	
	// Now generating the ID number of the student
	$query=db_select('users','u')->condition('u.name', variable_get('zhaoban_current_year',date('Y')).'B%', 'LIKE');
	$query->addExpression('MAX(name)');
	//var_dump($query);exit();
	$sid_prev=$query->execute()->fetchField();
	$data['name']=sprintf(variable_get('zhaoban_current_year',date('Y')).'B%04d',substr($sid_prev,5)+1);
	
	// Create the user !
	$user=user_save('',$data);
	
	// Affect our own table now
	db_insert('students')->fields(array(
		'uid' => $data['name'],
		'ucategory' => $data['ucategory'],
	))->execute();
	db_insert('students_gk')->fields(array(
		'uid' => $data['name'],
	))->execute();
	
	// Thanks god, we could output the username and password via message
	drupal_set_message(t("<p>Welcome registering at !site. For your convenient, we've assigned you a unique examination ID and the corresponding password. You will need to use the combination of examination ID and the password to access this site. Please write them down and keep them in a safe place. <span class=\"error\">The examination ID and the password are both case sensitive.</span></p><p>Your exam ID: <span class=\"error\">!username</span></p><p>Your current password: <span class=\"error\"><code>!password</code></span></p><p><em>Of course, you could change your password now, by typing the password you want twice.</em></p><p>Now, please fill in the following information, so that we could know who you are. You'll need to provide the correct information when resetting your password.</p>",
		array('!username'=>$data['name'], '!password'=>$data['pass'], '!site'=>variable_get('site_name', ''))));
	
	// We need to fill up more information after login
	$data['uid']=user_authenticate($data['name'], $data['pass']);
	user_login_submit(array(),$data);
	$form_state['redirect']='user/'.$data['uid'].'/edit';
}

function signup_form_user_profile_form_alter(&$form, $form_state) {
	$form['account']['current_pass']['#description']=t('Enter your current password to change the password.').t('If you forgot current password, <a href="@url">please click here</a> to reset password.', array('@url'=>'/user/password'));
	if(isset($form['account']['mail']) && $form['#user']->uid <> 1)
		$form['account']['mail']['#type']='hidden';
	if(in_array('5',array_keys($form['#user']->roles)))
		$form['account']['name']['#disabled']=TRUE;
	if(user_access('administer users')) return;
	if(in_array('5',array_keys($form['#user']->roles)))
	switch(arg(3)) {
		case signup_user_PROFESSION:
			$form=signup_user_professions_form($form, $form_state); break;
		case signup_user_EXAM:
			$form=signup_user_examinations_form($form, $form_state); break;
		case signup_user_CONTACT:
			$form=signup_user_contact_form($form, $form_state); break;
		case signup_user_GAOKAO:
			$form=signup_user_gaokao_form($form, $form_state); break;
		default:
			$form=signup_user_account_form($form, $form_state);
	}
//	var_dump($form);
	return $form;
}

function signup_user_account_form($form, $form_state) {
	
	$user=$form['#user'];
	
	$form['account']['#type']='fieldset';
	$form['account']['#collapsible']=TRUE;
	$form['account']['#collapsed']=TRUE;
	$form['account']['#title'] = t('Account & Password');
	//var_dump($form['account']);

	$form['account']['current_pass']['#description']=t('Enter your current password to change the password.').t('If you forgot current password, <a href="@url">please click here</a> to reset password.', array('@url'=>'/user/password'));
	// we don't need email address for this site
	
	// we don't want the student name to be modified
	if(in_array('5',array_keys($form['#user']->roles))) {
		$form['account']['name']['#required']=FALSE;
		$form['account']['name']['#value']=$form['account']['name']['#default_value'];
		$form['account']['name']['#disabled']=TRUE;
	}
	// Maybe contact is of no use here.
	unset($form['contact']);
	//var_dump($form);
	// Only administrators can delete user or modify the status;
	if ($GLOBALS['user']->uid!=1) {
		unset($form['delete']);
		unset($form['account']['status']);
		$form['account']['name']['#required']=FALSE;
		//$form['account']['name']['#value']=$form['account']['name']['#default_value'];
		$form['account']['name']['#disabled']=TRUE;
	}
     
		$is_student = array_key_exists('5',$user->roles);
		if(!user_access('modify students info') && $user->uid !== $GLOBALS['user']->uid) return;
		// we don't want the administer do anything, but it's fine if one has such permission.
		if($GLOBALS['user']->uid=='1') return;
		if(!$is_student) return;
	    //$isvalidated=db_result(db_query('SELECT s.validated FROM {students} s WHERE s.uid=\'%s\'', $user->name));
	    $isvalidated=db_select('students', 's')->fields('s',array('validated'))->condition('s.uid',$user->name)->execute()->fetchField();
	    $query=db_select('students','s')->condition('s.uid',$user->name);
	    $query->innerjoin('students_gk','sg','s.uid=sg.uid');
	    $default_values=$query->fields('s')->fields('sg',array('province','city_district'))->execute()->fetchObject();
	    
		$form['personal'] = array(
			'#type' => 'fieldset',
			'#title' => t('Personal information'),
			'#description' => t('You\'ll need to provide these information when reseting password. When typing alphabet, please use upper case.'),
			'#collapsible' => TRUE,
		);
     switch ($user->ucategory) {
       case uc_OWN_STUDENT: // Our own student
       {
         $form['personal']['idnumber'] = array('#type' => 'textfield',
           '#title' => t('Your Student ID'),
           '#default_value' => $default_values->idcard_number,
           '#maxlength' => 6,
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['truename'] = array('#type' => 'textfield',
           '#title' => t('Your Name'),
           '#default_value' => $default_values->name,
           '#maxlength' => 50,
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['province'] = array('#type' => 'hidden',
           '#value' => '000000');
        }
         break;
       case uc_MAINLAND_STUDENT: // China mainland student
       {
         $form['personal']['idnumber'] = array('#type' => 'textfield',
           '#title' => t('Your ID Card Number'),
           '#description' => t('We\'re calculating gender and date of birth based '.
             'on your ID card number. If you will be using military officer card to register, please input them in the format of @format.', array('@format'=>'X字第XXX号')),
           '#default_value' => $default_values->idcard_number,
           '#maxlength' => 18,
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['truename'] = array('#type' => 'textfield',
           '#title' => t('Your Name'),
           '#default_value' => $default_values->name,
           '#maxlength' => 50,
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         if(isset($form_state['rebuild_info']['need_show_genders']) && $form_state['rebuild_info']['need_show_genders']==1) {
	         $form['personal']['dateofbirth'] = array('#type' => 'date',
	           '#title' => t('Your date of birth'),
	           '#default_value' => array(
	             'year' => substr($default_values->date_of_birth,0,4),
	             'month' => 1*substr($default_values->date_of_birth,4,2),
	             'day' => 1*substr($default_values->date_of_birth,6,2)
	             ),
	           '#after_build' => array('__set_year_range'),
	           '#required' => !$isvalidated,
	           '#disabled' => $isvalidated,
	         );
	         $form['personal']['gender'] = array('#type' => 'radios',
	           '#title' => t('Your Gender'),
	           '#default_value' => $default_values->gender,
	           '#options' => array('1'=>t('Male'), '2'=>t('Female')),
	           '#required' => !$isvalidated,
	           '#disabled' => $isvalidated,
	         );
         }
         $form['personal']['province'] = array('#type' => 'select',
           '#title' => t('Province you live'),
           '#description' => t('The place you will be attending the exam.'),
           '#default_value' => $default_values->province,
           '#options' => array(),
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $dbo = db_select('vl_province','p')->fields('p')->condition('p.ucategory',$user->ucategory)->execute();
         foreach ($dbo as $result)
         {
           $r = array($result->pid => $result->name);
           $form['personal']['province']['#options'] += $r;
         }
         $form['personal']['nationality'] = array('#type' => 'select',
           '#title' => t('Your nationality'),
           '#default_value' => $default_values->nationality,
           '#options' => array(),
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $dbo = db_select('vl_nationality', 'n')->fields('n')->execute();
         foreach($dbo as $result)
         {
           $r = array($result->nid => $result->name);
           if ($result->nid != 98)
             $form['personal']['nationality']['#options'] += $r;
         }
         $form['personal']['political'] = array('#type' => 'select',
           '#title' => t('Your Political feature'),
           '#default_value' => $default_values->politics_feature,
           '#options' => array(),
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $dbo = db_select('vl_politics_features', 'p')->fields('p')->execute();
         foreach($dbo as $result)
         {
           $r = array($result->pid => $result->name);
             $form['personal']['political']['#options'] += $r;
         }
         break;
       }
         break;
       case uc_HKTW_STUDENT:
       { 
         $form['personal']['idnumber'] = array('#type' => 'textfield',
           '#title' => t('Your ID Card Number'),
           '#default_value' => $default_values->idcard_number,
           '#maxlength' => 18,
           '#required' => TRUE);
         $form['personal']['truename'] = array('#type' => 'textfield',
           '#title' => t('Your Name'),
           '#default_value' => $default_values->name,
           '#maxlength' => 50,
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['dateofbirth'] = array('#type' => 'date',
           '#title' => t('Your date of birth'),
           '#default_value' => array(
             'year' => substr($default_values->date_of_birth,0,4),
             'month' => 1*substr($default_values->date_of_birth,4,2),
             'day' => 1*substr($default_values->date_of_birth,6,2)
             ),
           '#after_build' => array('__set_year_range'),
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['gender'] = array('#type' => 'radios',
           '#title' => t('Your Gender'),
           '#default_value' => $default_values->gender,
           '#options' => array('1'=>t('Male'), '2'=>t('Female')),
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['province'] = array('#type' => 'select',
           '#title' => t('Place you live'),
           '#default_value' => $default_values->province,
           '#options' => array(),
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         //$dbo = db_query('SELECT * from {vl_province} p where p.ucategory=%s',$user->ucategory);
         $dbo = db_select('vl_province', 'p')->fields('p')->condition('p.ucategory',$user->ucategory)->execute();
         foreach ($dbo as $result)
         {
           $r = array($result->pid => $result->name);
           $form['personal']['province']['#options'] += $r;
         }
         $form['personal']['nationality'] = array('#type' => 'select',
           '#title' => t('Your nationality'),
           '#default_value' => $default_values->nationality,
           '#options' => array(),
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $dbo = db_select('vl_nationality','n')->fields('n')->execute();
         foreach ($dbo as $result)
         {
           $r = array($result->nid => $result->name);
           if ($result->nid != 98)
             $form['personal']['nationality']['#options'] += $r;
         }
       }
         break;
       case uc_OVERSEA_STUDENT:
       {
         $form['personal']['country'] = array('#type' => 'select',
           '#title' => t('The country you resists'),
           '#default_value' => $default_values->city_district,
           '#options' => array(),
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $dbo = db_select('vl_city_district','c')->fields('c')->condition('c.pid','800000')->execute();
         foreach ($dbo as $result)
         {
           $r = array($result->cid => $result->name);
           $form['personal']['country']['#options'] = $form['personal']['country']['#options'] + $r;
         }
         $form['personal']['idnumber'] = array('#type' => 'textfield',
           '#title' => t('Your Passport Number'),
           '#default_value' => $default_values->idcard_number,
           '#maxlength' => 18,
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['truename'] = array('#type' => 'textfield',
           '#title' => t('Your Chinese Name'),
           '#default_value' => $default_values->name,
           '#maxlength' => 50,
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['origname'] = array('#type' => 'textfield',
           '#title' => t('Your Name on your passport'),
           '#default_value' => $default_values->foreign_name,
           '#maxlength' => 50,
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['dateofbirth'] = array('#type' => 'date',
           '#title' => t('Your date of birth'),
           '#default_value' => array(
             'year' => substr($default_values->date_of_birth,0,4),
             'month' => 1*substr($default_values->date_of_birth,4,2),
             'day' => 1*substr($default_values->date_of_birth,6,2)
             ),
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['gender'] = array('#type' => 'radios',
           '#title' => t('Your Gender'),
           '#default_value' => $default_values->gender,
           '#options' => array('1'=>t('Male'), '2'=>t('Female')),
           '#required' => !$isvalidated,
           '#disabled' => $isvalidated,
         );
         $form['personal']['nationality'] = array('#type' => 'hidden',
           '#value' => '98');
         $form['personal']['province'] = array('#type' => 'hidden',
           '#value' => '800000');
		}
         break;
     }
     $form['#validate'][]='signup_user_account_form_validate';
     $form['#submit'][]='signup_user_account_form_save';
	 return $form;
}

function __set_year_range($form_element, $form_values) {
    $form_element['year']['#options'] = drupal_map_assoc(range(1950, format_date(time(), 'custom', 'Y')-10));
    return $form_element;
}

function signup_user_account_form_validate($form, $form_state) {
	$user=$form_state['user'];
	$edit=$form_state['values'];
	
	$isvalidated=db_select('students','s')->fields('s',array('validated'))->condition('s.uid',$user->name)->execute()->fetchField();
	if($isvalidated) return;
	
	switch($user->ucategory) {
		case uc_OWN_STUDENT:
			if ($edit['idnumber']) {
				$r=db_select('students','s')->fields('s')->condition('s.idcard_number',$edit['idnumber'])->condition('s.uid', $user->name, '<>')->countQuery()->execute()->fetchField();
			  	if ($r) {
			    	form_set_error('idnumber', t('The student ID has already been registerd.').' '.
			  			t('If you\'ve lost your password, please <a href="@url">click here to reset it</a>.', array('@url'=>'/user/logout?destination=user/password')));
			  		break;
			  	}
			}
			db_set_active('xjinfo');
			$r=db_select('XS_XJB','xj')->fields('xj')->condition('XH',strtoupper($edit['idnumber']))->condition('XM',trim($edit['truename']))->condition('sfyxj','是')->countQuery()->execute()->fetchField();
			db_set_active('default');
	  	  	if (isset($edit['idnumber']) && $r != 1)
	  	  	    form_set_error('idnumber', t('The Student ID you\'ve entered is not valid.'));
			break;
		case uc_MAINLAND_STUDENT:
			if ($edit['idnumber']) {
				$r=db_select('students','s')->fields('s')->condition('s.idcard_number',$edit['idnumber'])->condition('s.uid', $user->name, '<>')->countQuery()->execute()->fetchField();
				if ($r) {
					form_set_error('idnumber', t('The ID Card number has already been registerd.').' '.
						t('If you\'ve lost your password, please <a href="@url">click here to reset it</a>.', array('@url'=>'/user/logout?destination=user/password')));
					break;
				}
  	    	}
			if (!preg_match('/字第[0-9]+号/', $edit['idnumber']) && !is_idcardn_validate($edit['idnumber']))
				form_set_error('idnumber', t('The ID Card number you\'ve entered is not valid.'));
			
			break;
		case uc_HKTW_STUDENT:
			if ($edit['idnumber']) {
				$r=db_select('students','s')->fields('s')->condition('s.idcard_number',$edit['idnumber'])->condition('s.uid', $user->name, '<>')->countQuery()->execute()->fetchField();
				if ($r) {
					form_set_error('idnumber', t('The ID Card number has already been registerd.').' '.
						t('If you\'ve lost your password, please <a href="@url">click here to reset it</a>.', array('@url'=>'/user/logout?destination=user/password')));
					break;
				}
			}
			switch($edit['province']) {
				case '720000':
					if (!is_hk_idcardn_validate($edit['idnumber']))
						form_set_error('idnumber', t('The ID Card number you\'ve entered is not valid.'));
					break;
				case '710000':
					if (!is_tw_idcardn_validate($edit['idnumber'])) {
						form_set_error('idnumber', t('The ID Card number you\'ve entered is not valid.'));
					break;
					}
					$gender_calculated = substr($edit['idnumber'],1,1);
					if ($gender_calculated != '1' && $gender_calculated != '2') {
						form_set_error('idnumber', t('The ID Card number you\'ve entered is not valid.'));
						break;
					}
					if ($gender_calculated != $edit['gender']) {
						form_set_error('idnumber', t('The ID Card number you\'ve entered does not meet your gender.'));
						form_set_error('gender', t('The ID Card number you\'ve entered does not meet your gender.'));
					}
					break;
			}
			break;
		case uc_OVERSEA_STUDENT:
			if ($edit['idnumber']) {
				$r=db_select('students','s')->fields('s')->condition('s.idcard_number',$edit['idnumber'])->condition('s.uid', $user->name, '<>')->countQuery()->execute()->fetchField();
				if ($r) {
  	  				form_set_error('idnumber', t('The ID Card number has already been registerd.').' '.
						t('If you\'ve lost your password, please <a href="@url">click here to reset it</a>.', array('@url'=>'/user/logout?destination=user/password')));
					break;
				}
			}
			break;
	}
}

function signup_user_account_form_save($form, &$form_state) {
	$user=$form_state['user'];
	$edit=$form_state['values'];

	$isvalidated=db_select('students','s')->fields('s',array('validated'))->condition('s.uid',$user->name)->execute()->fetchField();
	if($isvalidated) return;

	if(isset($edit['dateofbirth'])) $edit['dobtosave']=sprintf("%04d%02d%02d",$edit['dateofbirth']['year'], $edit['dateofbirth']['month'], $edit['dateofbirth']['day']);
	
	switch($user->ucategory) {
		case uc_OWN_STUDENT:
			db_set_active('xjinfo');
			$r=db_select('XS_XJB','xj')->fields('xj')->condition('XH',strtoupper($edit['idnumber']))->condition('XM',trim($edit['truename']))->execute()->fetchObject();
			db_set_active('default');
			db_update('students')
				->condition('uid',$user->name)
				->fields(array(
					'idcard_number' => strtoupper($edit['idnumber']),
					'name' => trim($edit['truename']),
					'gender' => ($r->xb=='男')?'1':'2',
				))->execute();
			break;
		case uc_MAINLAND_STUDENT:
  	    	if (preg_match('/字第[0-9]+号/', $edit['idnumber']) && !isset($edit['gender'])) {
  	    		$form_state['rebuild']=true;
  	    		$form_state['rebuild_info']['need_show_genders']=1;
  	    		drupal_get_messages('status');
  	    		drupal_set_message(t('It seems that you are registering as a military officer, please fill extra info here.'), 'warning');
  	    		return;
  	    	}
  	    	if(!preg_match('/字第[0-9]+号/', $edit['idnumber'])) {
  	    		$edit['gender']=pim_genderfromidnumber($edit['idnumber']);
  	    		$edit['dobtosave']=pim_dobfromidnumber($edit['idnumber']);
  	    	}
			db_update('students')
				->condition('uid',$user->name)
				->fields(array(
					'idcard_number' => strtoupper($edit['idnumber']),
					'name' => trim($edit['truename']),
					'gender' => $edit['gender'],
					'date_of_birth' => $edit['dobtosave'],
					'nationality' => $edit['nationality'],
					'politics_feature' => $edit['political'],
				))->execute();
			// Fetch original province
			$orig_province=db_select('students_gk','sg')
				->condition('sg.uid',$user->name)
				->fields('sg',array('province'))
				->execute()->fetchField();
			// Fetch profession
			$orig_prof=db_select('students','s')
				->condition('uid',$user->name)
				->fields('s',array('profession_major'))
				->execute()->fetchField();
			// Check if the combile of profession and province affects examplaces
			$query=db_select('vl_profession_place','p')
				->condition('p.pid',$orig_prof)
				->condition('p.status','1');
			$query->innerJoin('vl_city_district','cd','p.examplace=cd.cid');
			$citera=db_or()->condition('cd.pid',$orig_province)->condition('cd.pid',$edit['province']);
			$query=$query->condition($citera)->fields('p')->countQuery();
			$test=$query->execute()->fetchField();
			// which means examplace will be affected
			if($test > 0) {
				db_update('students')
					->condition('uid',$user->name)
					->fields(array(
						'examplace' => '',
					))->execute();
				drupal_set_message(t('Your changes on your personal information affected your exam place selection. Please review it.'), 'warning');
			}
			db_update('students_gk')
				->condition('uid',$user->name)
				->fields(array(
					'province' => $edit['province'],
				))->execute();
			$city=db_select('students_gk', 'sg')->fields('sg',array('city_district'))->condition('uid', $user->name)->execute()->fetchField();
			if(substr($city,0,2)!==substr($edit['province'],0,2))
				db_update('students_gk')
					->condition('uid',$user->name)
					->fields(array(
						'city_district' => $edit['province'],
					))->execute();
			break;
		case uc_HKTW_STUDENT:
			db_update('students')
				->condition('uid',$user->name)
				->fields(array(
					'idcard_number' => strtoupper($edit['idnumber']),
					'name' => trim($edit['truename']),
					'nationality' => $edit['nationality'],
					'gender' => $edit['gender'],
					'date_of_birth' => $edit['dobtosave'],
				))->execute();
			db_update('students_gk')
				->condition('uid',$user->name)
				->fields(array(
					'province' => $edit['province'],
					'city_district' => $edit['province'],
				))->execute();
			break;
		case uc_OVERSEA_STUDENT:
			db_update('students')
				->condition('uid',$user->name)
				->fields(array(
					'idcard_number' => strtoupper($edit['idnumber']),
					'name' => trim($edit['truename']),
					'foreign_name' => trim($edit['origname']),
					'nationality' => '',
					'gender' => $edit['gender'],
					'date_of_birth' => $edit['dobtosave'],
				))->execute();
			db_update('students_gk')
				->condition('uid',$user->name)
				->fields(array(
					'province' => '800000',
					'city_district' => $edit['country'],
				))->execute();
			break;
	}
	
	$data=array();
	$data['roles']=array( '5' => 'students');
	$data['pass']=$edit['pass'];
	user_save($user, $data);
	signup_user_goto($user);
}

function signup_form_user_pass_alter(&$form, &$form_state) {
	if(user_access('administer users')) return;
	if($GLOBALS['user']->uid>=2) {
		unset($form['name']);
		unset($form['mail']);
		unset($form['actions']);
		$form['mail']=array(
			'#type'=>'item',
			'#markup'=>t('You must be logged out before resetting password.'),
		);
		$form['logout']=array(
			'#type'=>'item',
			'#markup'=>l(t('Logout and request new password'), 'user/logout', array('query' => array('destination' => 'user/password'))),
		);
		unset($form['captcha']);
		
		return;
	}
	
	unset($form['name']);
	unset($form['mail']);
	$form["actions"]['submit']['#value']=t('Reset password');
	$form["actions"]['submit']['#weight']=10;
	
	$form['notice'] = array(
		'#type' => 'markup',
		'#markup' => t('You\'ll have to provide following information when reseting password. ID Card Number is required here.'),
		'#weight'=>'0',
	);
	$form['idnumber'] = array(
		'#title' => t('Your ID Card Number'),
		'#type' => 'textfield',
		'#size' => '60',
		'#maxlength' => 18,
		'#weight' => 1,
		'#required' => TRUE,
	);
	$form['condselect'] = array(
		'#type' => 'radios',
		'#options' => array( '1' => t('I know the ID Number'), '2' => t('I\'ve forgotten the ID Number')),
		'#default_value' => '1',
		'#weight' => 2,
	);
	$form['sid'] = array(
		'#title' => t('Your ID Number'),
		'#type' => 'textfield',
		'#size' => '60',
		'#weight' => 3,
		'#attributes'=>array('placeholder'=>variable_get('zhaoban_current_year',date('Y')).'BXXXX'),
		'#states' => array(
			'visible' => array(
				'input[name="condselect"]' => array('value' =>'1'),
			),
			'required' => array(
				'input[name="condselect"]' => array('value' =>'1'),
			)
		),
	);
	drupal_add_js(
		'jQuery(document).ready(function(){'.
			'deal_input_palceholder();});',
		'inline'
	);
	$form['name'] = array(
		'#type' => 'textfield',
		'#title' => t('Your Name'),
		'#size' => '60',
		'#weight' => 3,
		'#states' => array(
			'visible' => array(
				'input[name="condselect"]' => array('value' =>'2'),
			),
			'required' => array(
				'input[name="condselect"]' => array('value' =>'2'),
			)
		),
	);
	$form['#validate']=array('signup_form_user_pass_validate');
	$form['#submit']=array('signup_form_user_pass_submit');
}

function signup_form_user_pass_validate($form, &$form_state) {
	
	if($form_state['values']['condselect']==1) {
		if(trim($form_state['values']['sid']) == '') {
			form_set_error('sid', t('!name field is required.', array('!name'=>$form['sid']['#title'])));
			return;
		}
	} else {
		if(trim($form_state['values']['name']) == '') {
			form_set_error('name', t('!name field is required.', array('!name'=>$form['name']['#title'])));
			return;
		}
	}
	
	if($form_state['values']['condselect']==1) {
		// We will detect users based on ones ExamID and his IDCard number.
		$query = db_select('users', 'u');
		$query->innerjoin('students', 's', 'u.name=s.uid');
		$query = $query
			->fields('u',array('uid'))
			->condition('s.uid', $form_state['values']['sid'])
			->condition('s.idcard_number', $form_state['values']['idnumber']);
		$result=$query->execute()->fetchField();
		if(!$result) {
			form_set_error('sid', t('Sorry, the ExamID and the IDCard number do not meet our records.'));
			return;
		}
	} else {
		// We will detect users based on one's IDCard number and his realname.
		$query = db_select('users', 'u');
		$query->innerjoin('students', 's', 'u.name=s.uid');
		$query = $query
			->fields('u',array('uid'))
			->condition('s.idcard_number', $form_state['values']['idnumber'])
			->condition('s.name', $form_state['values']['name']);
		$result=$query->execute()->fetchField();
		if(!$result) {
		      form_set_error('name', t('Sorry, the Name and the IDCard number do not meet our records.'));
		      return;
		}
	}
	
	// Let's load the user object.
	$account = user_load($result);
	if($account->status==0)
		form_set_error('idnumber', t('The system cannot fulfill your request at the moment. Please contact the system administrator.'));
}

function signup_form_user_pass_submit($form, &$form_state) {
//	var_dump($form_state);

	// We will detect users based on one's IDCard number and his realname.
	$query = db_select('users', 'u');
	$query->innerjoin('students', 's', 'u.name=s.uid');
	$query = $query
		->fields('u',array('uid'))
		->condition('s.idcard_number', $form_state['values']['idnumber']);
	$uid=$query->execute()->fetchField();
	$account = user_load($query->execute()->fetchField());
	$newpass = user_password(6);
	//var_dump($account);var_dump($newpass);
	

	user_save($account, array('pass'=>$newpass));
	
	db_delete('flood')
		->condition('identifier',$uid.'-%','LIKE')
		->execute();
	//exit;
  
	drupal_set_message(t('Based on your request, we\'ve reset <span class="error">!name</span>\'s password. Your new password is <span class="error"><code>!pass</code></span>. '.
    	'Please write it down and keep it in a safe place. Or, you can change it right now.', array('!name' => $account->name, '!pass' => $newpass)));

	// We need to fill up more information after login
	$data['uid']=user_authenticate($account->name, $newpass);
	user_login_submit(array(),$data);

	$form_state['redirect']='user/'.$account->uid.'/edit';
}

function signup_user_categories() {
  return array(
    array(
      'name' => signup_user_PROFESSION,
      'title' => t('Sign up Professions'),
      'weight' => 10,
    ),
    array(
      'name' => signup_user_EXAM,
      'title' => t('Examinations'),
      'weight' => 11,
    ),
    array(
      'name' => signup_user_CONTACT,
      'title' => t('Contact Detail'),
      'weight' => 12,
    ),
    array(
      'name' => signup_user_GAOKAO,
      'title' => t('Gaokao'),
      'weight' => 13,
    ),
  );	
  return $data;
}

function signup_menu_alter(&$callbacks) {
  $callbacks['user/%user_category/edit/'.signup_user_PROFESSION]['access callback'] = '_signup_user_tab_access';
  $callbacks['user/%user_category/edit/'.signup_user_PROFESSION]['access arguments'] = array(1, signup_user_PROFESSION);

  $callbacks['user/%user_category/edit/'.signup_user_EXAM]['access callback'] = '_signup_user_tab_access';
  $callbacks['user/%user_category/edit/'.signup_user_EXAM]['access arguments'] = array(1, signup_user_EXAM);

  $callbacks['user/%user_category/edit/'.signup_user_CONTACT]['access callback'] = '_signup_user_tab_access';
  $callbacks['user/%user_category/edit/'.signup_user_CONTACT]['access arguments'] = array(1, signup_user_CONTACT);

  $callbacks['user/%user_category/edit/'.signup_user_GAOKAO]['access callback'] = '_signup_user_tab_access';
  $callbacks['user/%user_category/edit/'.signup_user_GAOKAO]['access arguments'] = array(1, signup_user_GAOKAO);
}

function _signup_user_tab_access($user=NULL, $sec=NULL) {
	//$user=$GLOBALS['user'];
	$is_student = array_key_exists('5',$user->roles);
	if($GLOBALS['user']->uid == 1) return FALSE;
	if(is_null($user)) return FALSE;
	if(!$is_student = array_key_exists('5',$user->roles)) return FALSE;
	switch($sec) {
		case 'profession':
			$result = db_select('students','s')
				->fields('s',array('idcard_number', 'name'))
				->condition('s.uid',$user->name)
				->execute()->fetchObject();
       		if(!($result->idcard_number) || !($result->name)) return FALSE;
        		else return TRUE;
        case 'exam':
        	$result = db_select('students','s')
        		->fields('s',array('profession_major','examplace'))
        		->condition('s.uid',$user->name)
        		->execute()->fetchObject();
			if($result->profession_major == '0' || $result->examplace == '') return FALSE;
			else return TRUE;
		case 'contact':
			$query=db_select('students_going','sg');
			$query->addExpression('MAX(sg.opus)');
			$result = $query
				->condition('sg.uid',$user->name)
				->execute()->fetchField();
			if(!$result) return FALSE;
			else return TRUE;
		case 'gaokao':
			$ucategory=db_select('students','s')
				->fields('s',array('ucategory'))
				->condition('s.uid',$user->name)
				->execute()->fetchField();
			if(($ucategory == 0 ) || ($ucategory == 3)) return FALSE;
			$result=db_select('students_contact','sc')
				->fields('sc',array('contact_phone'))
				->condition('sc.uid',$user->name)
				->execute()->fetchField();
        	if(!$result) return FALSE;
        	else if(_signup_user_tab_access($user, 'contact')) return TRUE;
        	else return FALSE;
		default: return FALSE;
	}
	return TRUE;
}

function signup_user_view($user, $view_mode, $langcode) {

  if(!array_key_exists('5', $user->roles)) return;

	// Personal information section
	$result = db_select('students','s')->fields('s')->condition('s.uid', $user->name)->execute()->fetchObject();
	$user->content['pi'] = array(
		'#type' => 'user_profile_category',
		'#title' => t('Personal information'),
		'#weight' => '8',
	);
	$user->content['pi']['name'] = array(
		'#type' => 'user_profile_item',
		'#title' => (sign_up_picture_perm($user)?'<img src="/user/'.$user->uid.'/picture.jpg" style="padding-right: 10px" align="left" height="100"/>':'').t('Real Name'),
		'#markup' => isset($result->name)?$result->name:'',
		'#weight' => 1,
	);
	$user->content['pi']['gender'] = array(
		'#type' => 'user_profile_item',
		'#title' => t('Gender'),
		'#markup' => $result->gender ==1 ? t('Male'): t('Female'),
		'#weight' => 2,
	);
	
	// Contact
	$r = db_select('students_contact','sc')->fields('sc')->condition('sc.uid',$user->name)->execute()->fetchObject();
	if($r) {
		$item = array('title' => t('Phone number during examination'), 'value'=> isset($r->contact_phone)?$r->contact_phone:'');
		$user->content['contact']=array(
			'#type'=>'user_profile_category',
			'#title'=>t('Contacts'),
			'#weight'=>9,
		);
		$user->content['contact']['contact_phone'] = array(
			'#type' => 'user_profile_item',
			'#title' => t('Phone number during examination'),
			'#markup' => isset($r->contact_phone)?$r->contact_phone:'',
			'#weight' => '-10',
		);
		$user->content['contact']['phone_roundg'] = array(
			'#type' => 'user_profile_item',
			'#title' => t('Phone nubmer off examination'),
			'#markup' => isset($r->phone_roundg)?$r->phone_roundg:'',
			'#weight' => '0',
		);
		$user->content['contact']['address_round3'] = array(
			'#type' => 'user_profile_item',
			'#title' => t('Address of Round 3'),
			'#markup' => (isset($r->address_round3)?$r->address_round3:'').' / '.(isset($r->zip_round3)?$r->zip_round3:'').' / '.t('To !rec',array('!rec'=>isset($r->recipient_round3)?$r->recipient_round3:'')),
			'#weight' => '1',
		);
		$user->content['contact']['address_roundg'] = array(
			'#type' => 'user_profile_item',
			'#title' => t('Address of Round Goakao'),
			'#markup' => (isset($r->address_roundg)?$r->address_roundg:'').' / '.(isset($r->zip_roundg)?$r->zip_roundg:'').' / '.t('To !rec',array('!rec'=>isset($r->recipient_roundg)?$r->recipient_roundg:'')),
			'#weight' => '2',
		);

    }
	// Professions
	$query = db_select('vl_professions', 'p');
	$query->innerJoin('vl_department', 'd', 'p.did = d.did');
	$query = $query->fields('d',array('dname'))->fields('p',array('pname'))->condition('p.pid', $result->profession_major);
	$rdbo = $query->execute()->fetchObject();

	if($rdbo)
		$r = t('Department !dname Profession !pname', array('!dname'=>$rdbo->dname, '!pname'=>$rdbo->pname));

	$user->content['pr'] = array(
		'#type' => 'user_profile_category',
		'#title' => t('Profession and Examinations'),
		'#weight' => 10,
	);
	$query = db_select('students','s')->condition('s.uid',$user->name);
	$query->innerJoin('vl_city_district','cd','s.examplace=cd.cid');
	$query = $query->fields('cd',array('name_simp'));
	$examplace = $query->execute()->fetchField();
	if($r)
		if($examplace <> '')
			$proftext = $r.' / '.$examplace;
		else
			$proftext = $r;
	else
		$proftext = t('N/A');
	$user->content['pr']['name'] = array(
		'#type' => 'user_profile_item',
		'#title' => t('Profession'),
		'#markup' => $proftext,
		'#weight' => '-10',
	);
	

  // Examinations
  $ex_section = t('Examinations');
  $query = db_select('students_going','sg');
  $query->innerJoin('vl_exam','e', 'sg.eid=e.eid');
  $query = $query->fields('e',array('eid','ename','elevel'))->fields('sg',array('opus'))->condition('sg.uid',$user->name)->orderBy('sg.eid');
  $rdbo = $query->execute();
  foreach ($rdbo as $r) {
          $item = array('title' => $r->ename.$r->elevel, 'class'=>'exam', 'value' => '');
          if($r->opus) {
                $org_opus = unserialize($r->opus);
                if(isset($org_opus['eadditional']) ) {
                	if($org_opus['eadditional'] <> '')
                		$item['value'] .= t($org_opus['eadditional']).": ";
                	unset($org_opus['eadditional']);
                }
                $item['value'] .= implode($org_opus, ' / ');
          }
	$user->content['pr'][] = array(
		'#type' => 'user_profile_item',
		'#title' => $r->ename.$r->elevel,
		'#markup' => isset($item['value'])?$item['value']:'',
		'#weight' => $r->eid,
	);
  }

}

function signup_user_professions_form($form, $form_state) {
	if(!isset($form_state['rebuild_info']['need_rebuild']))
		$form_state['rebuild_info']['need_rebuild']=0;
	
	$user=$form['#user'];

	$user->isvalidated=db_select('students','s')->fields('s',array('validated'))->condition('s.uid',$user->name)->execute()->fetchField();

	$default_values=array();

	if($default_profession=db_select('students','s')->fields('s',array('profession_major'))->condition('s.uid',$user->name)->execute()->fetchField()) {
		$default_values['did_1'] = substr($default_profession,0,2);
		$default_values['pid_1'] = $default_profession;
	}
	else {
		// We 'll calculate the most hot professions.
		$default_values['pid_1'] = db_query(
			'SELECT s.profession_major FROM {students} s WHERE NOT s.profession_major = \'0\' '.
			'GROUP BY s.profession_major ORDER BY count(*) DESC LIMIT 0 , 1')->fetchField();
		$default_values['did_1'] = substr($default_values['pid_1'],0,2);
	}
	

	// Check if the student is marked as passthrough.
	$query=db_select('students','s')->condition('s.uid',$user->name);
	$query->innerJoin('students_passthrough','sp','s.idcard_number=sp.idcard_number');
	$query=$query->fields('sp');
	$r=$query->execute()->fetchObject();
	if($r)
		$passthroughcondition="p.pid='".$r->pid."'";
	else
		$passthroughcondition='1';

	$query=db_select('vl_department','d')->fields('d')->orderBy('d.did')->condition('p.enabled',1)->where($passthroughcondition);
	$query->innerJoin('vl_professions','p','p.did=d.did');
	$dbo = $query->execute();
	$departments = array();
	foreach($dbo as $r) {
		$departments += array(($r->did) => ($r->dname));
	}
	
	
	// Construct the professions list
	$dbo = db_select('vl_professions','p')->fields('p')->condition('p.enabled',1)->where($passthroughcondition)->orderBy('p.pid')->execute();
	$professions = array();
	$professions_plain = '';
	foreach($dbo as $r) {
		$c=1;
		if($r->extracondition) {
			$query=db_select('students','s')->fields('s')->condition('s.uid',$user->name);
			$query->innerjoin('students_gk','sg','s.uid=sg.uid');
			$query=$query->where($r->extracondition)->fields('s')->countQuery();
			$c=$query->execute()->fetchField();
		}
		if($c) {
			$professions += array(($r->pid) => $r->pname);
			$professions_plain .= $r->pid.$r->pname.',';
		}
	}
	
	$form['professionlist'] = array(
		'#type'=>'hidden',
		'#value'=> $professions_plain,
		'#weight'=>1,
	);

	$form['pframe'] = array(
		'#type' => 'fieldset',
		'#title' => t('The wanted profession'),
		'#collapsible' => TRUE,
		'#weight'=>2,
	);
	if($default_profession) {
		$form['pframe']['#title'] = t('Change my profession'); 
		$form['pframe']['#collapsible']=TRUE;
		$form['pframe']['#collapsed']=FALSE;
	}
	// Let's build the department select and profession select
	$form['pframe']['did'] = array(
		'#type' => 'select',
		'#title' => t('The department you like'),
		'#required' => TRUE,
		'#options' => $departments,
		'#multiple' => FALSE,
		'#attributes' => array('onChange'=>"profs=form.professionlist.value.split(','); form.pid.length=0; ".
			"for(i=0,p=0;i<profs.length;i++) { if (profs[i].substring(0,2) == this.options[this.selectedIndex].value) form.pid.options[p++] = new Option(profs[i].substring(4), profs[i].substring(0,4));}".
			"jQuery('#edit-pid').change();"./*
			"if(jQuery('#edit-did').val() == 'D4') ".
				"jQuery('#edit-descnote').show(); ".
			"else ".
				"jQuery('#edit-descnote').hide(); ".*/
			'return true;'),
		'#default_value' => isset($form_state['values']['did']) ? $form_state['values']['did'] : $default_values['did_1'],
		'#disabled' => ($user->isvalidated) || $form_state['rebuild_info']['need_rebuild'],
		'#weight' => 1,
	);
	$dep = isset($form_state['values']['did'])?$form_state['values']['did']:$default_values['did_1'];
	$form['pframe']['pid'] = array(
		'#type' => 'select',
		'#title' => t('The profession you like'),
		'#required' => TRUE,
		'#multiple' => FALSE,
		'#prefix' => '<div id="dropdown_pid_replace">',
		'#suffix' => '</div>',
		'#options' => $professions,
		'#default_value' => isset($form_state['values']['pid']) ? $form_state['values']['pid'] : $default_values['pid_1'],
		/*
		'#attributes' => array('onChange'=>"".
			"if(jQuery('#edit-pid').val() == 'D716' || jQuery('#edit-pid').val() == 'D717' || jQuery('#edit-pid').val() == 'D603' || jQuery('#edit-pid').val() == 'D604') ".
				"jQuery('.form-item-secondary-profession').show(); ".
			"else ".
				"jQuery('.form-item-secondary-profession').hide(); ".
			""),*/
		'#disabled' => ($user->isvalidated) || $form_state['rebuild_info']['need_rebuild'],
		'#weight' => 2,
	);
	
	//$pid=isset($form_state['values']['pid'])?$form_state['values']['pid']:$default_values['pid_1'];
	//var_dump($places);
	unset($form['actions']['submit']);
	$form['save'] = array(
		'#type' => 'submit',
		'#value' => t('Save'),
		'#weight' => 5,
	);
	if(isset($form_state['rebuild_info']['need_rebuild'])&&$form_state['rebuild_info']['need_rebuild']==1) {
		$form['pframe']['#collapsed']=TRUE;
		$form['pframe']['#title']=t('My profession');
		$form['extrainfo'] = array(
			'#type' => 'fieldset',
			'#title' => t('Extra Info'),
			'#weight'=> 3,
		);
		$places=_signup_user_professions_examplace_alter($form_state['values']['pid'], $user->name);
		//var_dump(array_values($places));
		if(count($places) ==1) {
			$cityids=array_keys($places);
			$citynames=array_values($places);
			$form['extrainfo']['examplacedesc'] = array(
				'#type' => 'item',
				'#title' => t('Exam Place'),
				'#markup' => $citynames[0],
				'#description' => t('You can only participate exam at here.'),
			);
			$form['extrainfo']['examplace'] = array(
				'#type' => 'hidden',
				'#value' => $cityids[0],
			);
		} else {
			$default_values['examplace']=db_select('students','s')
				->condition('s.uid',$user->name)
				->fields('s',array('examplace'))
				->execute()->fetchField();
			$form['extrainfo']['examplace'] = array(
				'#type' => 'select',
				'#title' => t('Exam Place'),
				'#description' => '<span id="infodesc">'.t('Please note that you could select various examing place here.').'</span>',
				'#options' => $places,
				'#default_value' => isset($form_state['values']['examplace']) ? $form_state['values']['examplace'] : $default_values['examplace'],
				'#attributes' => array('onChange' => ''.
					'jQuery("#infodesc").html(jQuery("#placedesc"+jQuery("#edit-examplace").val()).val());'.
				''),
				'#weight'=> 3,
			);
			foreach($places as $cid => $cname) {
				$query=db_select('vl_profession_place','pp')
					->fields('pp')
					->condition('pp.examplace',$cid)
					->condition('pp.pid',$form_state['values']['pid']);
				if($query->countQuery()->execute()->fetchField()>0) {
					$r=$query->execute()->fetchObject();
					$form['extrainfo']['placedesc'.$cid] = array(
						'#attributes' => array('id' => 'placedesc'.$cid),
						'#type' => 'hidden',
						'#value' => ($r->memo)?($r->memo):'',
					);
				} else {
					$form['extrainfo']['placedesc'.$cid] = array(
						'#attributes' => array('id' => 'placedesc'.$cid),
						'#type' => 'hidden',
						'#value' => '',
					);
				}
			}
		}
		$prof=$form_state['values']['pid'];
		if($prof == 'D716' || $prof == 'D717' || $prof == 'D603' || $prof == 'D604')
			$form['extrainfo']['secondary_profession'] = array(
				'#type' => 'radios',
				'#title' => t('Secondary profession'),
				'#description' => t('Please note that if you select to signup a secondary profession, you will need to take part in all the exams. We may enroll you under the secondary profession.'),
				'#options' => array(
					'1' => t('I DO NOT want to signup a secondary profession listed in registration guide'),
					'2' => t('I DO  want to signup a secondary profession listed in registration guide'),
				),
				'#default_value' => NULL,
				'#weight' => 5,
			);
	} else {
		$form['save']['#submit'] = array('_signup_user_professions_fake_save');
	}
	//var_dump($form);
	
	drupal_add_js(
		'jQuery(document).ready(function(){'.
			's=jQuery("#edit-pid").val();'.
			'jQuery("#edit-did").change();'.
			'jQuery("#edit-pid").val(s);'.
			'jQuery("#edit-pid").change();'.
			"if(jQuery('#edit-did').val() == 'D4') ".
				"jQuery('#edit-descnote').show(); ".
			"else ".
				"jQuery('#edit-descnote').hide(); ".
			'});'.
			'',
		'inline'
	);
	
	$form['#validate'][]='signup_user_professions_form_validate';
	$form['#submit'][]='signup_user_professions_form_save';
	
    return $form;
}

function _signup_professions_department_onchange(&$form, $form_state) {
	$user=$form['#user'];
	$query=db_select('students','s')->condition('s.uid',$user->name);
	$query->innerJoin('vl_professions', 'p', 's.profession_major=p.pid');
	$query=$query->fields('p',array('did','pid'));
	$r=$query->execute()->fetchObject();
	if (!is_null($form_state['values']['pid']) && $r && $form_state['values']['did'] == $r->did)
		$form['pframe']['pid']['#default_value']=$r->pid;
	else
		$form['pframe']['pid']['#default_value']=NULL;
	//var_dump($form_state['values']['did']);
	return $form['pframe']['pid'];
}

function _signup_professions_profession_onchange($form, $form_state) {
	return $form['pframe']['examplace'];
}

function _signup_user_professions_profession_alter($dep='') {
	//var_dump($dep);
	$dbo = db_select('vl_professions','p')->fields('p')->condition('p.enabled',1)->orderBy('p.pid')->execute();
	$professions=array();
	foreach($dbo as $r) {
		//$professions[$r->did]=array();
		if(!isset($professions[$r->did])) $professions[$r->did]=array();
		$professions[$r->did] += array($r->pid => $r->pname);
	}
	return $professions[$dep];
}

function _signup_user_professions_examplace_alter($pid='', $uid=NULL) {
	$query=db_select('vl_profession_place','pp')->condition('pp.status','1')->condition('pp.pid',$pid);
	$query->innerJoin('vl_professions','p','p.pid=pp.pid');
	$query->innerJoin('vl_city_district','cd','cd.cid=pp.examplace');
	$query=$query->fields('cd',array('cid','name'))->groupBy('cd.cid')->distinct();
	$dbo=$query->execute();

	$r=db_select('vl_city_district','cd')->fields('cd',array('cid','name'))->condition('cd.cid','110000')->execute()->fetchObject();
	$options=array($r->cid=>$r->name);
	foreach($dbo as $r) {
		unset($options[$r->cid]);
		
		$query=db_select('students','s')->condition('s.uid',$uid)->fields('s');
		$query->leftJoin('students_gk','sg','s.uid=sg.uid');
		$condition=db_select('vl_profession_place','pp')->fields('pp',array('cond'))
			->condition('pp.pid',$pid)->condition('pp.examplace',$r->cid)
			->execute()->fetchField();
		$query=$query->where($condition?$condition:'1')->countQuery();
		$q=$query->execute()->fetchField();
		if($q)
			$options[$r->cid] = $r->name;
	}
	return $options;
}

function signup_user_professions_form_validate($form, $form_state) {
	
	$prof=$form_state['values']['pid'];
	// Check if the profession devote to the department
	if(substr($prof,0,2) != $form_state['values']['did'])
		form_set_error('pid', t('The major profession you\'ve selected does not comform the department.'));
	if(isset($form['extrainfo']['secondary_profession']))
		if($prof == 'D716' || $prof == 'D717' || $prof == 'D603' || $prof == 'D604')
			if(!$form_state['values']['secondary_profession'])
				form_set_error('secondary_profession', t('You must select if you want sign up a secondary profession.'));
	
}

function _signup_user_professions_fake_save($form, &$form_state) {
	$form_state['rebuild_info']['need_rebuild']=1;
	$form_state['rebuild']=TRUE;
}
function signup_user_professions_form_save($form, $form_state) {
	//$user=$form['#user'];
	$user=$form['#user'];
	$edit=$form_state['values'];
	//var_dump($form_state['values']['examplace']); exit;
	$profession_major=$edit['pid'];
	//var_dump(arg(1));exit;
	
	$r=db_select('students','s')->fields('s')->condition('s.uid',$user->name)->execute()->fetchObject();
	if($r->validated) return;
	
	$old_profession=$r->profession_major;
	// Only if user has change his profession
	
	db_update('students')
		->condition('uid',$user->name)
		->fields(array(
			'examplace' => $form_state['values']['examplace'],
		))->execute();
	
	if($old_profession!=$profession_major) {
		db_update('students')
			->condition('uid',$user->name)
			->fields(array(
				'profession_major' => $profession_major,
			))->execute();
		
	}
	
	// Now, let's compute the exam.
	
	$exams_major = unserialize(db_select('vl_professions','p')->fields('p',array('exams'))->condition('p.pid',$profession_major)->execute()->fetchField());
	
	$exams_student = array();
	// Seperate sofa to so and fa
	foreach($exams_major as $eid=>$eweight) {
		// Compute sofa to so and fa
		if(substr($eid,0,2)=='32') {
		  $exams_student[] = preg_replace('/32/','30',$eid);
		  $exams_student[] = preg_replace('/32/','31',$eid);
		}
		else $exams_student[] = $eid;
	}
	
	// FIXME: HACKAGE for secondary profesion
	if($profession_major == 'D716' || $profession_major == 'D717' || $profession_major == 'D603' || $profession_major == 'D604')
		if($form_state['values']['secondary_profession']=='2') {
			$query=db_select('vl_professions','p1');
			$query->innerJoin('vl_professions','p2','p1.pname=p2.pname');
			$query=$query->fields('p2',array('exams'))->condition('p1.pid',$profession_major)->condition('p2.pid',$profession_major,'<>');
			$exams_minor=unserialize($query->execute()->fetchField());
			foreach($exams_minor as $eid=>$eweight) {
				if(substr($eid,0,1)<>'3')
					$exams_student[] = $eid;
			}
			//$pname=db_select('vl_profession','p')->fields('p.pname')
		}
			
	// FIXME: HACKAGE END
	
	// $exams_student now stores the newly created exams.
	// Now, let's compare the exisiting exams one by one.
	$rdbo=db_select('students_going','sg')->fields('sg',array('eid'))->condition('sg.uid',$user->name)->orderBy('sg.eid')->execute();
	$exams_student_existing=array();
	foreach($rdbo as $r) {
		$exams_student_existing[]=$r->eid;
	}
	
	$l=count($exams_student);
	for($i=0;$i<$l;) {
		if(!isset($exams_student[$i])) {
			$i++;
			continue;
		}
		$eid=$exams_student[$i];
		// Case 1: The newly added exams are found in existing exams. Just keep it.
		if(in_array($eid, $exams_student_existing)) {
			unset($exams_student[$i]);
			unset($exams_student_existing[array_search($eid, $exams_student_existing)]);
		}
		// Case 2: The piano exams
		else if($eid !='250' &&(substr($eid,0,2) == '25' || substr($eid,0,2) == '26')) {
			if(in_array('251', $exams_student_existing) && ($eid=='251' || $eid=='261')) { // Piano A
				db_update('students_going')->fields(array('eid'=>$eid))->condition('uid',$user->name)->condition('eid', 251);
				unset($exams_student[$i]);
				unset($exams_student_existing[array_search('251', $exams_student_existing)]);
			} else
			if(in_array('252', $exams_student_existing) && ($eid=='252' || $eid=='262')) { // Piano B
				db_update('students_going')->fields(array('eid'=>$eid))->condition('uid',$user->name)->condition('eid', 252);
				unset($exams_student[$i]);
				unset($exams_student_existing[array_search('252', $exams_student_existing)]);
			} else
			if(in_array('261', $exams_student_existing) && ($eid=='251' || $eid=='261')) { // Instrument A
				db_update('students_going')->fields(array('eid'=>$eid))->condition('uid',$user->name)->condition('eid', 261);
				unset($exams_student[$i]);
				unset($exams_student_existing[array_search('261', $exams_student_existing)]);
			} else
			if(in_array('262', $exams_student_existing) && ($eid=='252' || $eid=='262')) { // Instrument B
				db_update('students_going')->fields(array('eid'=>$eid))->condition('uid',$user->name)->condition('eid', 262);
				unset($exams_student[$i]);
				unset($exams_student_existing[array_search('262', $exams_student_existing)]);
			} else {
				
			}
			$i++;
		}
		// Case 3: There is no use of keeping other exams.
		else {
			$i++;
		}
	}
	
	// We should delete all the exams for current students at first.
	if(count($exams_student_existing))
	  foreach($exams_student_existing as $ex) {
	  	db_delete('students_going')->condition('uid',$user->name)->condition('eid',$ex)->execute();
	  }
	
	// Then, insert the exams we calculated here.
	if(count($exams_student)) {
	  sort($exams_student);
	  foreach($exams_student as $ex) {
	  	db_insert('students_going')
	  		->fields(array(
	  			'uid' => $user->name,
	  			'eid' => $ex,
	  		))->execute();
	  }
	}
	signup_user_goto($user);
	return;
}

function signup_user_examinations_form($form, $form_state) {
    $user=$form['#user'];
	$r = _signup_determine_period($user);

	if($r==0)
	  drupal_goto('user/'.$user->uid.'/edit');
	else if($r==1)
	  drupal_goto('user/'.$user->uid.'/edit/profession');

	// Check if the student is marked as passthrough.
	$query=db_select('students','s')->condition('s.uid',$user->name);
	$query->innerJoin('students_passthrough','sp','s.idcard_number=sp.idcard_number');
	$query=$query->fields('sp');
	$r=$query->execute()->fetchObject();
	$ispassthrough=$r?TRUE:FALSE;

	$isvalidated=db_select('students','s')->fields('s',array('validated'))->condition('s.uid',$user->name)->execute()->fetchField();
	if(!$isvalidated)
		$isvalidated=$ispassthrough;
	// Let's fetch the examinations of the user at first
	$rdbo = db_select('students_going','sg')->fields('sg',array('eid'))->condition('sg.uid',$user->name)->execute();
	$exams = array();
	foreach($rdbo as $r)
		$exams[] = $r->eid * 1;
	
	$form['explain'] = array(
		'#value' => t('The examinations you should take, which are computed based on your professions. '.
			'Please fill required information below, such as the opus of individual examiniation.'),
		'#weight' => -10,
	);
	// Draw every exam as a seperated frameset
	sort($exams);
	$page_weight = 0;
	foreach($exams as $eid) {
		$r = db_select('vl_exam','e')->fields('e')->condition('e.eid',$eid)->execute()->fetchObject();
		$form[$eid] = array(
			'#type' => 'fieldset',
			'#title' => $r->ename . $r->elevel,
			'#collapsible' => !empty($r->opus) || !empty($r->eadditonal) || $isvalidated,
			'#collapsed' => $isvalidated,
			'#weight'=> $page_weight++,
		);
		$form[$eid]['etype'] = array(
			'#type' => 'markup',
			'#markup' => '<div><b>'.t('Testing mode') .':</b> '. ($r->etype==1? t('Writing') : t('Interviewing')).'</div>',
		);

		// Let's fetch the original value
		if($r->eadditional || $r->opus) {
			$q=db_select('students_going','sg')->fields('sg',array('opus'))->condition('uid',$user->name)->condition('eid',$eid)->execute()->fetchField();
			if($q) {
				$default_values=unserialize($q);
			}
			else $default_values=array();
		}
		if($r->eadditional) {
			$form[$eid]['eadditional'.$eid] = unserialize($r->eadditional);
			$form[$eid]['eadditional'.$eid]['#default_value']=isset($default_values['eadditional'])?$default_values['eadditional']:NULL;
			$form[$eid]['eadditional'.$eid]['#disabled']=$isvalidated;
			$form[$eid]['eadditional'.$eid]['#title'] = isset($form[$eid]['eadditional'.$eid]['#title'])?t($form[$eid]['eadditional'.$eid]['#title']):NULL;
			if(!isset($form[$eid]['eadditional'.$eid]['#type'])||$form[$eid]['eadditional'.$eid]['#type']=='markup')
				$form[$eid]['eadditional'.$eid]['#markup'] = t($form[$eid]['eadditional'.$eid]['#value']);
			if(isset($form[$eid]['eadditional'.$eid]['#type'])&&($form[$eid]['eadditional'.$eid]['#type'] == 'select' || $form[$eid]['eadditional'.$eid]['#type'] == 'radios')) {
				$form[$eid]['eadditional'.$eid]['#required'] = TRUE;
				foreach($form[$eid]['eadditional'.$eid]['#options'] as $v => $t) {
					$form[$eid]['eadditional'.$eid]['#options'][$v] = t($t);
				}
			}
		}
		for($i=1;$i<=$r->opus;$i++) {
			$form[$eid]['#description'] = t(
				'<p>For details on the range of opus you could select for this examination, please check '.
				'our registration guide.<br/>'.
				'The suggested format of opus is "Author: Opus Name".</p>');
			$form[$eid][$eid.'opus'.$i] = array(
				'#type' => 'textfield',
				'#maxlength' => 30,
				'#required' => !$isvalidated,
				'#title' => t('Opus No.!i', array('!i' => $i)),
				'#default_value' => isset($default_values['opus'.$i])?$default_values['opus'.$i]:NULL,
				'#disabled' => $isvalidated,
			);
			if($ispassthrough) {
				$form[$eid][$eid.'opus'.$i]['#value'] = isset($default_values['opus'.$i])?$default_values['opus'.$i]:t('Not needed for passthrough students');
			}
		}
	}

	$form['#submit'][]='signup_user_examinations_form_save';
	return $form;
}

function signup_user_examinations_form_save($form, $form_state) {
	$user=$form['#user'];
	$isvalidated=db_select('students','s')->fields('s',array('validated'))->condition('s.uid',$user->name)->execute()->fetchField();
	if($isvalidated) return;

  	$opus_to_save = array();

	$edit=$form_state['values'];
	foreach($edit as $fid => $fvalue) {
		if(strpos($fid, 'additional')) {
			$eid=substr($fid,11);
			$opus_to_save[$eid]['eadditional'] = $fvalue;
			$edit[$fid]=NULL;
		}
		else if(strpos($fid,'opus')) {
			$eid=substr($fid,0,3);
			$oid=substr($fid,7);
			$opus_to_save[$eid]['opus'.$oid] = $fvalue;
			$edit[$fid]=NULL;
		}
	}
	foreach($opus_to_save as $eid=>$edata) {
		db_update('students_going')
			->fields(array(
				'opus' => serialize($edata)
			))
			->condition('uid', $user->name)
			->condition('eid', $eid)
			->execute();
  	  }
  	  
	signup_user_goto($user);
}

function signup_user_contact_form($form, $form_state) {
	$user=$form['#user'];
	
	// Fetch default values
	$default_values=array();
	$query=db_select('students_contact','sc')->fields('sc')->condition('sc.uid', $user->name);
	if($query->countQuery()->execute()->fetchField()==0) {
		$default_values['contact_phone'] = '';
		$default_values['address_round3'] = '';
		$default_values['zip_round3'] = '';
		$default_values['recipient_round3'] = '';
		$default_values['address_roundg'] = '';
		$default_values['zip_roundg'] = '';
		$default_values['phone_roundg'] = '';
		$default_values['personnel_record_at'] = '';
		$default_values['address_of_home'] = '';
		$default_values['terminus_of_train'] = '';
		$default_values['recipient_roundg'] = '';
		$default_values['address_school'] = '';
		$default_values['zip_school'] = '';
		$default_values['recipient_school'] = '';
		$r=db_select('students_gk','sg')->fields('sg',array('province'))->condition('sg.uid',$user->name)->condition('sg.province','110000','<>')->execute()->fetchField();
		$default_values['needroom']=($r)?1:0;
	}
	else {
		$default_values=$query->execute()->fetchAssoc();
		if($default_values['address_of_home']!=='') {
			$ad_of_home = unserialize($default_values['address_of_home']);
			$default_values += $ad_of_home;
		}
	}
	// Paint form
	$form['contact_phone'] = array(
		'#type' => 'textfield',
		'#title' => t('The phone number we could contact you during the period of examination'),
		'#default_value' => $default_values['contact_phone'],
		'#required' => 'true',
		'#maxlength' => 30,
		'#size' => 30,
		'#weight' => -10,
		'#default_value' => $default_values['contact_phone'],
	);
	
	$form['contact_round3'] = array(
		'#type' => 'fieldset',
		'#title' => t('Passing professional exam mailing address'),
		'#description' => t('The message will be sent registered.'),
		'#collapsible' => 'true',
		'#collapsed' => 0,
		'#weight' => 0,
	);
	$form['contact_round3']['address_round3'] = array(
		'#type' => 'textfield',
		'#title' => t('Address'),
		'#maxlength' => 80,
		'#required' => 'true',
		'#default_value' => $default_values['address_round3'],
	);
	$form['contact_round3']['zip_round3'] = array(
		'#type' => 'textfield',
		'#title' => t('Postcode'),
		'#maxlength' => 20,
		'#required' => 'true',
		'#default_value' => $default_values['zip_round3'],
	);
	$form['contact_round3']['recipient_round3'] = array(
		'#type' => 'textfield',
		'#title' => t('Recipient'),
		'#maxlength' => 20,
		'#required' => 'true',
		'#default_value' => $default_values['recipient_round3'],
	);

	$form['contact_roundg'] = array(
		'#type' => 'fieldset',
		'#title' => t('Letter of admission mailing address'),
		'#description' => t('The message will be sent via EMS, so a phone number is required.'),
		'#collapsible' => 'true',
		'#collapsed' => 0,
		'#weight' => 1,
	);
	$form['contact_roundg']['address_roundg'] = array(
		'#type' => 'textfield',
		'#title' => t('Address'),
		'#maxlength' => 80,
		'#required' => 'true',
		'#default_value' => $default_values['address_roundg'],
	);
	$form['contact_roundg']['zip_roundg'] = array(
		'#type' => 'textfield',
		'#title' => t('Postcode'),
		'#maxlength' => 20,
		'#required' => 'true',
		'#default_value' => $default_values['zip_roundg'],
	);
	$form['contact_roundg']['recipient_roundg'] = array(
		'#type' => 'textfield',
		'#title' => t('Recipient'),
		'#maxlength' => 20,
		'#required' => 'true',
		'#default_value' => $default_values['recipient_roundg'],
	);
	$form['contact_roundg']['phone_roundg'] = array(
		'#type' => 'textfield',
		'#title' => t('Phone number'),
		'#maxlength' => 20,
		'#required' => 'true',
		'#default_value' => $default_values['phone_roundg'],
	);

	$form['contact_school'] = array(
		'#type' => 'fieldset',
		'#title' => t('The address of your home'),
		'#description' => t('The address will be used by the academic administration department after admission.'),
		'#collapsible' => 'true',
		'#collapsed' => 0,
		'#weight' => 2,
	);
	$form['contact_school']['address_school'] = array(
		'#type' => 'textfield',
		'#title' => t('Address'),
		'#maxlength' => 80,
		'#required' => 'true',
		'#default_value' => $default_values['address_school'],
	);
	$form['contact_school']['zip_school'] = array(
		'#type' => 'textfield',
		'#title' => t('Postcode'),
		'#maxlength' => 20,
		'#required' => 'true',
		'#default_value' => $default_values['zip_school'],
	);
	$form['contact_school']['recipient_school'] = array(
		'#type' => 'textfield',
		'#title' => t('Recipient'),
		'#maxlength' => 20,
		'#required' => 'true',
		'#default_value' => $default_values['recipient_school'],
	);
	
	$form['other'] = array(
		'#type' => 'fieldset',
		'#title' => t('Other information'),
		'#collapsible' => 'true',
		'#collapsed' => 0,
		'#weight' => 3,
	);
	$form['other']['terminus_of_train'] = array(
		'#type' => 'textfield',
		'#title' => t('The terminus of train'),
		'#description' => t('The terminus when you take the trains going home.'),
		'#maxlength' => 20,
		'#required' => 'true',
		'#default_value' => $default_values['terminus_of_train'],
	);
	$form['other']['needroom'] = array(
		'#type' => 'checkbox',
		'#title' => t('I need dorm in my university life.'),
		'#description' => t('You will need to provide additional information after enrollment.'),
		'#default_value' => $default_values['needroom'],
	);
	$form['other']['personnel_record_at'] = array(
		'#type' => 'textfield',
		'#title' => t('The organization which holds your personal record'),
		'#description' => t('This should be high school for students.'),
		'#autocomplete_path' => 'signup/schools_autocompletion',
		'#maxlength' => 20,
		'#required' => 'true',
		'#default_value' => $default_values['personnel_record_at'],
	);
	
	$ucategory=$user->ucategory;
	if($ucategory == '3' || $ucategory == '0') unset($form['other']);
	if($ucategory == '0') {
		unset($form['contact_round3']);
		unset($form['contact_roundg']);
		unset($form['contact_school']);
	}
	$form['#submit'][]='signup_user_contact_form_save';
	return $form;
}

function signup_user_contact_form_save($form, $form_state) {
	$user=$form['#user'];
	$edit=$form_state['values'];
	
	// If is our own students, lets fill in some more information automatically
	if($user->ucategory==0) {
		$sid=db_select('students','s')->fields('s',array('idcard_number'))->condition('uid',$user->name)->execute()->fetchField();
		db_set_active('xjinfo');
		$r=db_select('XS_XJB','xj')->fields('xj')->condition('XH',$sid)->execute()->fetchObject();
		db_set_active('default');
		$depname=db_select('vl_department','d')->fields('d',array('dname'))->condition('did_exchange',$r->xsh)->execute()->fetchField();

		$edit['address_round3'] = '中央音乐学院'.$depname;
		$edit['zip_round3'] = '100031';
		$edit['recipient_round3'] = $r->xm;
		$edit['address_roundg'] = $edit['address_round3'];
		$edit['zip_roundg'] = $edit['zip_round3'];
		$edit['recipient_roundg'] = $edit['recipient_round3'];
		$edit['personnel_record_at'] = $depname;
	}
	
	$r=db_select('students_contact','sc')->fields('sc')->condition('uid',$user->name)->countQuery()->execute()->fetchField();
	if($r)
		db_delete('students_contact')->condition('uid',$user->name)->execute();
	db_insert('students_contact')
		->fields(array(
			'uid' => $user->name, 
			'contact_phone' => $edit['contact_phone'],
			'address_round3' => isset($edit['address_round3'])?$edit['address_round3']:'',
			'zip_round3' => isset($edit['zip_round3'])?$edit['zip_round3']:'',
			'recipient_round3' => isset($edit['recipient_round3'])?$edit['recipient_round3']:'',
			'address_roundg' => isset($edit['address_roundg'])?$edit['address_roundg']:'',
			'zip_roundg' => isset($edit['zip_roundg'])?$edit['zip_roundg']:'',
			'recipient_roundg' => isset($edit['recipient_roundg'])?$edit['recipient_roundg']:'',
			'phone_roundg' => isset($edit['phone_roundg'])?$edit['phone_roundg']:'',
			'address_of_home' => serialize(array(
		  		'address_school'=>isset($edit['address_school'])?$edit['address_school']:'',
		  		'zip_school'=>isset($edit['zip_school'])?$edit['zip_school']:'',
		  		'recipient_school'=>isset($edit['recipient_school'])?$edit['recipient_school']:'',
		  		)),
			'terminus_of_train' => isset($edit['terminus_of_train'])?$edit['terminus_of_train']:'',
			'personnel_record_at' => isset($edit['personnel_record_at'])?$edit['personnel_record_at']:'',
			'needroom' => isset($edit['needroom'])?$edit['needroom']:'0',
		))->execute();
	signup_user_goto($user);
}

function signup_user_gaokao_form($form, $form_state) {
	$user=$form['#user'];
	$ucategory=$user->ucategory;

	// Genereates default values.
	$default_values = array();
	$query=db_select('students_gk','sg')->fields('sg')->condition('sg.uid', $user->name);
	if($query->countQuery()->execute()->fetchField()>0) {
		$default_values = $query->execute()->fetchAssoc();
	}
	
	// city/district list
	$citylist = array();
	$query=db_select('vl_city_district', 'cd');
	$query->innerJoin('students_gk', 'sg', 'cd.pid=sg.province');
	$query=$query->fields('cd')->condition('sg.uid', $user->name)->where("cd.cid <> cd.pid")->orderBy('cd.cid');
	$rdbo=$query->execute();
	
	foreach($rdbo as $r) {
		$citylist += array($r->cid => $r->name);
	}

	$query=db_select('vl_province','p');
	$query->innerJoin('students_gk', 'sg', 'p.pid=sg.province');
	$is_gk_enabled=$query->fields('p',array('isgkenabled'))->condition('sg.uid',$user->name)->execute()->fetchField();
	
	// Gaokao frameset
	$form['gkinfo'] = array(
		'#type' => 'fieldset',
		'#title' => t('Exam info'),
		'#collapsible' => 'true',
	);

	$form['gkinfo']['sid'] = array(
		'#type' => 'textfield',
		'#title' => t('The student ID given by your exam organizer'),
		'#description' => $ucategory == 1? t('It should be a 14-digit number, beginning with @year.',array('@year'=>substr(variable_get('zhaoban_current_year',date('Y')),-2))).t('You can leave it blank safely.') : '',
		'#maxlength' => 14,
		'#default_value' => $default_values['sid'],
		//'#value' => $default_values['sid'],
		'#required' => $is_gk_enabled,
		'#disabled' => ($default_values['validated']==1)?true:false,
	);
	$form['gkinfo']['city_district'] = array(
		'#type' => 'select',
		'#title' => t('The city/district you live in'),
		'#description' => t('To change your province, please <a href="@url">click the link here</a>.',
			array('@url'=>'/user/'.$user->uid.'/edit#edit-province')),
		'#required' => true,
		'#options' => $citylist,
		'#default_value' => $default_values['city_district'],
		'#disabled' => ($default_values['validated']==1)?true:false,
	);
	// Is one a science student?
	$form['gkinfo']['is_math_subjects'] = array(
		'#type' => 'radios',
		'#title' => t('The subject I take'),
		'#options' => array('0' => t('Liberal'), '1' => t('Science')),
		'#default_value' => $default_values['is_math_subjects'],
		'#required' => true,
		'#disabled' => ($default_values['validated']==1)?true:false,
	);

	$form['score'] = array(
		'#type' => 'fieldset',
		'#title' => t('Scores'),
		'#collapsible' => 'true',
	);
	
	$form['score']['score_chinese'] = array(
		'#type' => 'textfield',
		'#title' => t('Chinese'),
		'#default_value' => $default_values['score_chinese'],
		//'#value' => $default_values['score_chinese'],
		'#disabled' => ($default_values['validated']==1)?true:false,
		'#required' => TRUE,
	);
	$form['score']['score_languages'] = array(
		'#type' => 'textfield',
		'#title' => t('Foreign language'),
		'#default_value' => $default_values['score_languages'],
		//'#value' => $default_values['score_languages'],
		'#disabled' => ($default_values['validated']==1)?true:false,
		'#required' => TRUE,
	);
	$form['score']['score_math'] = array(
		'#type' => 'textfield',
		'#title' => t('Math'),
		'#description' => t('The score of Mathematics has been counted in since 2006.'),
		'#default_value' => $default_values['score_math'],
		//'#value' => $default_values['score_math'],
		'#disabled' => ($default_values['validated']==1)?true:false,
		'#required' => TRUE,
	);
	$form['score']['score_synthesis'] = array(
		'#type' => 'textfield',
		'#title' => t('Synthesis subject'),
		'#default_value' => $default_values['score_synthesis'],
		//'#value' => $default_values['score_synthesis'],
		'#disabled' => ($default_values['validated']==1)?true:false,
		'#description' => t('If you are from Shandong province, please add your testing score into synthesis subject.'),
		'#required' => TRUE,
	);
	// Computes visibility of score section.
	if($default_values['validated']===1) {
		$form['score']['#description'] = t('We\'ve get your scores from your province, so you do not need to input them yourself.');
		unset($form['gkinfo']['sid']['#value']);
		unset($form['score']['score_chinese']['#value']);
		unset($form['score']['score_languages']['#value']);
		unset($form['score']['score_math']['#value']);
		unset($form['score']['score_synthesis']['#value']);
	}
	else if(!$is_gk_enabled) {
		$form['score']['#description'] = t('The score uploading feature of your provice is banned by the administrator.');
		unset($form['score']['score_chinese']);
		unset($form['score']['score_languages']);
		unset($form['score']['score_math']);
		unset($form['score']['score_synthesis']);
	}
	
	$form['#validate'][]='signup_user_gaokao_form_validate';
	$form['#submit'][]='signup_user_gaokao_form_save';
	return $form;
}

function signup_user_gaokao_form_save($form, $form_state) {
	$user=$form['#user'];
	$edit=$form_state['values'];
	$isvalidated=db_select('students','s')->fields('s',array('validated'))->condition('s.uid',$user->name)->execute()->fetchField();
	if($isvalidated) return;
	
	db_update('students_gk')
		->fields(array(
			'city_district' => $edit['city_district'],
			'is_math_subjects' => $edit['is_math_subjects'],
			'sid' => $edit['sid'],
		))
		->condition('uid', $user->name)
		->execute();
	
	$query=db_select('vl_province','p');
	$query->innerJoin('students_gk', 'sg', 'p.pid=sg.province');
	$is_gk_enabled=$query->fields('p',array('isgkenabled'))->condition('sg.uid',$user->name)->execute()->fetchField();
	
	if($is_gk_enabled) {
		db_update('students_gk')
			->fields(array(
				'score_chinese' => $edit['score_chinese'],
				'score_languages' => $edit['score_languages'],
				'score_math' => $edit['score_math'],
				'score_synthesis' => $edit['score_synthesis'],
			))
			->condition('uid', $user->name)
			->execute();
	}
	signup_user_goto($user);
	return;
}

function signup_user_gaokao_form_validate($form, $form_state) {
	$user=$form['#user'];
	$edit=$form_state['values'];

	$is_gid_invalid = FALSE;
	$ucategory=$user->ucategory;
	if($ucategory == 1)
		if($edit['sid']) {
			if(!preg_match('/'.substr(variable_get('zhaoban_current_year',date('Y')),-2).'\d{12}/', $edit['sid'])) $is_gid_invalid = TRUE;
			if($is_gid_invalid) form_set_error('sid', t('The student gaokao ID you\'ve entered is not valid.'));
		}
		if(isset($edit['score_chinese']) && !is_numeric($edit['score_chinese']))
			form_set_error('score_chinese', t('The score you\'ve entered is not valid.'));
		if(isset($edit['score_languages']) && !is_numeric($edit['score_languages']))
			form_set_error('score_languages', t('The score you\'ve entered is not valid.'));
		if(isset($edit['score_math']) && !is_numeric($edit['score_math']))
			form_set_error('score_math', t('The score you\'ve entered is not valid.'));
		if(isset($edit['score_synthesis']) && !is_numeric($edit['score_synthesis']))
			form_set_error('score_synthesis', t('The score you\'ve entered is not valid.'));
}

function signup_user_login_block($form) {
  //$form['attributes'] = array('style'=>'align: center');
  $form['#action'] = url($_GET['q'], array('query' => drupal_get_destination()));
  $form['#validate'] = user_login_default_validators();
  $form['#id'] = 'user-login-form';
  $form['#submit'][] = 'user_login_submit';
  $form['name'] = array('#type' => 'textfield',
    '#title' => t('Username/ID Number'),
    '#maxlength' => USERNAME_MAX_LENGTH,
    '#size' => 15,
    '#required' => TRUE,
    '#attributes' => array('placeholder'=>variable_get('zhaoban_current_year',date('Y')).'BXXXX'),
  );
  $form['pass'] = array('#type' => 'password',
    '#title' => t('Password'),
    '#maxlength' => 60,
    '#size' => 15,
    '#required' => TRUE,
  );
  $form['actions'] = array('#type' => 'actions');
  $form['actions']['submit'] = array('#type' => 'submit',
    '#value' => t('Log in'),
  );
  $items = array();
  if (variable_get('user_register', USER_REGISTER_VISITORS_ADMINISTRATIVE_APPROVAL)) {
    $items[] = l(t('Begin signup'), 'user/register');
  }
  $items[] = l(t('Request new password'), 'user/password');
  $form['links'] = array('#markup' => theme('item_list', array('items' => $items)));
	drupal_add_js(
		'jQuery(document).ready(function(){'.
			'deal_input_palceholder();});',
		'inline'
	);
  return $form;
}

/**
 * Implements hook_block_info().
 */
function signup_block_info() {
	$result=array();
	
	$result['loginlocal'] = array(
		'info' => t('User login (Local version)'),
		'cache' => DRUPAL_NO_CACHE
	);

	$result['progress'] = array(
		'info' => t('Signup Progress'),
		'cache' => DRUPAL_NO_CACHE
	);
	$result['hotprof'] = array(
		'info' => t('Hot professions'),
		'cache' => DRUPAL_NO_CACHE,
	);
	$result['searchstu'] = array(
		'info' => t('Search students'),
		'cache' => DRUPAL_NO_CACHE
	);
	//var_dump($result);
	return $result;
}

/**
 * Implements hook_block_view().
 */
function signup_block_view($delta = '') {
	global $user;
	$block = array();
	switch ($delta) {
		case 'loginlocal':
			// For usability's sake, avoid showing two login forms on one page.
			if (!$user->uid && !(arg(0) == 'user' && !is_numeric(arg(1)))) {
				$block['subject'] = t('User login');
				$block['content'] = drupal_get_form('signup_user_login_block');
			}
			return $block;
			break;
		case 'progress':
			if($user->uid && db_select('students','s')->fields('s')->condition('s.uid',$user->name)->countQuery()->execute()->fetchField()>0)
				return signup_block_content_PROGRESS();
			else
				return $block;
			break;
		case 'hotprof':
			if(db_select('students','s')->fields('s')->condition('profession_major','0','<>')->countQuery()->execute()->fetchField()>0)
				return signup_block_content_HOTPROF();
			else
				return $block;
			break;
		case 'searchstu':
			if(user_access('access user profiles')) {
				$block['subject']=t('Search students');
				$block['content']=drupal_get_form('signup_search_student');
				return $block;
			}
			else
				return $block;
			break;
  		}
}

function signup_block_content_PROGRESS() {
	$result=array();
	
	$result['subject']=t('Signup Progress');
	$result['content']='<p></p><p style="vertical-align: middle">';

	// If the user has filled up personal detail?
	if(db_select('students','s')->fields('s',array('name'))->condition('s.uid', $GLOBALS['user']->name)->execute()->fetchField()=='')
		if(arg(0)=='user'&&arg(2)=='edit'&&is_null(arg(3)))
			$status[0]='warning';
		else
			$status[0]='error';
	else $status[0]='ok';
	$result['content'] .= sprintf('<img src="/misc/watchdog-%s.png" align="middle">&nbsp;&nbsp;', $status[0]);
	$result['content'] .= l(t('Personal Detail'), 'user/'.$GLOBALS['user']->uid.'/edit');
	$result['content'] .='</p><p></p><p>';

	// If user has filled up a profession?
	if(!_signup_user_tab_access($GLOBALS['user'],'exam'))
		if(arg(0)=='user'&&arg(2)=='edit'&& arg(3)=='profession')
			$status[1]='warning';
		else
			$status[1]='error';
	else $status[1]='ok';
	$result['content'] .= sprintf('<img src="/misc/watchdog-%s.png" align="middle">&nbsp;&nbsp;', $status[1]);
	$result['content'] .= !_signup_user_tab_access($GLOBALS['user'],'profession')?t('Choose a Profession'):l(t('Choose a Profession'),'user/'.$GLOBALS['user']->uid.'/edit/profession');
	$result['content'] .='</p><p></p><p>';
	
	// If user has filled exams?
	if(!_signup_user_tab_access($GLOBALS['user'],'contact'))
		if(arg(0)=='user'&&arg(2)=='edit'&& arg(3)=='exam')
			$status[2]='warning';
		else
			$status[2]='error';
	else $status[2]='ok';
	$result['content'] .= sprintf('<img src="/misc/watchdog-%s.png" align="middle">&nbsp;&nbsp;', $status[2]);
	$result['content'] .= !_signup_user_tab_access($GLOBALS['user'],'exam')?t('Fill up Examninations'):l(t('Fill up Examninations'),'user/'.$GLOBALS['user']->uid.'/edit/exam');
	$result['content'] .='</p><p></p><p>';

	// If user has filled contact info?
	$r = db_select('students_contact','sc')->fields('sc',array('contact_phone'))->condition('uid',$GLOBALS['user']->name)->execute()->fetchField();
	if($r=='')
		if(arg(0)=='user'&&arg(2)=='edit'&& arg(3)=='contact')
			$status[3]='warning';
		else
			$status[3]='error';
	else $status[3]='ok';
	$result['content'] .= sprintf('<img src="/misc/watchdog-%s.png" align="middle">&nbsp;&nbsp;', $status[3]);
	$result['content'] .= !_signup_user_tab_access($GLOBALS['user'],'contact')?t('Leave Contact Details'):l(t('Leave Contact Details'),'user/'.$GLOBALS['user']->uid.'/edit/contact');
	$result['content'] .='</p><p></p><p>';

	// If user has filled gaokao info?
	$ucategory=db_select('students','s')->fields('s',array('ucategory'))->condition('uid',$GLOBALS['user']->name)->execute()->fetchField();
	
	if($ucategory==1 || $ucategory==2) {
		$r=db_select('students_gk','sg')->fields('sg')->condition('sg.uid',$GLOBALS['user']->name)->isNotNull('sg.sid')->countQuery()->execute()->fetchField();
		if($r==0)
			if(arg(0)=='user'&&arg(2)=='edit'&& arg(3)=='gaokao')
				$status[3]='warning';
			else
				$status[3]='error';
		else if($status[2]=='warning'||$status[2]=='error')
			$status[3]='error';
		else
			$status[3]='ok';
		$result['content'] .= sprintf('<img src="/misc/watchdog-%s.png" align="middle">&nbsp;&nbsp;', $status[3]);
		$result['content'] .= $status[3]!='ok'?t('Gaokao Info'):l(t('Gaokao Info'),'user/'.$GLOBALS['user']->uid.'/edit/gaokao');
	}
	$result['content'] .='</p><p></p><p>';
	return $result;
}

function signup_block_content_HOTPROF() {
	$result=array();
	$numofprofess = db_select('vl_professions','p')->fields('p')->condition('p.enabled','1')->countQuery()->execute()->fetchField();
	$r=t('There are !url opening for signing up this year.<br />'.
		'!users students have been registered till now.',
		array(
			'!num' => $numofprofess,
			'!url' => $GLOBALS['user']->uid?t('!num professions',array('!num' => $numofprofess)):l(t('!num professions',array('!num' => $numofprofess)),'http://www.ccom.edu.cn/news/zsks/201112/t20111219_20041.html'),
			'!users' => db_select('students','s')->fields('s')->condition('s.idcard_number','','<>')->condition('s.profession_major','0','<>')->countQuery()->execute()->fetchField(),
	));
	$r.='<br/>';
	$num=db_select('students','s')->fields('s')->condition('s.validated','1')->countQuery()->execute()->fetchField();
	if($num>0)
		$r.=t('!num of which has been confirmed.', array('!num'=>$num));

	$result['content']=$r;
	$result['subject']=t('Hot professions');
	return $result;
}


function signup_search_student($form, $form_state) {
	if(isset($form_state['rebuild_info']['haserror']) && $form_state['rebuild_info']['haserror']==1) {
		$form['errmsg'] = array(
			'#type' => 'markup',
			'#markup' => '<div class="messages error" id="errmsg">'.t('Invalid Student ID').'</div>',
			);
		drupal_add_js(
			'jQuery(document).ready(function(){'.
				'jQuery("#edit-uid").focus();'.
				'window.setTimeout("jQuery(\"#errmsg\").slideUp();",3000)});',
			'inline'
		);
	}
	$form['uid'] = array(
		'#type' => 'textfield',
		'#maxlength' => 18,
		'#size' => 20,
		'#attributes' => array(
			'title' => t('Enter the Student ID, his name or his idcard number'),
		),
		'#prefix' => '<div class="container-inline">',
	);
	$form['submit'] = array(
		'#type' => 'submit',
		'#value' => t('Search'),
		'#attributes' => array(
			'style' => 'vertical-align: baseline;',
		),
		'#suffix' => '</div>',
	);
	
	return $form;
}

function signup_search_student_submit($form, &$form_state) {
	$valins="1";
	
	unset($form_state['rebuild_info']['haserror']);
	
	$query=db_select('users','u')->fields('u',array('uid'))->condition('u.name','%'.$form_state['values']['uid'].'%', 'LIKE')->where($valins)->orderBy('u.name');
	$query->innerJoin('students','s','u.name=s.uid');
	$uid=$query->execute()->fetchField();
	if(!$uid) {
		$query=db_select('users','u')->fields('u',array('uid'))->condition('s.name','%'.$form_state['values']['uid'].'%', 'LIKE')->where($valins)->orderBy('u.name');
		$query->innerJoin('students','s','u.name=s.uid');
		$uid=$query->execute()->fetchField();
		if(!$uid) {
			$query=db_select('users','u')->fields('u',array('uid'))->condition('s.idcard_number',$form_state['values']['uid'])->where($valins)->orderBy('u.name');
			$query->innerJoin('students','s','u.name=s.uid');
			$uid=$query->execute()->fetchField();
			if(!$uid) {
				$form_state['rebuild_info']['haserror']=1;
				$form_state['rebuild']=TRUE;
			} else
				$form_state['rebuild']=FALSE;
		} else
			$form_state['rebuild']=FALSE;
	} else 
		$form_state['rebuild']=FALSE;

	if(!$form_state['rebuild'])
		if(user_access('modify students info'))
			$form_state['redirect']='user/'.$uid.'/edit';
		else
			$form_state['redirect']='user/'.$uid;
}

function signup_form_contact_site_form_alter(&$form, &$form_state) {
	// we don't need email address for this site
	$form['mail']['#default_value']='';
	$form['copy']['#type']='hidden';
	if(isset($GLOBALS['user']->name)) {
		$r=db_select('students','s')->fields('s',array('name'))->condition('s.uid',$GLOBALS['user']->name)->execute()->fetchField();
		if($r)
			$form['name']['#default_value']=$r;
		else
			$form['name']['#default_value']='';
	}
}

function signup_overview_by_profession() {
	$output = '<div id="baoming_user_stat" class="baoming_view_section node">';
	
	if(db_select('students','s')->fields('s')->condition('s.validated',1)->countQuery()->execute()->fetchField() >0)
		$valins="s.validated=1 ";
	else 
		$valins="1";
		
	// Compute total number of registered students.
	$total_students=db_select('students','s')
		->fields('s')
		->condition('s.idcard_number','','<>')
		->condition('s.profession_major','0','<>')
		->where($valins)
		->countQuery()->execute()->fetchField();
	
	$output .= '<p>'.t('There are @number valid students who have signed up.', array('@number'=>$total_students)).'</p>';
	$header = array(
		array('data'=>t('Profession'), 'field'=>'pid', 'sort'=>'asc'),
		array('data'=>t('Number of students (%)'), 'field'=>'num'),
	);

	$query = db_select('students','s')->condition('s.idcard_number','','<>');
	$query->innerJoin('vl_professions','p','s.profession_major = p.pid');
	$query->addExpression('COUNT(*)', 'num');
	$query = $query->where($valins)
		->fields('p',array('pid','uid','pname','pnamememo'))
		->groupBy('s.profession_major')
		->extend('TableSort')->orderByHeader($header);
	
	$rdbo = $query->execute();
	$rows=array();
	
	foreach($rdbo as $r) {
		if($r->pid) {
	       // Determine whether you are plain department
	       if(user_access('view own draft') && !user_access('view draft'))
	       	   if($GLOBALS['user']->name !== $r->uid) continue;
		   $rows[] = array(
			'<nobr>'.l($r->pname, 'signup/overview/profession/'.$r->pid, array(
			  'title' => t('Click to view the details of @prof profession', array('@prof'=>$r->pname)),
			  )
			).'</nobr>',
			sprintf('<img src="/%s/red-dot.png" style="width:%dpx; height:10px;"/> %d (%.1f%%)', drupal_get_path('module','signup'), $r->num, $r->num, $r->num/$total_students*100),
		   );
		}
	}
	/*
	$tablesort = tablesort_sql($header);
	$sql=sprintf(
		"SELECT p.pid, p.uid, p.pname, p.pnamememo, count(*) AS num FROM {students} s INNER JOIN {vl_professions} p ".
			"ON s.profession_major = p.pid WHERE s.idcard_number <> ''".$valins.$sql_department_insert.
			"GROUP BY s.profession_major".
			"%s", $tablesort);
	$rdbo = db_query($sql);
	
	while(($r = db_fetch_object($rdbo))) {
		if($r->pid) {
	       // Determine whether you are plain department
	       if(user_access('view own draft') && !user_access('view draft'))
	       	   if($GLOBALS['user']->name !== $r->uid) continue;
		   $rows[] = array(
			'<nobr>'.l($r->pname.$r->pnamememo, 'signup/overview/profession/'.$r->pid, array(
			  'title' => t('Click to view the details of @prof profession', array('@prof'=>$r->pname)),
			  )
			).'</nobr>',
			sprintf('<img src="/%s/red-dot.png" style="width:%dpx; height:10px;"/> %d (%.1f%%)', drupal_get_path('module','signup'), $r->num, $r->num, $r->num/$total_students*100),
		   );
		}
	}
	*/
	$output .= theme('table', array('header'=>$header, 'rows'=>$rows));
	
	$output .= '</div>';
	
	setcookie('examplace', NULL, 0, '/');
	return $output;
}

function signup_overview_by_profession_detail($prof=NULL) {
	$cookie_examplace='1';
	
	if(isset($_COOKIE["examplace"])) {
		$query=db_select('vl_profession_place','pp')
			->condition('pp.examplace',$_COOKIE["examplace"])
			->condition('pp.pid',$prof)
			->countQuery();
		if(($query->execute()->fetchField()>0) || ($_COOKIE['examplace']=='110000'))
			$cookie_examplace="s.examplace='".$_COOKIE['examplace']."'";
		else
			setcookie('examplace', NULL);
	}
	
	drupal_add_js(drupal_get_path('module', 'signup') .'/signup.js');

	$query=db_select('vl_professions','p')->fields('p',array('pname'))->condition('p.pid',$prof);
	$query->innerJoin('vl_department','d','p.did=d.did');
	$query=$query->fields('d',array('dname'));
	$r=$query->execute()->fetchObject();
	$profession_major = t('!dname!pname', array(
  	  	  '!dname' => $r->dname,
  	  	  '!pname' => $r->pname,
  	));

	drupal_set_title(t('By Profession').' - '.$r->pname);
  
	if(db_select('students','s')->fields('s')->condition('s.validated',1)->countQuery()->execute()->fetchField() >0)
		$valins="s.validated=1 ";
	else 
		$valins="1";

  if($prof)
  	$sql_department_insert = "p.pid='".$prof."'";
  else
  	$sql_department_insert = '1';
  $output = '<div id="baoming_user_list" class="baoming_view_section node">';
  
  $r=db_select('vl_city_district','cd')->fields('cd',array('cid','name'))->condition('cd.cid','110000')->execute()->fetchObject();
  $options=array('000000'=>t('All students'));
  $options+=array((string)($r->cid)=>$r->name);

  $query=db_select('vl_profession_place','p')->condition('p.pid',$prof);
  $query->innerJoin('vl_city_district','cd','p.examplace=cd.cid');
  $query=$query->fields('cd',array('cid','name'))->orderBy('cd.cid');
  $rdbo=$query->execute();
  foreach($rdbo as $r) {
  	  $a=(string)($r->cid);
  	  $options += array((string)$r->cid=>$r->name);
  }
  $options=array_unique($options);
  if(count($rdbo)) {
  	  $placeselect = array(
  	  	  '#id' => 'placeselect',
  	  	  '#type' => 'select',
  	  	  '#title' => t('Exam Place'),
  	  	  '#options' => $options,
  	  	  '#prefix' => '<div class="inline-element-div">',
  	  	  '#attributes' => array('onChange' => ''.
  	  	  	'jQuery.cookie("examplace", jQuery("#placeselect").val(), 0, "/");'.
  	  	  	'window.location.reload();'.
  	  	  ''),
  	  	  //'#default_value' => (int)$_COOKIE['examplace'],
  	  	  '#suffix' => '</div>',
  	  );
  	  if(isset($_COOKIE['examplace']))
		drupal_add_js(
			'jQuery(document).ready(function(){'.
				'jQuery("#placeselect").val('.$_COOKIE['examplace'].');'.
				'});'.
				'',
			'inline'
		);
	  if(count(array_keys($options))>2)
  	  	$output .= drupal_render($placeselect);
  }
  $rows = array();
  $header = array(
  	array('data' =>t('Student ID'), 'field'=>'s.uid', 'sort'=>'desc'),
  	array('data' =>t('Real Name')),
  	array('data' =>t('Gender'), 'field'=>'s.gender'),
  	array('data' =>t('Profession'), 'field'=>'s.profession_major'),
  	array('data' =>t('Province'), 'field'=>'gk.province'),
  	array('data' =>t('Personnel record'), 'field'=>'personnel_record_at'),
  );
  
  //$tablesort = tablesort_sql($header);
  //var_dump($cookie_examplace);
  $query=db_select('students','s')->condition('s.idcard_number','','<>')->fields('s');
  $query->leftJoin('students_gk','gk','s.uid=gk.uid');
  $query->leftJoin('students_contact','c','s.uid=c.uid');
  $query->innerJoin('vl_professions','p','s.profession_major=p.pid');
  $query->innerJoin('users','u','s.uid=u.name');
  $query->addExpression('u.uid', 'sys_uid');
  $query = $query->fields('c', array('personnel_record_at'))
  	  		->fields('gk')
  	  		->where($sql_department_insert)->where($valins)->where($cookie_examplace)
			->extend('TableSort')->orderByHeader($header)
			->extend('PagerDefault')->limit(20);
  //var_dump($query->__toString());
  $rdbo=$query->execute();
  if(count($rdbo)==0) {
  	  $rows[][] = array('data'=> t('N/A'), 'colspan'=>(string)count($header));
  }
  else
  foreach($rdbo as $r) {
  	  switch($r->ucategory) {
  	  	  case uc_OWN_STUDENT:
  	  	  	  $province = t('Our own student');
  	  	  	  $per = t('Our own student');
  	  	  	  $plink = '000000';
  	  	  	  break;
  	  	  case uc_MAINLAND_STUDENT:
  	  	  case uc_HKTW_STUDENT:
  	  	  	  $province = $r->province ? db_select('vl_province','p')->fields('p',array('simplified_name'))->condition('p.pid',$r->province)->execute()->fetchField() : t('N/A');
  	  	  	  $per = $r->personnel_record_at;
  	  	  	  if(!$per) $per=t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  	  case uc_OVERSEA_STUDENT:
  	  	  	  $province = db_select('vl_city_district','cd')->fields('cd',array('name'))->condition('cd.cid',$r->city_district)->execute()->fetchField();
  	  	  	  $per = t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  }
  	  
  	  
  	  $rows[] = array(
  	  	'<nobr>'.l($r->uid, 'user/'.$r->sys_uid).'</nobr>',
  	  	'<nobr>'.$r->name.'</nobr>',
  	  	$r->gender == 1 ? t('Male'): t('Female'),
  	  	l($profession_major, 'signup/overview/profession/'.$r->profession_major, array(
		  'title' => t(
		    'Click to view the details of @prof', array(
		    '@prof' => $profession_major)
		  ))
		),
  	  	(user_access('view draft'))?l($province, 'signup/overview/province/'.$plink):($province),
  	  	$per,
  	  );
  }
  
  $output .= theme('table', array('header'=>$header, 'rows'=>$rows));
  $output .= theme('pager');
  $output .= "</div>";
  
  $output .= l(t('<< Back to full student list'), 'signup/overview/profession');
  
  return $output;
}

function signup_overview_by_province() {

	$prof=arg(3);
	if(db_select('students','s')->fields('s')->condition('s.validated',1)->countQuery()->execute()->fetchField() >0)
		$valins="s.validated=1 ";
	else 
		$valins="1";

	// Compute total number of registered students.
	$total_students=db_select('students','s')
		->fields('s')
		->condition('s.idcard_number','','<>')
		->condition('s.profession_major','0','<>')
		->where($valins)
		->countQuery()->execute()->fetchField();
	
	$output = '<p>'.t('There are @number valid students who have signed up.', array('@number'=>$total_students)).'</p>';
	$header = array(
		array('data'=>t('Province'), 'field'=>'pid'),
		array('data'=>t('Number of students'), 'field'=>'num', 'sort'=>'desc'),
	);
	$query = db_select('students','s')->condition('s.idcard_number','','<>')->condition('s.profession_major','0', '<>');
	$query->leftJoin('students_gk','sg','s.uid=sg.uid');
	$query->leftJoin('vl_province','p','sg.province=p.pid');
	$query = $query->fields('s',array('ucategory','uid'))
		->fields('p',array('pid','name'));
	$query->addExpression('COUNT(s.uid)', 'num');
	$query = $query->where($valins)
		->groupBy('p.pid')
		->groupBy('s.ucategory')
		->extend('TableSort')->orderByHeader($header);
	
	$rdbo = $query->execute();
	$rows=array();
	
	foreach($rdbo as $r) {
		if($r->pid) {
	       // Determine whether you are plain department
	       if(user_access('view own draft') && !user_access('view draft'))
	       	   if($GLOBALS['user']->name !== $r->uid) continue;
		   $rows[] = array(
			'<nobr>'.l($r->name, 'signup/overview/province/'.$r->pid, array(
			  'title' => t('Click to view the details of @prov province', array('@prov'=>$r->name)),
			  )
			).'</nobr>',
			sprintf('<img src="/%s/red-dot.png" style="width:%dpx; height:10px;"/> %d (%.1f%%)', drupal_get_path('module','signup'), $r->num, $r->num, $r->num/$total_students*100),
		   );
		} else if($r->ucategory==='0') {
	       $rows[] = array(
	       	   l(t('Our own student'), 'signup/overview/province/000000', array(
	       	     'title' => t('Click to view the details of students from @province', array('@province'=>t('Our own student'))),
	       	   )),
			   sprintf('<img src="/%s/red-dot.png" style="width:%dpx; height:10px;"/> %d (%.1f%%)', drupal_get_path('module','signup'), $r->num, $r->num, $r->num/$total_students*100),
	       );
		}

	}
	
  	$output .= theme('table', array('header'=>$header, 'rows'=>$rows));

	return $output;
	
}

function signup_overview_by_province_detail($prov=NULL) {
	
	$query=db_select('vl_province','p')->fields('p',array('name'))->condition('p.pid',$prov);
	$r=$query->execute()->fetchObject();

	drupal_set_title(t('By Province').' - '.$r->name);
  
	if(db_select('students','s')->fields('s')->condition('s.validated',1)->countQuery()->execute()->fetchField() >0)
		$valins="s.validated=1 ";
	else 
		$valins="1";
	
	$output = '';
	
  $output = '<div id="baoming_user_list" class="baoming_view_section node">';
  
  $rows = array();
  $header = array(
  	array('data' =>t('Student ID'), 'field'=>'s.uid', 'sort'=>'desc'),
  	array('data' =>t('Real Name')),
  	array('data' =>t('Gender'), 'field'=>'s.gender'),
  	array('data' =>t('Profession'), 'field'=>'s.profession_major'),
  	array('data' =>t('Province'), 'field'=>'gk.province'),
  	array('data' =>t('Personnel record'), 'field'=>'personnel_record_at'),
  );

  if($prov=='000000')
	$provcondition='s.ucategory = 0';
  else
	$provcondition="gk.province='".$prov."'";
  
  //$tablesort = tablesort_sql($header);
  $query=db_select('students','s')->condition('s.idcard_number','','<>')->fields('s');
  $query->leftJoin('students_gk','gk','s.uid=gk.uid');
  $query->leftJoin('students_contact','c','s.uid=c.uid');
  $query->innerJoin('vl_professions','p','s.profession_major=p.pid');
  $query->innerJoin('users','u','s.uid=u.name');
  $query->addExpression('u.uid', 'sys_uid');
  $query = $query->fields('c', array('personnel_record_at'))
  	  		->fields('gk')
  	  		->fields('p',array('pname'))
  	  		->where($provcondition)->where($valins)
			->extend('TableSort')->orderByHeader($header)
			->extend('PagerDefault')->limit(20);
  $rdbo=$query->execute();
  if(count($rdbo)==0) {
  	  $rows[][] = array('data'=> t('N/A'), 'colspan'=>(string)count($header));
  }
  else
  foreach($rdbo as $r) {
  	  switch($r->ucategory) {
  	  	  case uc_OWN_STUDENT:
  	  	  	  $province = t('Our own student');
  	  	  	  $per = t('Our own student');
  	  	  	  $plink = '000000';
  	  	  	  break;
  	  	  case uc_MAINLAND_STUDENT:
  	  	  case uc_HKTW_STUDENT:
  	  	  	  $province = $r->province ? db_select('vl_province','p')->fields('p',array('simplified_name'))->condition('p.pid',$r->province)->execute()->fetchField() : t('N/A');
  	  	  	  $per = $r->personnel_record_at;
  	  	  	  if(!$per) $per=t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  	  case uc_OVERSEA_STUDENT:
  	  	  	  $province = db_select('vl_city_district','cd')->fields('cd',array('name'))->condition('cd.cid',$r->city_district)->execute()->fetchField();
  	  	  	  $per = t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  }
  	  
  	  
  	  $rows[] = array(
  	  	'<nobr>'.l($r->uid, 'user/'.$r->sys_uid).'</nobr>',
  	  	'<nobr>'.$r->name.'</nobr>',
  	  	$r->gender == 1 ? t('Male'): t('Female'),
  	  	l($r->pname, 'signup/overview/profession/'.$r->profession_major, array(
		  'title' => t(
		    'Click to view the details of @prof', array(
		    '@prof' => $r->pname)
		  ))
		),
  	  	(user_access('view draft'))?l($province, 'signup/overview/province/'.$plink):($province),
  	  	$per,
  	  );
  }
  
  $output .= theme('table', array('header'=>$header, 'rows'=>$rows));
  $output .= theme('pager');
  $output .= "</div>";
  
  $output .= l(t('<< Back to full student list'), 'signup/overview/province');
  return $output;
}

function signup_2nd_round_by_profession() {
	$output = '<div id="baoming_user_stat" class="baoming_view_section node">';
	
	if(db_select('students','s')->fields('s')->condition('s.validated',1)->countQuery()->execute()->fetchField() >0)
		$valins="s.validated=1 ";
	else 
		$valins="1";
		
	// Compute total number of registered students.
	$total_students=db_select('students','s')
		->fields('s')
		->condition('s.idcard_number','','<>')
		->condition('s.profession_major','0','<>')
		->condition('s.pass_round1_major','0','<>')
		->where($valins)
		->countQuery()->execute()->fetchField();
	
	$output .= '<p>'.t('There are !num students which have been marked as enrolled into 2nd round examination.', array('!num'=>$total_students)).'</p>';
	$header = array(
		array('data'=>t('Profession'), 'field'=>'pid', 'sort'=>'asc'),
		array('data'=>t('Number of students (%)'), 'field'=>'num'),
	);

	$query = db_select('students','s')->condition('s.idcard_number','','<>')->condition('s.pass_round1_major','0','<>');
	$query->innerJoin('vl_professions','p','s.profession_major = p.pid');
	$query->addExpression('COUNT(*)', 'num');
	$query = $query->where($valins)
		->fields('p',array('pid','uid','pname','pnamememo'))
		->groupBy('s.profession_major')
		->extend('TableSort')->orderByHeader($header);
	
	$rdbo = $query->execute();
	$rows=array();
	
	foreach($rdbo as $r) {
		if($r->pid) {
	       // Determine whether you are plain department
	       if(user_access('view own draft') && !user_access('view draft'))
	       	   if($GLOBALS['user']->name !== $r->uid) continue;
		   $rows[] = array(
			'<nobr>'.l($r->pname, 'signup/2ndround/profession/'.$r->pid, array(
			  'title' => t('Click to view the details of @prof profession', array('@prof'=>$r->pname)),
			  )
			).'</nobr>',
			sprintf('<img src="/%s/red-dot.png" style="width:%dpx; height:10px;"/> %d (%.1f%%)', drupal_get_path('module','signup'), $r->num, $r->num, $r->num/$total_students*100),
		   );
		}
	}
	$output .= theme('table', array('header'=>$header, 'rows'=>$rows));
	
	$output .= '</div>';
	
	setcookie('examplace', NULL, 0, '/');
	return $output;
}

function signup_2nd_round_by_profession_detail($prof=NULL) {
	
	$query=db_select('vl_professions','p')->fields('p',array('pname'))->condition('p.pid',$prof);
	$query->innerJoin('vl_department','d','p.did=d.did');
	$query=$query->fields('d',array('dname'));
	$r=$query->execute()->fetchObject();
	$profession_major = t('!dname!pname', array(
  	  	  '!dname' => $r->dname,
  	  	  '!pname' => $r->pname,
  	));

	drupal_set_title(t('By Profession').' - '.$r->pname);
  
	if(db_select('students','s')->fields('s')->condition('s.validated',1)->condition('s.pass_round1_major','0','<>')->countQuery()->execute()->fetchField() >0)
		$valins="s.validated=1 ";
	else 
		$valins="1";

  if($prof)
  	$sql_department_insert = "p.pid='".$prof."'";
  else
  	$sql_department_insert = '1';
  $output = '<div id="baoming_user_list" class="baoming_view_section node">';
  
  $r=db_select('vl_city_district','cd')->fields('cd',array('cid','name'))->condition('cd.cid','110000')->execute()->fetchObject();
  $options=array('000000'=>t('All students'));
  $options+=array((string)($r->cid)=>$r->name);

  $rows = array();
  $header = array(
  	array('data' =>t('Student ID'), 'field'=>'s.uid', 'sort'=>'desc'),
  	array('data' =>t('Real Name')),
  	array('data' =>t('Gender'), 'field'=>'s.gender'),
  	array('data' =>t('Profession'), 'field'=>'s.profession_major'),
  	array('data' =>t('Province'), 'field'=>'gk.province'),
  	array('data' =>t('Personnel record'), 'field'=>'personnel_record_at'),
  );
  
  //$tablesort = tablesort_sql($header);
  //var_dump($cookie_examplace);
  $query=db_select('students','s')->condition('s.idcard_number','','<>')->fields('s')->condition('p.pid',$prof);
  $query->leftJoin('students_gk','gk','s.uid=gk.uid');
  $query->leftJoin('students_contact','c','s.uid=c.uid');
  $query->innerJoin('vl_professions','p','s.profession_major=p.pid');
  $query->innerJoin('users','u','s.uid=u.name');
  $query->addExpression('u.uid', 'sys_uid');
  $query = $query->fields('c', array('personnel_record_at'))
  	  		->fields('gk')
  	  		->where($sql_department_insert)->where($valins)->condition('s.pass_round1_major','0','<>')
			->extend('TableSort')->orderByHeader($header)
			->extend('PagerDefault')->limit(20);
  //var_dump($query->__toString());
  $rdbo=$query->execute();
  if(count($rdbo)==0) {
  	  $rows[][] = array('data'=> t('N/A'), 'colspan'=>(string)count($header));
  }
  else
  foreach($rdbo as $r) {
  	  switch($r->ucategory) {
  	  	  case uc_OWN_STUDENT:
  	  	  	  $province = t('Our own student');
  	  	  	  $per = t('Our own student');
  	  	  	  $plink = '000000';
  	  	  	  break;
  	  	  case uc_MAINLAND_STUDENT:
  	  	  case uc_HKTW_STUDENT:
  	  	  	  $province = $r->province ? db_select('vl_province','p')->fields('p',array('simplified_name'))->condition('p.pid',$r->province)->execute()->fetchField() : t('N/A');
  	  	  	  $per = $r->personnel_record_at;
  	  	  	  if(!$per) $per=t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  	  case uc_OVERSEA_STUDENT:
  	  	  	  $province = db_select('vl_city_district','cd')->fields('cd',array('name'))->condition('cd.cid',$r->city_district)->execute()->fetchField();
  	  	  	  $per = t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  }
  	  
  	  
  	  $rows[] = array(
  	  	'<nobr>'.l($r->uid, 'user/'.$r->sys_uid).'</nobr>',
  	  	'<nobr>'.$r->name.'</nobr>',
  	  	$r->gender == 1 ? t('Male'): t('Female'),
  	  	l($profession_major, 'signup/2ndround/profession/'.$r->profession_major, array(
		  'title' => t(
		    'Click to view the details of @prof', array(
		    '@prof' => $profession_major)
		  ))
		),
  	  	$province,
  	  	$per,
  	  );
  }
  
  $output .= theme('table', array('header'=>$header, 'rows'=>$rows));
  $output .= theme('pager');
  $output .= "</div>";
  
  $output .= l(t('<< Back to full student list'), 'signup/2ndround');
  
  return $output;
}

function signup_3rd_round_by_profession() {
	$output = '<div id="baoming_user_stat" class="baoming_view_section node">';
	
	if(db_select('students','s')->fields('s')->condition('s.validated',1)->countQuery()->execute()->fetchField() >0)
		$valins="s.validated=1 ";
	else 
		$valins="1";
		
	// Compute total number of registered students.
	$total_students=db_select('students','s')
		->fields('s')
		->condition('s.idcard_number','','<>')
		->condition('s.profession_major','0','<>')
		->condition('s.pass_round3_major','0','<>')
		->where($valins)
		->countQuery()->execute()->fetchField();
	
	$output .= '<p>'.t('There are currently !num students marked as being enrolled into the 3rd round examination.', array('!num'=>$total_students)).'</p>';
	$students_mainland=db_select('students','s')->fields('s')->condition('s.pass_round3_major','0','<>')->condition('s.ucategory',1)->countQuery()->execute()->fetchField();
	$students_determined=db_select('students','s')->fields('s')->condition('s.pass_round3_major','10')->condition('s.ucategory',1)->countQuery()->execute()->fetchField();
	$students_tobe_determined=db_select('students','s')->fields('s')->condition('s.pass_round3_major','1')->condition('s.ucategory',1)->countQuery()->execute()->fetchField();
	$output .= '<p>'.t('Out of !total mainland students, there are !determ determined students, !tobedeterm to-be-determined students.', array('!total'=>$students_mainland, '!determ'=>$students_determined, '!tobedeterm'=>$students_tobe_determined)).'</p>';
	$header = array(
		array('data'=>t('Profession'), 'field'=>'pid', 'sort'=>'asc'),
		array('data'=>t('Number of students (%)'), 'field'=>'num'),
	);

	$query = db_select('students','s')->condition('s.idcard_number','','<>')->condition('s.pass_round3_major','0','<>');
	$query->innerJoin('vl_professions','p','s.profession_major = p.pid');
	$query->addExpression('COUNT(*)', 'num');
	$query = $query->where($valins)
		->fields('p',array('pid','uid','pname','pnamememo'))
		->groupBy('s.profession_major')
		->extend('TableSort')->orderByHeader($header);
	
	$rdbo = $query->execute();
	$rows=array();
	
	foreach($rdbo as $r) {
		if($r->pid) {
	       // Determine whether you are plain department
	       if(user_access('view own draft') && !user_access('view draft'))
	       	   if($GLOBALS['user']->name !== $r->uid) continue;
		   $rows[] = array(
			'<nobr>'.l($r->pname, 'signup/3rdround/profession/'.$r->pid, array(
			  'title' => t('Click to view the details of @prof profession', array('@prof'=>$r->pname)),
			  )
			).'</nobr>',
			sprintf('<img src="/%s/red-dot.png" style="width:%dpx; height:10px;"/> %d (%.1f%%)', drupal_get_path('module','signup'), $r->num, $r->num, $r->num/$total_students*100),
		   );
		}
	}
	$output .= theme('table', array('header'=>$header, 'rows'=>$rows));
	
	$output .= '</div>';
	
	setcookie('examplace', NULL, 0, '/');
	return $output;
}

function signup_3rd_round_by_profession_detail($prof=NULL) {
	
	$query=db_select('vl_professions','p')->fields('p',array('pname'))->condition('p.pid',$prof);
	$query->innerJoin('vl_department','d','p.did=d.did');
	$query=$query->fields('d',array('dname'));
	$r=$query->execute()->fetchObject();
	$profession_major = t('!dname!pname', array(
  	  	  '!dname' => $r->dname,
  	  	  '!pname' => $r->pname,
  	));

	drupal_set_title(t('By Profession').' - '.$r->pname);
  
	if(db_select('students','s')->fields('s')->condition('s.validated',1)->condition('s.pass_round3_major','0','<>')->countQuery()->execute()->fetchField() >0)
		$valins="s.validated=1 ";
	else 
		$valins="1";

  if($prof)
  	$sql_department_insert = "p.pid='".$prof."'";
  else
  	$sql_department_insert = '1';
  $output = '<div id="baoming_user_list" class="baoming_view_section node">';
  
  $r=db_select('vl_city_district','cd')->fields('cd',array('cid','name'))->condition('cd.cid','110000')->execute()->fetchObject();
  $options=array('000000'=>t('All students'));
  $options+=array((string)($r->cid)=>$r->name);

  $rows = array();
  $header = array(
  	array('data' =>t('Student ID'), 'field'=>'s.uid'),
  	array('data' =>t('Real Name')),
  	array('data' =>t('Gender'), 'field'=>'s.gender'),
  	array('data' =>t('Profession'), 'field'=>'s.profession_major'),
  	array('data' =>t('Status'), 'field'=>'s.pass_round3_major', 'sort'=>'desc'),
  	array('data' =>t('Province'), 'field'=>'gk.province'),
  );
  
  //$tablesort = tablesort_sql($header);
  //var_dump($cookie_examplace);
  $query=db_select('students','s')->condition('s.idcard_number','','<>')->fields('s')->condition('p.pid',$prof);
  $query->leftJoin('students_gk','gk','s.uid=gk.uid');
  $query->leftJoin('students_contact','c','s.uid=c.uid');
  $query->innerJoin('vl_professions','p','s.profession_major=p.pid');
  $query->innerJoin('users','u','s.uid=u.name');
  $query->innerJoin('students_total_score','ts','ts.uid=s.uid');
  $query->addExpression('u.uid', 'sys_uid');
  $query = $query->fields('c', array('personnel_record_at'))
  	  		->fields('gk')
  	  		->fields('ts',array('outrank'))
  	  		->where($sql_department_insert)->where($valins)->condition('s.pass_round3_major','0','<>')
			->extend('TableSort')->orderByHeader($header)->orderBy('ts.outrank')
			->extend('PagerDefault')->limit(20);
  //var_dump($query->__toString());
  $rdbo=$query->execute();
  if(count($rdbo)==0) {
  	  $rows[][] = array('data'=> t('N/A'), 'colspan'=>(string)count($header));
  }
  else
  foreach($rdbo as $r) {
  	  switch($r->ucategory) {
  	  	  case uc_OWN_STUDENT:
  	  	  	  $province = t('Our own student');
  	  	  	  $per = t('Our own student');
  	  	  	  $plink = '000000';
  	  	  	  break;
  	  	  case uc_MAINLAND_STUDENT:
  	  	  case uc_HKTW_STUDENT:
  	  	  	  $province = $r->province ? db_select('vl_province','p')->fields('p',array('simplified_name'))->condition('p.pid',$r->province)->execute()->fetchField() : t('N/A');
  	  	  	  $per = $r->personnel_record_at;
  	  	  	  if(!$per) $per=t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  	  case uc_OVERSEA_STUDENT:
  	  	  	  $province = db_select('vl_city_district','cd')->fields('cd',array('name'))->condition('cd.cid',$r->city_district)->execute()->fetchField();
  	  	  	  $per = t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  }
  	  
  	  
  	  $rows[] = array(
  	  	'<nobr>'.l($r->uid, 'user/'.$r->sys_uid).'</nobr>',
  	  	'<nobr>'.$r->name.'</nobr>',
  	  	$r->gender == 1 ? t('Male'): t('Female'),
  	  	l($profession_major, 'signup/3rdround/profession/'.$r->profession_major, array(
		  'title' => t(
		    'Click to view the details of @prof', array(
		    '@prof' => $profession_major)
		  ))
		),
		$r->pass_round3_major==1?t('To be determined').'/'.$r->outrank:t('Determined'),
  	  	(user_access('signup_3rd_overview'))?l($province, 'signup/3rdround/province/'.$plink):($province),
  	  );
  }
  
  $output .= theme('table', array('header'=>$header, 'rows'=>$rows));
  $output .= theme('pager');
  $output .= "</div>";
  
  $output .= l(t('<< Back to full student list'), 'signup/3rdround');
  
  return $output;
}

function signup_3rd_round_by_province() {

	$prof=arg(3);
	if(db_select('students','s')->fields('s')->condition('s.validated',1)->countQuery()->execute()->fetchField() >0)
		$valins="s.validated=1 ";
	else 
		$valins="1";

	// Compute total number of registered students.
	$total_students=db_select('students','s')
		->fields('s')
		->condition('s.idcard_number','','<>')
		->condition('s.profession_major','0','<>')
		->condition('s.pass_round3_major','0','<>')
		->where($valins)
		->countQuery()->execute()->fetchField();
	
	$output = '<p>'.t('There are currently !num students marked as being enrolled into the 3rd round examination.', array('!num'=>$total_students)).'</p>';
	$header = array(
		array('data'=>t('Province'), 'field'=>'pid', 'sort'=>'asc'),
		array('data'=>t('Number of students'), 'field'=>'num'),
	);
	$query = db_select('students','s')->condition('s.idcard_number','','<>')->condition('s.profession_major','0', '<>')->condition('s.pass_round3_major','0','<>');
	$query->leftJoin('students_gk','sg','s.uid=sg.uid');
	$query->leftJoin('vl_province','p','sg.province=p.pid');
	$query = $query->fields('s',array('ucategory','uid'))
		->fields('p',array('pid','name'));
	$query->addExpression('COUNT(s.uid)', 'num');
	$query = $query->where($valins)
		->groupBy('p.pid')
		->groupBy('s.ucategory')
		->extend('TableSort')->orderByHeader($header);
	
	$rdbo = $query->execute();
	$rows=array();
	
	foreach($rdbo as $r) {
		if($r->pid) {
	       // Determine whether you are plain department
	       if(user_access('view own draft') && !user_access('view draft'))
	       	   if($GLOBALS['user']->name !== $r->uid) continue;
		   $rows[] = array(
			'<nobr>'.l('<img src="/'.drupal_get_path('module','signup').'/download.png">', 'signup/3rdround/province/'.$r->pid.'/download', array('html'=>TRUE,'attributes'=>array('title'=>t('Download standard database for this province')))).' '.
			   l('<img src="/'.drupal_get_path('module','signup').'/printer.png">', 'signup/3rdround/province/'.$r->pid.'/report', array('html'=>TRUE,'attributes'=>array('title'=>t('Download printable report for this province')))).' '.
			   l($r->name, 'signup/3rdround/province/'.$r->pid, array(
			  'title' => t('Click to view the details of @prov province', array('@prov'=>$r->name)),
			  )
			).'</nobr>',
			sprintf('<img src="/%s/red-dot.png" style="width:%dpx; height:10px;"/> %d (%.1f%%)', drupal_get_path('module','signup'), $r->num, $r->num, $r->num/$total_students*100),
		   );
		} else if($r->ucategory==='0') {
	       $rows[] = array(
	       	   l(t('Our own student'), 'signup/3rdround/province/000000', array(
	       	     'title' => t('Click to view the details of students from @province', array('@province'=>t('Our own student'))),
	       	   )),
			   sprintf('<img src="/%s/red-dot.png" style="width:%dpx; height:10px;"/> %d (%.1f%%)', drupal_get_path('module','signup'), $r->num, $r->num, $r->num/$total_students*100),
	       );
		}

	}
	
  	$output .= theme('table', array('header'=>$header, 'rows'=>$rows));

	return $output;
	
}

function signup_3rd_round_by_province_detail($prov=NULL) {
	
	$query=db_select('vl_province','p')->fields('p',array('name'))->condition('p.pid',$prov);
	$r=$query->execute()->fetchObject();

	drupal_set_title(t('By Province').' - '.$r->name);
  
	if(db_select('students','s')->fields('s')->condition('s.validated',1)->countQuery()->execute()->fetchField() >0)
		$valins="s.validated=1 ";
	else 
		$valins="1";
	
	$output = '';
	
  $output = '<div id="baoming_user_list" class="baoming_view_section node">';
  
  $rows = array();
  $header = array(
  	array('data' =>t('IDCard number'), 'field'=>'s.idcard_number', 'sort'=>'asc'),
  	array('data' =>t('Real Name')),
  	array('data' =>t('Gender'), 'field'=>'s.gender'),
  	array('data' =>t('Profession'), 'field'=>'s.profession_major'),
  	array('data' =>t('Status'), 'field'=>'s.pass_round3_major'),
  	array('data' =>t('Province'), 'field'=>'gk.province'),
  );

  if($prov=='000000')
	$provcondition='s.ucategory = 0';
  else
	$provcondition="gk.province='".$prov."'";
  
  //$tablesort = tablesort_sql($header);
  $query=db_select('students','s')->condition('s.idcard_number','','<>')->fields('s');
  $query->leftJoin('students_gk','gk','s.uid=gk.uid');
  $query->leftJoin('students_contact','c','s.uid=c.uid');
  $query->innerJoin('vl_professions','p','s.profession_major=p.pid');
  $query->innerJoin('users','u','s.uid=u.name');
  $query->addExpression('u.uid', 'sys_uid');
  $query = $query->fields('c', array('personnel_record_at'))
  	  		->fields('gk')
  	  		->fields('p',array('pname'))
  	  		->where($provcondition)->where($valins)->condition('s.pass_round3_major','0','<>')
			->extend('TableSort')->orderByHeader($header)
			->extend('PagerDefault')->limit(20);
  $rdbo=$query->execute();
  if(count($rdbo)==0) {
  	  $rows[][] = array('data'=> t('N/A'), 'colspan'=>(string)count($header));
  }
  else
  foreach($rdbo as $r) {
  	  switch($r->ucategory) {
  	  	  case uc_OWN_STUDENT:
  	  	  	  $province = t('Our own student');
  	  	  	  $per = t('Our own student');
  	  	  	  $plink = '000000';
  	  	  	  break;
  	  	  case uc_MAINLAND_STUDENT:
  	  	  case uc_HKTW_STUDENT:
  	  	  	  $province = $r->province ? db_select('vl_province','p')->fields('p',array('simplified_name'))->condition('p.pid',$r->province)->execute()->fetchField() : t('N/A');
  	  	  	  $per = $r->personnel_record_at;
  	  	  	  if(!$per) $per=t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  	  case uc_OVERSEA_STUDENT:
  	  	  	  $province = db_select('vl_city_district','cd')->fields('cd',array('name'))->condition('cd.cid',$r->city_district)->execute()->fetchField();
  	  	  	  $per = t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  }
  	  
  	  
  	  $rows[] = array(
  	  	'<nobr>'.l($r->idcard_number, 'user/'.$r->sys_uid).'</nobr>',
  	  	'<nobr>'.$r->name.'</nobr>',
  	  	$r->gender == 1 ? t('Male'): t('Female'),
  	  	l($r->pname, 'signup/3rdround/profession/'.$r->profession_major, array(
		  'title' => t(
		    'Click to view the details of @prof', array(
		    '@prof' => $r->pname)
		  ))
		),
		$r->pass_round3_major==1?t('To be determined'):t('Determined'),
  	  	(user_access('signup_3rd_overview'))?l($province, 'signup/3rdround/province/'.$plink):($province),
  	  );
  }
  
  $output .= l('<img src="/'.drupal_get_path('module','signup').'/download.png" style="vertical-align: bottom">'.t('Download database'), 'signup/3rdround/province/'.$prov.'/download', array('html'=>TRUE,'attributes'=>array('title'=>t('Download standard database for this province'))));
  //$output .= l('<img src="/'.drupal_get_path('module','signup').'/download.png" style="vertical-align: bottom">'.t('Download database'), 'signup/3rdround/province/'.$prov.'/download', array('html'=>TRUE,'attributes'=>array('title'=>t('Download standard database for this province'))));
  $output .= '&nbsp;';
  $output .= l('<img src="/'.drupal_get_path('module','signup').'/printer.png" style="vertical-align: bottom">'.t('Print Report'), 'signup/3rdround/province/'.$prov.'/report', array('html'=>TRUE,'attributes'=>array('title'=>t('Download printable report for this province'))));
  $output .= '<p/>';
  $output .= theme('table', array('header'=>$header, 'rows'=>$rows));
  $output .= theme('pager');
  $output .= "</div>";
  
  $output .= l(t('<< Back to full student list'), 'signup/3rdround/province');
  return $output;
}

function signup_3rd_round_by_province_download($prov) {
	$r=db_select('vl_province','p')->fields('p')->condition('p.pid',$prov)->execute()->fetchObject();
	if(!isset($r) || !($r->name))
		drupal_access_denied();
	$provname=$r->simplified_name;
	
	$def = array(
	  array("KSH",		"C",	14),
	  array("XM",		"C",	24),
	  array("XBDM",		"C",	1),
	  array("SFZH",		"C",	18),
	  array("BYXXMC",	"C",	20),
	  array("YXDM",		"C",	5),
	  array("YXMC",		"C",	40),
	  array("CCDM",		"C",	1),
	  array("ZYDM",		"C",	6),
	  array("ZYMC",		"C",	30),
	  array("STKKM",	"C",	30),
	  array("STKCSF",	"N",	7,3),
	  array("YXKSKKM",	"C",	30),
	  array("YXKSCSF",	"N",	7,3),
	  array("YXZYMC",	"N",	4,0),
	  array("YXKSDD",	"C",	30),
	  array("BZ",		"C",	60),
	);

	// creation
	$fname=tempnam(sys_get_temp_dir(),'3rd').'.dbf';
	unlink($fname);
	$fhandle=dbase_create($fname, $def);
	if (!$fhandle) {
	  return NULL;
	}
	$query=db_select('students','s')->condition('s.pass_round3_major','0','<>');
	$query->innerJoin('vl_professions','p','s.profession_major=p.pid');
	$query->leftJoin('students_contact','sc','s.uid=sc.uid');
	$query->leftJoin('students_gk','sg','s.uid=sg.uid');
	if(db_table_exists('students_total_score')) {
		$query->innerJoin('students_total_score','ss','s.uid=ss.uid');
		$query=$query->fields('ss',array('total_score','rank'));
	}
	$query=$query->condition('sg.province',$prov)
		->fields('s',array('name','idcard_number','gender'))
		->fields('sc',array('personnel_record_at'))
		->fields('sg',array('sid'))
		->fields('p',array('pname','gb_pid','gb_pname'))
		->orderBy('s.idcard_number');
	$result=$query->execute();
	
	// If there is no any record, output 404 error.
	if($query->countQuery()->execute()->fetchField()==0) {
		//var_dump($query->countQuery()->execute()->fetchField());
		return MENU_NOT_FOUND;
	}
		
	foreach($result as $r) {
		//var_dump($r);
		$t=dbase_add_record ($fhandle, array(
			($r->sid)?$r->sid:'',
			mb_convert_encoding($r->name, 'GBK', 'UTF-8'),
			$r->gender,
			$r->idcard_number,
			mb_convert_encoding($r->personnel_record_at, 'GBK', 'UTF-8'),
			'10045',
			mb_convert_encoding('中央音乐学院', 'GBK', 'UTF-8'),
			'1',
			$r->gb_pid,
			mb_convert_encoding($r->gb_pname, 'GBK', 'UTF-8'),
			'',
			0,
			mb_convert_encoding($r->pname, 'GBK', 'UTF-8'),
			isset($r->total_score)?abs(round($r->total_score,3)):0,
			isset($r->rank)?$r->rank:0,
			mb_convert_encoding('中央音乐学院', 'GBK', 'UTF-8'),
			($r->total_score<0)?mb_convert_encoding('校考成绩列为考生平均排名，非成绩。有关内容由我院向考生解释。', 'GBK', 'UTF-8'):'',
		));
		if(!$t) return NULL;
	}
	dbase_close($fhandle);

	drupal_add_http_header('Content-type', 'application/x-dbase; charset=utf-8', TRUE);
	drupal_add_http_header('Content-Transfer-Encoding', 'binary', TRUE);

	$ua = $_SERVER["HTTP_USER_AGENT"];

	$filename = '10045-'.$provname.".dbf";
	$encoded_filename = urlencode($filename);

	if (preg_match("/MSIE/", $ua)) {
		drupal_add_http_header('Content-Disposition', 'attachment; filename="' . $encoded_filename . '"');
	} else if (preg_match("/Firefox/", $ua)) {
		drupal_add_http_header('Content-Disposition', 'attachment; filename*="utf8\'\'' . $filename . '"');
	} else {
		drupal_add_http_header('Content-Disposition', 'attachment; filename="' . $filename . '"');
	}

	drupal_add_http_header('Content-Length', filesize($fname));
	readfile($fname);
	unlink($fname);
}

function signup_3rd_round_by_province_report($prov=NULL) {
	$r=db_select('vl_province','p')->fields('p')->condition('p.pid',$prov)->execute()->fetchObject();
	if(!isset($r) || !($r->name))
		drupal_access_denied();
	$provname=$r->name;
	//var_dump($provname); exit;
	
	$query=db_select('students','s')->condition('s.pass_round3_major','0','<>');
	$query->innerJoin('vl_professions','p','s.profession_major=p.pid');
	$query->leftJoin('students_contact','sc','s.uid=sc.uid');
	$query->leftJoin('students_gk','sg','s.uid=sg.uid');
	$query->leftJoin('vl_city_district','c','sg.city_district=c.cid');
	if(db_table_exists('students_total_score')) {
		$query->innerJoin('students_total_score','ss','s.uid=ss.uid');
		$query=$query->fields('ss',array('total_score','rank'));
	}
	$query=$query->condition('sg.province',$prov)
		->fields('s',array('name','idcard_number','gender'))
		->fields('sc',array('personnel_record_at'))
		->fields('sg',array('sid'))
		->fields('c',array('name_simp'))
		->fields('p',array('pname','gb_pid','gb_pname','years'))
		->orderBy('s.idcard_number');
	$result=$query->execute();
	
	// If there is no any record, output 404 error.
	if($query->countQuery()->execute()->fetchField()==0) {
		//var_dump($query->countQuery()->execute()->fetchField());
		return MENU_NOT_FOUND;
	}
	
	//var_dump($account);
	require_once(drupal_get_path('module','signup').'/../tcpdf/config/lang/eng.php');
	require_once(drupal_get_path('module','signup').'/../tcpdf/tcpdf.php');
	
	ini_set('max_execution_time','300');

	// Extend the TCPDF class to create custom Header and Footer
	class MYPDF extends TCPDF {

	    //Page header
	    public function Header() {
	    	$this->setHeaderMargin(30);
	    	$this->SetX(10);
	    	$this->SetY(8);
	        // Set font
	        $this->SetFont('droidsansfallback', 'B', 24, '', true);
	        // Title
	        $this->Cell(0, 10, $this->header_title, 0, false, 'C', 0, '', 0, false, 'M', 'M');
	        $this->SetFont('droidsansfallback', 'B', 10, '', true);
	    	$this->SetX(1);
	    	$this->SetY(18);
	        $this->Cell(10, 2, '序号',0, false, 'C');
	        $this->Cell(40, 2, '身份证号码',0, false, 'C');
	        $this->Cell(30, 2, '考生号',0, false, 'C');
	        $this->Cell(20, 2, '姓名',0, false, 'C');
	        $this->Cell(5, 2, '性别',0, false, 'C');
	        $this->Cell(60, 2, '所在学校',0, false, 'C');
	        $this->Cell(13, 2, '专业代码',0, false, 'C');
	        $this->Cell(33, 2, '专业名称',0, false, 'C');
	        //$this->Cell(, 2, '计划代码',1, false, 'C');
	        $this->Cell(22, 2, '专业方向',0, false, 'C');
	        $this->Cell(12, 2, '术科成绩',0, false, 'C');
	        $this->Cell(10, 2, '排名',0, false, 'C');
	        $this->Cell(20, 2, '户口所在地',0, false, 'C');
	        $this->Line(5,24,292,24,array('width'=>0.5));
	    }

	    // Page footer
	    public function Footer() {
	        // Position at 15 mm from bottom
	        $this->SetY(-13);
	        $this->SetX(5);
	        $this->Line(5,198,292,198,array('width'=>0.5));
	        // Set font
	        // Page number
	        $this->SetFont('droidsansfallback', 'B', 11, '', true);
	        $this->Cell(30, 12, date('Y年n月j日'));
	        $this->Cell(220,12, '院校名称:10045中央音乐学院    注:我院面向全国招生，文理兼收，不做分省计划。成绩带括号者为其平均序，非直接成绩。', 0, false, 'C');
	        $this->Cell(52, 12, '第'.$this->getAliasNumPage().'页，共'.$this->getAliasNbPages().'页', 0, false, 'R', 0, '', 0, false, 'T', 'M');
	    }
	}
	// create new PDF document
	$pdf = new MYPDF('L', PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

	// set document information
	$pdf->SetCreator(PDF_CREATOR);

	// Set font
	// dejavusans is a UTF-8 Unicode font, if you only need to
	// print standard ASCII chars, you can use core fonts like
	// helvetica or times to reduce file size.
	$pdf->SetFont('droidsansfallback', 'B', 14, '', true);
	// set default font subsetting mode
	$pdf->setFontSubsetting(false);
	$pdf->setHeaderMargin(30);
	$pdf->SetMargins(5, 27, 5);
	$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
	$pdf->SetFooterMargin(15);
	$pdf->setHeaderData('',0,variable_get('zhaoban_current_year',date('Y')).'年中央音乐学院本科招生考试合格考生名册 '.$provname,'');
	
	//$pdf->SetMargins(6, 6, 6);
	$pdf->SetAutoPageBreak(true, 12);

	//set some language-dependent strings
	$pdf->setLanguageArray($l);

	// ---------------------------------------------------------

	// Add a page
	// This method has several options, check the source code documentation for more information.
	$pdf->AddPage();
	$pdf->SetFillColor(216,216,216);
	$pdf->SetDrawColor(255,255,255);
	$pdf->SetLineWidth(0.5);
	
	$pdf->SetFontSize(10);
	
	$pdf->SetFillColor(0,0,0);
	$pdf->SetTextColor(255,255,255);
	//$pdf->Cell(10,2,'1',0, false, 'C',true);
	$i=1;
	foreach($result as $r) {
		$pdf->SetFillColor(0,0,0);
		$pdf->SetTextColor(255,255,255);
		$pdf->Cell(10,2,$i++, 0, false, 'C',true);
		
		$pdf->SetTextColor(0,0,0);
		$pdf->Cell(40,2,$r->idcard_number, 0, false, 'C');
		$pdf->Cell(30,2,$r->sid, 0, false, 'C');
		$pdf->Cell(20,2,$r->name, 0, false, 'L');
		$pdf->Cell(5,2,$r->gender==1?'男':'女', 0, false, 'C');
		$pdf->Cell(60,2,$r->personnel_record_at, 0, false, 'L');
		$pdf->Cell(13,2,$r->gb_pid, 0, false, 'L');
		$pdf->Cell(33,2,$r->gb_pname, 0, false, 'L');
		$pdf->Cell(22,2,$r->pname, 0, false, 'L');
		$pdf->Cell(12,2,$r->total_score<=0?('['.abs(round($r->total_score,2)).']'):number_format($r->total_score,2));
		//$pdf->Cell(12,2,'100.00');
		//$pdf->Cell(10,2,$r->years, 0, false, 'C');
		$pdf->Cell(10,2,$r->rank, 0, false, 'C');
		$pdf->Cell(20,2,$r->name_simp);
		$pdf->LN();
		$pdf->setY($pdf->getY()+3);
	}
	$pdf->SetFontSize(20);
	$pdf->Cell(0,15,'·   以下无正文   ·   以下无正文   ·   以下无正文   ·   以下无正文   ·   以下无正文   ·   以下无正文   ·',0, false, 'C');
	$pdf->SetDisplayMode('fullwidth');
	$pdf->Output('3rd_round_report.pdf', 'I');
}

function signup_preset_passthrough() {
	$rows = array();
	$form = array();
	$header = array(
		'idnumber' => array('data' =>t('IDCard number'), 'field'=>'s.idcard_number'),
		'profession' => array('data' =>t('Profession'), 'field'=>'s.pid', 'sort'=>'asc'),
		'status' => array('data' =>t('Status')),
	);
	$options=array();
	$query=db_select('students_passthrough','s')->fields('s')->extend('TableSort')->orderByHeader($header);
	$query->innerJoin('vl_professions','p','s.pid=p.pid');
	$query=$query->fields('p');
	$result=$query->execute();
	foreach($result as $r) {
		$n='';
		$n=db_select('students','s')->fields('s',array('name'))->condition('s.idcard_number',$r->idcard_number)->execute()->fetchField();
		$query=db_select('students','s')->condition('s.idcard_number',$r->idcard_number);
		$query->innerJoin('users','u','s.uid=u.name');
		$query->fields('u',array('uid'));
		$u=$query->execute()->fetchField();
		$v=db_select('students','s')->fields('s',array('validated'))->condition('s.idcard_number',$r->idcard_number)->execute()->fetchField();
		$options[$r->idcard_number]=array(
			'idnumber' => ($n)?l($r->idcard_number.' ('.$n.')', 'user/'.$u):$r->idcard_number,
			'profession' => $r->pname,
			'status' => ($n)?(($v)?t('Confirmed'):t('Signed Up, but not confirmed')):t('Not yet signed up'),
		);
	}
	$form['deletenotify']=array(
		'#type' => 'item',
		'#title' => t('Select to delete students'),
		'#description' => t('There are !num students marked as passthrough now.',array('!num'=>count($options))),
	);
	$form['students']=array(
	    '#type' => 'tableselect',
	    '#header' => $header,
	    '#options' => $options,
	    '#attributes' => array('class'=>array('assign_students')),
	    '#empty' => t('No suitable students.'),
	);
	
	$form['add']=array(
		'#type'=>'fieldset',
		'#title'=>t('Add student'),
		'#description'=>t(''),
		'#prefix'=>'<p/>',
	);
	$form['add']['idcardnumber']=array(
		'#type' => 'textfield',
		'#title' => t('IDCard number'),
		'#required' => false,
		'#maxlength'=>18,
		'#size'=>18,
		'#prefix' => '<div class="container-inline">',
	);
	$profs=array();
	$query=db_select('vl_professions','p')->fields('p')->condition('p.enabled',1)->orderBy('pid');
	$query->innerJoin('vl_department','d','p.did=d.did');
	$query=$query->fields('d');
	$result=$query->execute();
	foreach($result as $r) {
		$profs[$r->pid]=$r->dname.' / '.$r->pname;
	}
	$form['add']['profession']=array(
		'#type' => 'select',
		'#title' => t('Profession'),
		'#required' => false,
		'#default_value'=>NULL,
		'#options'=>$profs,
		'#suffix' => '</div>',
	);
	$form['save']=array(
		'#type' => 'submit',
		'#value' => t('Save'),
		'#attributes' => array('title'=>t('Delete selected students and save newly added student')),
		'#prefix'=>'<p/>',
	);
	return $form;
}

function signup_preset_passthrough_validate($form, &$form_state) {
	// Check if specific students could be deleted, as we only allow removing students which is not signed up.
	$form_values = array_filter($form_state['values']['students']);
	if(count($form_values)>0) {
		$students=array_keys($form_values);
		if(db_select('students','s')->fields('s')->condition('s.idcard_number',$students,'IN')->countQuery()->execute()->fetchField()>0) {
			form_set_error('students', t('You have selected a signed up student, which cannot be deleted.'));
			return;
		}
	}
	
	$new_idnumber=strtoupper(trim($form_state['values']['idcardnumber']));
	$new_prof=$form_state['values']['profession'];
	// Check if the corresponding idnumber has been used.
	if(db_select('students_passthrough','s')->fields('s')->condition('s.idcard_number',$new_idnumber)->countQuery()->execute()->fetchField()>0) {
		form_set_error('idcardnumber', t('You have inputed an IDCard number which is already exists.'));
		return;
	}
	// Check if the profession we selected be same as what the student has selected.
	if(db_select('students','s')->fields('s')->condition('s.idcard_number',$new_idnumber)->condition('s.profession_major',$new_prof,'<>')->countQuery()->execute()->fetchField()>0) {
		form_set_error('profession', t('The profession you have selected is different from the profession student selected himself.'));
	}
}

function signup_preset_passthrough_submit($form, &$form_state) {
	$students=array_keys(array_filter($form_state['values']['students']));
	if(count($students)>0) {
		db_delete('students_passthrough')
			->condition('idcard_number', $students, 'IN')
			->execute();
		drupal_set_message(t('!num passthrough students have been deleted.', array('!num'=>count($students))));
	}
	$new_idnumber=strtoupper(trim($form_state['values']['idcardnumber']));
	$new_prof=$form_state['values']['profession'];
	if($new_idnumber) {
		db_insert('students_passthrough')
			->fields(array(
				'idcard_number' => $new_idnumber,
				'pid' => $new_prof,
			))->execute();
		$n=db_select('students','s')->fields('s',array('name'))->condition('s.idcard_number',$new_idnumber)->execute()->fetchField();
		drupal_set_message(t('!idnum has been marked as passthrough student.', array('!idnum'=>$new_idnumber.($n?' ('.$n.')':''))));
	}
}
	/*
function _signup_user_tab_access($user=NULL, $sec=NULL) {
	$is_student = array_key_exists('5',$user->roles);
	if($GLOBALS['user']->uid == 1) return FALSE;
	if(is_null($user)) return FALSE;
	if(!$is_student = array_key_exists('5',$user->roles)) return FALSE;
	var_dump($sec);
	switch($sec) {
		case 'profession':
			$result = db_fetch_object(db_query('SELECT s.idcard_number, s.name from {students} s WHERE s.uid = \'%s\'', $user->name));
       		if(!($result->idcard_number) || !($result->name)) return FALSE;
        		else return TRUE;
        case 'exam':
        	$result = db_fetch_object(db_query('SELECT s.profession_major from {students} s WHERE s.uid = \'%s\'', $user->name));
			if($result->profession_major == '0') return FALSE;
			else return TRUE;
		case 'contact':
			$result = db_result(db_query('SELECT MAX(sg.opus) FROM {students_going} sg WHERE sg.uid=\'%s\'', $user->name));
			if(!$result) return FALSE;
			else return TRUE;
		case 'gaokao':
	        $ucategory=db_result(db_query('SELECT ucategory FROM {students} WHERE uid=\'%s\'', $user->name));
			if(($ucategory == 0 ) || ($ucategory == 3)) return FALSE;
			$result = db_result(db_query('SELECT contact_phone FROM {students_contact} WHERE uid=\'%s\'', $user->name));
        	if(!$result) return FALSE;
        	else if(_signup_user_tab_access($user, 'contact')) return TRUE;
        	else return FALSE;
		default: return FALSE;
	}
	return TRUE;
}




function signup_user($op, &$edit, &$account, $category = NULL) {
	
	$is_student = FALSE;
	if(($account->roles)) $is_student = array_key_exists('5',$account->roles);
	switch($op) {
		case 'view': return signup_user_view($account);
		case 'categories': return signup_categories();
		case 'form':
			switch($category) {
				case signup_user_PROFESSION:
					return signup_user_professions_form($edit, $account);
				case signup_user_EXAM:
					return signup_user_examinations_form($edit, $account);
				case signup_user_CONTACT:
					return signup_user_contact_form($edit, $account);
				case signup_user_GAOKAO:
					return signup_user_gaokao_form($edit, $account);
				case 'account':
					return signup_user_account_form($edit, $account);
      		}
		case 'update':
			switch($category) {
				case signup_user_PROFESSION:
					signup_user_professions_form_save($edit, $account);break;
				case signup_user_EXAM:
					signup_user_examinations_form_save($edit, $account);break;
				case signup_user_CONTACT:
					signup_user_contact_form_save($edit, $account);break;
				case signup_user_GAOKAO:
					signup_user_gaokao_form_save($edit, $account);break;
				case 'account':
					signup_user_account_form_save($edit, $account);break;
				default: return;
			}
			watchdog('user','!user modified !sid\'s information.',
				array(
					'!user'=>$GLOBALS['user']->name,
					'!sid'=>$account->name
				)
			);
			signup_user_view($account);
			break;
		case 'validate':
			switch($category) {
				case signup_user_PROFESSION:
					signup_user_professions_form_validate($edit, $account);break;
				case signup_user_EXAM:
					signup_user_examinations_form_validate($edit, $account);break;
				case signup_user_CONTACT:
					signup_user_contact_form_validate($edit, $account);break;
				case signup_user_GAOKAO:
					signup_user_gaokao_form_validate($edit, $account);break;
				case 'account':
					signup_user_account_form_validate($edit, $account);break;
			}
			break;
		case 'delete':
			db_query('DELETE FROM {students} WHERE uid=\'%s\'', $account->name);
			db_query('DELETE FROM {students_gk} WHERE uid=\'%s\'', $account->name);
			db_query('DELETE FROM {students_contact} WHERE uid=\'%s\'', $account->name);
			db_query('DELETE FROM {students_going} WHERE uid=\'%s\'', $account->name);
			break;
	}
}

//function signup_categories($user) {
function signup_categories() {
        $data = array();
        $r =signup_progress_FINISH;
        switch($r) {
                case signup_progress_FINISH:
                case signup_progress_GAOKAO:
                        $data[3] = array('name' => signup_user_GAOKAO, 'title' => t('Gaokao'), 'weight' => 13,
                			'access callback' => '_signup_user_tab_access', 'access arguments'=>array(1,'gaokao'));
                case signup_progress_CONTACT:
                        $data[2] = array('name' => signup_user_CONTACT, 'title' => t('Contact Detail'), 'weight' => 12, 
                			'access callback' => '_signup_user_tab_access', 'access arguments'=>array(1,'contact'));
                case signup_progress_EXAM:
                        $data[1] = array('name' => signup_user_EXAM, 'title' => t('Examinations'), 'weight' => 11, 
                			'access callback' => '_signup_user_tab_access', 'access arguments'=>array(1,'exam'));
                case signup_progress_PROFESSION:
                        $data[0] = array('name' => signup_user_PROFESSION, 'title' => t('Sign up Professions'), 'weight' => 10,
                			'access callback' => '_signup_user_tab_access', 'access arguments'=>array(1,'profession'));
        }
        ksort($data);
        return $data;
}


function _signup_overview_by_province_detail($prov=NULL) {

  if(db_result(db_query('SELECT count(*) FROM {students} WHERE validated=1'))>0)
	$valins=" AND s.validated=1 ";
	
  if ($prov=='000000')
    $sql_department_insert .= "AND s.ucategory='0'";
  else
    $sql_department_insert .= "AND gk.province='".$prov."'";
  $output = '<div id="baoming_user_list" class="baoming_view_section node">';
  $rows = array();
  $header = array(
  	array('data' =>t('Student ID'), 'field'=>'s.uid', 'sort'=>'desc'),
  	array('data' =>t('Real Name')),
  	array('data' =>t('Gender'), 'field'=>'s.gender'),
  	array('data' =>t('Profession'), 'field'=>'s.profession_major'),
  	array('data' =>t('Province'), 'field'=>'gk.province'),
  	array('data' =>t('Personnel record'), 'field'=>'personnel_record_at'),
  );
  
  $tablesort = tablesort_sql($header);
  $rdbo = pager_query(
  	  'SELECT s.ucategory, s.uid, s.name, s.gender, s.profession_major, gk.province, gk.city_district, IFNULL(c.personnel_record_at,\'\') AS personnel_record_at '.
  	  'FROM {students} s LEFT JOIN {students_gk} gk ON s.uid = gk.uid '.
  	  'LEFT JOIN {students_contact} c ON s.uid=c.uid '.
  	  'INNER JOIN {vl_professions} p ON s.profession_major=p.pid '.
  	  'WHERE NOT s.idcard_number = \'\' '.$sql_department_insert.$valins.$tablesort, 20);
  if(!$rdbo) {
  	  $rows[][] = array('data'=> t('N/A'), 'colspan'=>(string)count($header));
  }
  else
  while($r = db_fetch_object($rdbo)) {
  	  switch($r->ucategory) {
  	  	  case uc_OWN_STUDENT:
  	  	  	  $province = t('Our own student');
  	  	  	  $per = t('Our own student');
  	  	  	  $plink = '000000';
  	  	  	  break;
  	  	  case uc_MAINLAND_STUDENT:
  	  	  case uc_HKTW_STUDENT:
  	  	  	  $province = $r->province ? db_result(db_query('SELECT p.simplified_name FROM {vl_province} p WHERE p.pid=\'%s\'', $r->province)) : t('N/A');
  	  	  	  $per = $r->personnel_record_at;
  	  	  	  if(!$per) $per=t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  	  case uc_OVERSEA_STUDENT:
  	  	  	  $province = db_result(db_query('SELECT cd.name FROM {vl_city_district} cd WHERE cd.cid = \'%s\'', $r->city_district));
  	  	  	  $per = t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  }
  	  
	  $profession_major = t('!dname!pname', array(
  	  	  '!dname' => db_result(db_query('SELECT d.dname FROM {vl_department} d WHERE d.did=\'%s\'', substr($r->profession_major, 0, 2))),
  	  	  '!pname' => db_result(db_query('SELECT p.pname FROM {vl_professions} p WHERE p.pid=\'%s\'', $r->profession_major))));
  	  $rows[] = array(
  	  	'<nobr>'.l($r->uid, 'user/'.db_result(db_query('SELECT u.uid FROM {users} u INNER JOIN {students} s ON u.name=s.uid WHERE s.uid=\'%s\'', $r->uid))).'</nobr>',
  	  	'<nobr>'.$r->name.'</nobr>',
  	  	$r->gender == 1 ? t('Male'): t('Female'),
  	  	l($profession_major, 'signup/overview/profession/'.$r->profession_major, array(
		  'title' => t(
		    'Click to view the details of @prof', array(
		    '@prof' => $profession_major)
		  ))
		),
  	  	l($province, 'signup/overview/province/'.$plink),
  	  	$per,
  	  );
  }
  
  $output .= theme('table', $header, $rows);
  $output .= theme('pager', NULL, 20);
  $output .= "</div>";
  
  $output .= l(t('<< Back to full student list'), 'signup/overview/province');
  
  drupal_set_title(t('By Province').' - '.db_result(db_query('SELECT p.name FROM {vl_province} p WHERE p.pid=\'%s\'', $prov)));
  
  return $output;
}

function _signup_user_tab_access($user=NULL, $sec=NULL) {
	$is_student = array_key_exists('5',$user->roles);
	if($GLOBALS['user']->uid == 1) return FALSE;
	if(is_null($user)) return FALSE;
	if(!$is_student = array_key_exists('5',$user->roles)) return FALSE;
	switch($sec) {
		case 'profession':
			$result = db_fetch_object(db_query('SELECT s.idcard_number, s.name from {students} s WHERE s.uid = \'%s\'', $user->name));
       		if(!($result->idcard_number) || !($result->name)) return FALSE;
        		else return TRUE;
        case 'exam':
        	$result = db_fetch_object(db_query('SELECT s.profession_major from {students} s WHERE s.uid = \'%s\'', $user->name));
			if($result->profession_major == '0') return FALSE;
			else return TRUE;
		case 'contact':
			$result = db_result(db_query('SELECT MAX(sg.opus) FROM {students_going} sg WHERE sg.uid=\'%s\'', $user->name));
			if(!$result) return FALSE;
			else return TRUE;
		case 'gaokao':
	        $ucategory=db_result(db_query('SELECT ucategory FROM {students} WHERE uid=\'%s\'', $user->name));
			if(($ucategory == 0 ) || ($ucategory == 3)) return FALSE;
			$result = db_result(db_query('SELECT contact_phone FROM {students_contact} WHERE uid=\'%s\'', $user->name));
        	if(!$result) return FALSE;
        	else if(_signup_user_tab_access($user, 'contact')) return TRUE;
        	else return FALSE;
		default: return FALSE;
	}
}

function signup_user_account_form($edit, $user) {
			$is_student = array_key_exists('5',$user->roles);
			if(!user_access('modify students info') && $user->uid !== $GLOBALS['user']->uid) return;
			// we don't want the administer do anything, but it's fine if one has such permission.
			if($GLOBALS['user']->uid=='1') return;
			if(!$is_student) return;
		    $isvalidated=db_result(db_query('SELECT s.validated FROM {students} s WHERE s.uid=\'%s\'', $user->name));
		    $default_values=db_fetch_object(db_query(
		    	'SELECT s.*, sg.province,sg.city_district FROM {students} s INNER JOIN {students_gk} sg ON s.uid=sg.uid WHERE s.uid=\'%s\'',
		    	$user->name));
			$form['personal'] = array(
				'#type' => 'fieldset',
				'#title' => t('Personal information'),
				'#description' => t('You\'ll need to provide these information when reseting password. When typing alphabet, please use upper case.')
			);
         switch ($user->ucategory) {
           case uc_OWN_STUDENT: // Our own student
           {
             $form['personal']['idnumber'] = array('#type' => 'textfield',
               '#title' => t('Your Student ID'),
               '#default_value' => $default_values->idcard_number,
               '#maxlength' => 6,
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['truename'] = array('#type' => 'textfield',
               '#title' => t('Your Name'),
               '#default_value' => $default_values->name,
               '#maxlength' => 50,
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['province'] = array('#type' => 'hidden',
               '#value' => '000000');
            }
             break;
           case uc_MAINLAND_STUDENT: // China mainland student
           {
             $form['personal']['idnumber'] = array('#type' => 'textfield',
               '#title' => t('Your ID Card Number'),
               '#description' => t('We\'re calculating gender and date of birth based '.
                 'on your ID card number. If you are not using citizen ID Card, please contact us.'),
               '#default_value' => $default_values->idcard_number,
               '#maxlength' => 18,
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['truename'] = array('#type' => 'textfield',
               '#title' => t('Your Name'),
               '#default_value' => $default_values->name,
               '#maxlength' => 50,
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['province'] = array('#type' => 'select',
               '#title' => t('Province you live'),
               '#description' => t('The place you will be attending the exam.'),
               '#default_value' => $default_values->province,
               '#options' => array(),
               //'#prefix' => '<a name="edit-province">',
               //'#suffix' => '</a>',
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $dbo = db_query('SELECT * from {vl_province} p where p.ucategory=%s',$user->ucategory);
             while ($result = db_fetch_array($dbo))
             {
               $r = array($result['pid'] => $result['name']);
               $form['personal']['province']['#options'] += $r;
             }
             $form['personal']['nationality'] = array('#type' => 'select',
               '#title' => t('Your nationality'),
               '#default_value' => $default_values->nationality,
               '#options' => array(),
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $dbo = db_query('SELECT * from {vl_nationality}');
             while ($result = db_fetch_array($dbo))
             {
               $r = array($result['nid'] => $result['name']);
               if ($result['nid'] != 98)
                 $form['personal']['nationality']['#options'] += $r;
             }
             $form['personal']['political'] = array('#type' => 'select',
               '#title' => t('Your Political feature'),
               '#default_value' => $default_values->politics_feature,
               '#options' => array(),
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $dbo = db_query('SELECT * from {vl_politics_features}');
             while ($result = db_fetch_array($dbo))
             {
               $r = array($result['pid'] => $result['name']);
                 $form['personal']['political']['#options'] += $r;
             }
             break;
           }
             break;
           case uc_HKTW_STUDENT:
           {
             $form['personal']['idnumber'] = array('#type' => 'textfield',
               '#title' => t('Your ID Card Number'),
               '#default_value' => $default_values->idcard_number,
               '#maxlength' => 18,
               '#required' => TRUE);
             $form['personal']['truename'] = array('#type' => 'textfield',
               '#title' => t('Your Name'),
               '#default_value' => $default_values->name,
               '#maxlength' => 50,
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['dateofbirth'] = array('#type' => 'date',
               '#title' => t('Your date of birth'),
               '#default_value' => array(
                 'year' => substr($default_values->date_of_birth,0,4),
                 'month' => 1*substr($default_values->date_of_birth,4,2),
                 'day' => 1*substr($default_values->date_of_birth,6,2)
                 ),
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['gender'] = array('#type' => 'radios',
               '#title' => t('Your Gender'),
               '#default_value' => $default_values->gender,
               '#options' => array('1'=>t('Male'), '2'=>t('Female')),
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['province'] = array('#type' => 'select',
               '#title' => t('Place you live'),
               '#default_value' => $default_values->province,
               '#prefix' => '<a name="edit-province">',
               '#suffix' => '</a>',
               '#options' => array(),
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $dbo = db_query('SELECT * from {vl_province} p where p.ucategory=%s',$user->ucategory);
             while ($result = db_fetch_array($dbo))
             {
               $r = array($result['pid'] => $result['name']);
               $form['personal']['province']['#options'] += $r;
             }
             $form['personal']['nationality'] = array('#type' => 'select',
               '#title' => t('Your nationality'),
               '#default_value' => $default_values->nationality,
               '#options' => array(),
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $dbo = db_query('SELECT * from {vl_nationality}');
             while ($result = db_fetch_array($dbo))
             {
               $r = array($result['nid'] => $result['name']);
               if ($result['nid'] != 98)
                 $form['personal']['nationality']['#options'] += $r;
             }
           }
             break;
           case uc_OVERSEA_STUDENT:
           {
             $form['personal']['country'] = array('#type' => 'select',
               '#title' => t('The country you resists'),
               '#default_value' => $default_values->city_district,
               '#options' => array(),
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $dbo = db_query('SELECT * FROM {vl_city_district} WHERE pid=\'800000\'');
             while ($result = db_fetch_array($dbo))
             {
               $r = array($result['cid'] => $result['name']);
               $form['personal']['country']['#options'] = $form['personal']['country']['#options'] + $r;
             }
             $form['personal']['idnumber'] = array('#type' => 'textfield',
               '#title' => t('Your Passport Number'),
               '#default_value' => $default_values->idcard_number,
               '#maxlength' => 18,
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['truename'] = array('#type' => 'textfield',
               '#title' => t('Your Chinese Name'),
               '#default_value' => $default_values->name,
               '#maxlength' => 50,
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['origname'] = array('#type' => 'textfield',
               '#title' => t('Your Name on your passport'),
               '#default_value' => $default_values->foreign_name,
               '#maxlength' => 50,
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['dateofbirth'] = array('#type' => 'date',
               '#title' => t('Your date of birth'),
               '#default_value' => array(
                 'year' => substr($default_values->date_of_birth,0,4),
                 'month' => 1*substr($default_values->date_of_birth,4,2),
                 'day' => 1*substr($default_values->date_of_birth,6,2)
                 ),
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['gender'] = array('#type' => 'radios',
               '#title' => t('Your Gender'),
               '#default_value' => $default_values->gender,
               '#options' => array('1'=>t('Male'), '2'=>t('Female')),
               '#required' => !$isvalidated,
               '#disabled' => $isvalidated,
             );
             $form['personal']['nationality'] = array('#type' => 'hidden',
               '#value' => '98');
             $form['personal']['province'] = array('#type' => 'hidden',
               '#value' => '800000');
			}
             break;
         }
		 return $form;
}

function signup_user_account_form_save(&$edit, &$user) {
	//var_dump($edit);var_dump($user);exit;
	if($edit['pass']) {
		user_save($user, array('pass'=>$edit['pass']), 'pass');
	}
	$isvalidated=db_result(db_query('SELECT s.validated FROM {students} s WHERE s.uid=\'%s\'', $user->name));
	if($isvalidated) return;
	$edit['dobtosave']=sprintf("%04d%02d%02d",$edit['dateofbirth']['year'], $edit['dateofbirth']['month'], $edit['dateofbirth']['day']);
	$ucategory=db_result(db_query('SELECT ucategory FROM {students} WHERE uid=\'%s\'', $user->name));
	//var_dump($user);exit;
	switch($ucategory) {
		case uc_OWN_STUDENT:
			//var_dump($user);exit;
			db_query("UPDATE {students} SET idcard_number = '%s', name = '%s' WHERE uid = '%s'",
				strtoupper($edit['idnumber']), trim($edit['truename']), $user->name);
			break;
		case uc_MAINLAND_STUDENT:
			db_query("UPDATE {students} SET gender = '%s', date_of_birth = '%s', nationality ='%s', politics_feature='%s' WHERE uid = '%s'",
				pim_genderfromidnumber($edit['idnumber']), pim_dobfromidnumber($edit['idnumber']),
				$edit['nationality'], $edit['political'], $user->name);
        	db_query("UPDATE {students} SET idcard_number = '%s', name = '%s' WHERE uid = '%s'",
				strtoupper($edit['idnumber']), trim($edit['truename']), $user->name);
			db_query("UPDATE {students_gk} SET province = '%s' WHERE uid = '%s'",
				$edit['province'], $user->name);
			$city=db_result(db_query('SELECT city_district FROM {students_gk} WHERE uid=\'%s\'', $user->name));
			if(substr($city,0,2)!==substr($edit['province'],0,2))
				db_query("UPDATE {students_gk} SET city_district = '%s' WHERE uid = '%s'",
					$edit['province'], $user->name);
			break;
		case uc_HKTW_STUDENT:
			db_query("UPDATE {students} SET idcard_number = '%s', name = '%s', nationality ='%s' WHERE uid = '%s'",
				strtoupper($edit['idnumber']), trim($edit['truename']), $edit['nationality'], $user->name);
			db_query("UPDATE {students} SET gender = '%s', date_of_birth = '%s' WHERE uid = '%s'",
				$edit['gender'], $edit['dobtosave'], $user->name);
			db_query("UPDATE {students_gk} SET province = '%s', city_district = '%s' WHERE uid = '%s'",
				$edit['province'], $edit['province'], $user->name);
			break;
		case uc_OVERSEA_STUDENT:
			db_query("UPDATE {students} SET idcard_number = '%s', name = '%s', nationality ='%s' WHERE uid = '%s'",
				strtoupper($edit['idnumber']), trim($edit['truename']), $edit['nationality'], $user->name);
			db_query("UPDATE {students} SET foreign_name = '%s' WHERE uid = '%s'",
				trim($edit['origname']), $user->name);
			db_query("UPDATE {students} SET gender = '%s', date_of_birth = '%s' WHERE uid = '%s'",
				$edit['gender'], $edit['dobtosave'], $user->name);
			db_query("UPDATE {students_gk} SET province = '800000', city_district = '%s' WHERE uid='%s'",
				$edit['country'], $user->name);
			break;
	}
}

function signup_user_account_form_validate(&$edit, $user) {
	$isvalidated=db_result(db_query('SELECT s.validated FROM {students} s WHERE s.uid=\'%s\'', $user->name));
	if($isvalidated) return;
	
	$ucategory=db_result(db_query('SELECT ucategory FROM {students} WHERE uid=\'%s\'', $user->name));
	switch($ucategory) {
		case uc_OWN_STUDENT:
			if ($edit['idnumber']) {
				$r = db_result(db_query('SELECT count(*) FROM {students} WHERE idcard_number=\'%s\' AND NOT uid=\'%s\'', $edit['idnumber'], $user->name));
			  	if ($r) {
			    	form_set_error('idnumber', t('The student ID has already been registerd.').' '.
			  			t('If you\'ve lost your password, please <a href="@url">click here to reset it</a>.', array('@url'=>'/logout?destination=user/password')));
			  		break;
			  	}
			}
	  	  	if (isset($edit['idnumber']) && !preg_match('/\d{2}B\d{3}/', $edit['idnumber']))
	  	  	    form_set_error('idnumber', t('The Student ID you\'ve entered is not valid.'));
			break;
		case uc_MAINLAND_STUDENT:
			if ($edit['idnumber']) {
				$r = db_result(db_query('SELECT count(*) FROM {students} WHERE idcard_number=\'%s\' AND NOT uid=\'%s\'', $edit['idnumber'], $user->name));
				if ($r) {
					form_set_error('idnumber', t('The ID Card number has already been registerd.').' '.
						t('If you\'ve lost your password, please <a href="@url">click here to reset it</a>.', array('@url'=>'/logout?destination=user/password')));
					break;
				}
  	    	}
			if (!is_idcardn_validate($edit['idnumber']))
				form_set_error('idnumber', t('The ID Card number you\'ve entered is not valid.'));
			break;
		case uc_HKTW_STUDENT:
			if ($edit['idnumber']) {
				$r = db_result(db_query('SELECT count(*) FROM {students} WHERE idcard_number=\'%s\' AND NOT uid=\'%s\'', $edit['idnumber'], $user->name));
				if ($r) {
					form_set_error('idnumber', t('The ID Card number has already been registerd.').' '.
						t('If you\'ve lost your password, please <a href="@url">click here to reset it</a>.', array('@url'=>'/logout?destination=user/password')));
					break;
				}
			}
			switch($edit['province']) {
				case '720000':
					if (!is_hk_idcardn_validate($edit['idnumber']))
						form_set_error('idnumber', t('The ID Card number you\'ve entered is not valid.'));
					break;
				case '710000':
					if (!is_tw_idcardn_validate($edit['idnumber'])) {
						form_set_error('idnumber', t('The ID Card number you\'ve entered is not valid.'));
					break;
					}
					$gender_calculated = substr($edit['idnumber'],1,1);
					if ($gender_calculated != '1' && $gender_calculated != '2') {
						form_set_error('idnumber', t('The ID Card number you\'ve entered is not valid.'));
						break;
					}
					if ($gender_calculated != $edit['gender']) {
						form_set_error('idnumber', t('The ID Card number you\'ve entered does not meet your gender.'));
						form_set_error('gender', t('The ID Card number you\'ve entered does not meet your gender.'));
					}
					break;
			}
			break;
		case uc_OVERSEA_STUDENT:
			if ($edit['idnumber']) {
				$r = db_result(db_query('SELECT count(*) FROM {students} WHERE idcard_number=\'%s\' AND NOT uid=\'%s\'', $edit['idnumber'], $user->name));
				if ($r) {
  	  				form_set_error('idnumber', t('The ID Card number has already been registerd.').' '.
						t('If you\'ve lost your password, please <a href="@url">click here to reset it</a>.', array('@url'=>'/logout?destination=user/password')));
					break;
				}
			}
			break;
	}
}

function signup_user_examinations_form_validate(&$edit, $user) {
	return;
}

function signup_user_contact_form_validate(&$edit, $user) {
	return;
}

function signup_block($op = 'list', $delta = 0) {
	if ($op == 'list') {
		return signup_block_list();
	}
	else if ($op == 'view') {
		switch($delta) {
			case signup_block_PROGRESS:
				return signup_block_content_PROGRESS($delta);
			case signup_block_HOTPROFESSIONS:
				return signup_block_content_HOTPROFESSIONS($delta);
			case signup_block_SEARCHSTUDENTS:
				return signup_block_content_SEARCHSTUDENTS($delta);
  		}
    }
}

function signup_block_list() {
	$result[signup_block_PROGRESS] = array(
		'info' => t('Signup Progress'),
	);
	$result[signup_block_HOTPROFESSIONS] = array(
		'info' => t('Hot professions'),
		'cache' => BLOCK_NO_CACHE,
	);
	if(user_access('modify students info'))
		$result[signup_block_SEARCHSTUDENTS] = array(
			'info' => t('Search students'),
		);
	return $result;
}

function signup_block_content_HOTPROFESSIONS($delta) {
  	  if (!$GLOBALS['user']->uid && arg(0) != 'user') {
  	  	$numofprofess = db_result(db_query('SELECT count(*) from {vl_professions} p WHERE p.enabled=1'));
  	    $r=t('There are <a href="!url">!num professions</a> opening for signing up this year.<br />'.
  	  	  '!users students have been registered till now.',
  	      array(
  	        '!num' => $numofprofess,
  	        '!url' => '/guide',
  	        '!users' => db_result(db_query('SELECT count(*) FROM {students} s WHERE s.idcard_number <> "" AND s.profession_major <> "0"'))
  	      ));
  	    $r.='<br/>';
  	    $num=db_result(db_query('SELECT count(*) FROM {students} s WHERE s.validated = 1'));
  	    if($num>0)
  	    	$r.=t('!num of which has been confirmed.', array('!num'=>$num));
  	  }
  	  
  	  $result['content']=$r;
  	  $result['subject']=t('Hot professions');
  	  return $result;
}

function signup_block_content_SEARCHSTUDENTS($delta) {
	$result['content']=drupal_get_form('signup_search_student');
	$result['subject']=t('Search students');
	return $result;
}

function signup_search_student($form_state = NULL) {
	if($form_state['storage']['haserror']==1) {
		$form['errmsg'] = array(
			'#value' => '<div class="messages error" id="errmsg">'.t('Invalid Student ID').'</div>',
			);
		drupal_add_js(
			'$(document).ready(function(){'.
				'$("#edit-uid").focus();'.
				'window.setTimeout("$(\"#errmsg\").slideUp();",3000)});',
			'inline'
		);
	}
	$form['uid'] = array(
		'#type' => 'textfield',
		'#maxlength' => 18,
		'#size' => 20,
		'#attributes' => array(
			'title' => t('Enter the Student ID, his name or his idcard number'),
		),
		'#prefix' => '<div class="container-inline">',
	);
	$form['submit'] = array(
		'#type' => 'submit',
		'#value' => t('Search'),
		'#attributes' => array(
			'style' => 'vertical-align: baseline;',
		),
		'#suffix' => '</div>',
	);
	
	return $form;
}

function signup_search_student_submit($form, &$form_state) {
	$valins="";
	if(db_result(db_query('SELECT count(*) FROM {students} WHERE validated=1'))>0)
		$valins=" AND s.validated=1 ";
	
	unset($form_state['storage']['haserror']);
	// Search by student ID at first
	$uid=db_result(db_query('SELECT u.uid from {users} u INNER JOIN {students} s ON u.name=s.uid WHERE u.name LIKE \'%%%s%%\'  '.$valins.'ORDER BY u.name ASC LIMIT 1',$form_state['values']['uid']));
	if(!$uid) {
		$uid=db_result(db_query('SELECT u.uid from {users} u INNER JOIN {students} s ON u.name=s.uid WHERE s.name LIKE \'%%%s%%\' '.$valins.' ORDER BY u.name ASC LIMIT 1',$form_state['values']['uid']));
		if(!$uid) {
			$uid=db_result(db_query('SELECT u.uid from {users} u INNER JOIN {students} s ON u.name=s.uid WHERE s.idcard_number=\'%s\' '.$valins.' ORDER BY u.name ASC LIMIT 1',$form_state['values']['uid']));
			if(!$uid) {
				$form_state['storage']['haserror']=1;
				$form_state['rebuild']=TRUE;
			}
			else
				$form_state['rebuild']=FALSE;
		}
		else
			$form_state['rebuild']=FALSE;
	}
	else
		$form_state['rebuild']=FALSE;
	if(user_access('modify students info'))
		$form_state['redirect']='user/'.$uid.'/edit';
	else
		$form_state['redirect']='user/'.$uid;
}

function signup_profile_alter(&$account) {
	if(array_key_exists('5', $account->roles))
		unset($account->content['summary']);
}

function signup_2nd_round_by_profession() {
	$output = '<div id="baoming_user_stat" class="baoming_view_section node">';
	$prof=arg(3);
	
	$sql_department_insert='';
	$valins=" AND s.pass_round1_major='1' ";
		
	if(!is_null($prof)) {
		$profins=" AND p.pid='".$prof."' ";
	}
	
	// Compute total number of registered students.
	if(!is_null($prof)) {
		$total_students=db_result(db_query('SELECT count(*) FROM {students} s WHERE s.idcard_number <> "" AND s.profession_major=\'%s\''.$valins, $prof));
		return '<div>'.t('There are !num students which have been marked as enrolled into 2nd round examination.', array('!num'=>$total_students)).'</div>'._signup_2nd_round_by_profession_detail($prof);
	}
	else {
		$total_students=db_result(db_query('SELECT count(*) FROM {students} s WHERE s.idcard_number <> "" AND s.profession_major <> "0"'.$valins));
	}
	
	$output .= t('There are @number students which have been marked as enrolled into 2nd round examination.', array('@number'=>$total_students));
	$header = array(
		array('data'=>'<nobr>'.t('Profession').'</nobr>', 'field'=>'pid', 'sort'=>'asc'),
		array('data'=>t('Number of students (%)'), 'field'=>'num'),
	);
	$tablesort = tablesort_sql($header);
	$sql=sprintf(
		"SELECT p.pid, p.uid, p.pname, count(*) AS num FROM {students} s INNER JOIN {vl_professions} p ".
			"ON s.profession_major = p.pid WHERE s.idcard_number <> ''".$valins.$sql_department_insert.
			"GROUP BY s.profession_major".
			"%s", $tablesort);
	$rdbo = db_query($sql);
	
	while(($r = db_fetch_object($rdbo))) {
		if($r->pid) {
	       // Determine whether you are plain department
	       if(user_access('view own draft') && !user_access('view draft'))
	       	   if($GLOBALS['user']->name !== $r->uid) continue;
		   $rows[] = array(
			'<nobr>'.l($r->pname, 'signup/2ndround/profession/'.$r->pid, array(
			  'title' => t('Click to view the details of @prof profession', array('@prof'=>$r->pname)),
			  )
			).'</nobr>',
			sprintf('<img src="/%s/red-dot.png" style="width:%dpx; height:10px;"/> %d (%.1f%%)', drupal_get_path('module','signup'), $r->num, $r->num, $r->num/$total_students*100),
		   );
		}
	}
	
	$output .= theme('table', $header, $rows);
	
	$output .= '</div>';
	return $output;
}

function _signup_2nd_round_by_profession_detail($prof=NULL) {

  $valins="AND s.pass_round1_major=1";

  $sql_department_insert = "AND p.pid='".$prof."'";
  $output = '<div id="baoming_user_list" class="baoming_view_section node">';
  $rows = array();
  $header = array(
  	array('data' =>t('Student ID'), 'field'=>'s.uid', 'sort'=>'desc'),
  	array('data' =>t('Real Name')),
  	array('data' =>t('Gender'), 'field'=>'s.gender'),
  	array('data' =>t('Profession'), 'field'=>'s.profession_major'),
  	array('data' =>t('Province'), 'field'=>'gk.province'),
  	array('data' =>t('Personnel record'), 'field'=>'personnel_record_at'),
  );
  
  $tablesort = tablesort_sql($header);
  $rdbo = pager_query(
  	  'SELECT s.ucategory, s.uid, s.name, s.gender, s.profession_major, gk.province, gk.city_district, IFNULL(c.personnel_record_at,\'\') AS personnel_record_at '.
  	  'FROM {students} s LEFT JOIN {students_gk} gk ON s.uid = gk.uid '.
  	  'LEFT JOIN {students_contact} c ON s.uid=c.uid '.
  	  'INNER JOIN {vl_professions} p ON s.profession_major=p.pid '.
  	  'WHERE NOT s.idcard_number = \'\' '.$sql_department_insert.$valins.$tablesort, 20);
  if(!$rdbo) {
  	  $rows[][] = array('data'=> t('N/A'), 'colspan'=>(string)count($header));
  }
  else
  while($r = db_fetch_object($rdbo)) {
  	  switch($r->ucategory) {
  	  	  case uc_OWN_STUDENT:
  	  	  	  $province = t('Our own student');
  	  	  	  $per = t('Our own student');
  	  	  	  $plink = '000000';
  	  	  	  break;
  	  	  case uc_MAINLAND_STUDENT:
  	  	  case uc_HKTW_STUDENT:
  	  	  	  $province = $r->province ? db_result(db_query('SELECT p.simplified_name FROM {vl_province} p WHERE p.pid=\'%s\'', $r->province)) : t('N/A');
  	  	  	  $per = $r->personnel_record_at;
  	  	  	  if(!$per) $per=t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  	  case uc_OVERSEA_STUDENT:
  	  	  	  $province = db_result(db_query('SELECT cd.name FROM {vl_city_district} cd WHERE cd.cid = \'%s\'', $r->city_district));
  	  	  	  $per = t('N/A');
  	  	  	  $plink = $r->province;
  	  	  	  break;
  	  }
  	  
	  $profession_major = t('!dname!pname', array(
  	  	  '!dname' => db_result(db_query('SELECT d.dname FROM {vl_department} d WHERE d.did=\'%s\'', substr($r->profession_major, 0, 2))),
  	  	  '!pname' => db_result(db_query('SELECT p.pname FROM {vl_professions} p WHERE p.pid=\'%s\'', $r->profession_major))));
  	  $rows[] = array(
  	  	'<nobr>'.l($r->uid, 'user/'.db_result(db_query('SELECT u.uid FROM {users} u INNER JOIN {students} s ON u.name=s.uid WHERE s.uid=\'%s\'', $r->uid))).'</nobr>',
  	  	'<nobr>'.$r->name.'</nobr>',
  	  	$r->gender == 1 ? t('Male'): t('Female'),
  	  	l($profession_major, 'signup/2ndround/profession/'.$r->profession_major, array(
		  'title' => t(
		    'Click to view the details of @prof', array(
		    '@prof' => $profession_major)
		  ))
		),
  	  	//l($province, 'signup/overview/province/'.$plink),
  	  	$province,
  	  	$per,
  	  );
  }
  
  $output .= theme('table', $header, $rows);
  $output .= theme('pager', NULL, 20);
  $output .= "</div>";
  
  $output .= l(t('<< Back to full student list'), 'signup/2ndround/profession');
  
  drupal_set_title(t('By Profession').' - '.db_result(db_query('SELECT p.pname FROM {vl_professions} p WHERE p.pid=\'%s\'', $prof)));
  
  return $output;
}

function signup_3rd_round_by_profession() {
                $header=array(
                        array('data'=>t('Profession'), 'field'=>'p.pid', 'sort'=>'asc'),
                        array('data'=>t('People (%)'), 'field'=>'num'),
                );
                $tablesort = tablesort_sql($header);

                $total_students=db_result(db_query('SELECT count(*) FROM {students} s WHERE s.pass_round3_major>0'));
		$rdbo=db_query('SELECT p.pid, p.pname, count(*) AS num FROM {students} s INNER JOIN {vl_professions} p ON s.profession_major=p.pid WHERE s.pass_round3_major>0 '.$sql_department_insert.' GROUP BY p.pid '.$tablesort);
                $rows=array();
                while($r=db_fetch_object($rdbo))
                {
                        $rows[]=array(
                                l($r->pname, 'signup/3rdround/profession/'.$r->pid),
                                sprintf('<img src="/%s/red-dot.png" style="width:%dpx; height:10px;"/> %d (%.1f%%)', drupal_get_path('module','signup'), $r->num, $r->num, $r->num/$total_students*100),
                        );
                }

                $output = t('There are currently !num students marked as being enrolled into the 3rd round examination.', array('!num'=>$total_students));
                $output .= theme('table', $header, $rows);
		return $output;

}
function signup_3rd_round_by_profession_detail($prof=NULL) {
	$prof=arg(3);

  $valins="AND s.pass_round3_major > 0";

  $sql_department_insert = "AND p.pid='".$prof."'";
  $output = '<div id="baoming_user_list" class="baoming_view_section node">';
  $rows = array();
  $header = array(
	array(),
        array('data' =>t('Student ID'), 'field'=>'s.uid'),
        array('data' =>t('Real Name')),
	array('data' =>t('Status'), 'field'=>'status'),
        array('data' =>t('Province'), 'field'=>'gk.province'),
  );

  //$tablesort = tablesort_sql($header);
  //var_dump($tablesort);
  //$tablesort=' ORDER BY total_score DESC, pass_round3_major DESC, s.uid ASC ';
  $exams=unserialize(db_result(db_query('SELECT exams FROM {vl_professions} WHERE pid=\'%s\'', $prof)));

  // fetch exams
  $sql="";
  //$sql_=" FROM {students} s LEFT JOIN {students_contact} sc ON s.uid=sc.uid";
  $sql_='';
  $sql__=" WHERE s.profession_major='$prof' AND s.pass_round1_major=1";
  $totals=array();
  foreach($exams as $exam=>$weight) {
	if($weight > 0 || substr($exam,0,1)=='3') {
		//$totals[]="e$exam.score*$weight";
		$sql.=", e$exam.score AS e$exam";
		$sql_.=" LEFT JOIN {students_score} e$exam ON s.uid=e$exam.uid AND e$exam.eid='$exam'";
	}
	if(substr($exam,0,1)=='3') {
		$header[]=array('data' =>db_result(db_query('SELECT e.ename FROM {vl_exam} e WHERE e.eid="%s"', $exam)));
		$eee[]=$exam;
	}
  }
  // $sql.=','.implode('+', $totals).' AS total_score '.$sql_.$sql__.$tablesortsql.', s.uid ASC';
  //$sql.=','.implode('+', $totals).' AS total_score ';
  $header[]=array('data'=>t('Total score'), 'field'=>'total_score', 'sort'=>'desc');
  $header[]=array('data'=>t('Personnel record'));
  $tablesort = tablesort_sql($header);
  //var_dump($tablesort);
  //var_dump($header);
  //var_dump(tablesort_sql($header));

  $rdbo = pager_query(
          'SELECT s.ucategory, s.uid, -1*s.pass_round3_major as status, s.name, s.gender, s.profession_major, gk.province, gk.city_district, IFNULL(c.personnel_record_at,\'\') AS personnel_record_at '.$sql.
          ', cast(st.total_score as DECIMAL(5,2)) as total_score '.
          'FROM {students} s LEFT JOIN {students_gk} gk ON s.uid = gk.uid '.
          'LEFT JOIN {students_contact} c ON s.uid=c.uid '.
          'LEFT JOIN {students_total_score} st ON s.uid=st.uid '.
          'INNER JOIN {vl_professions} p ON s.profession_major=p.pid '.
	  $sql_.
          ' WHERE NOT s.idcard_number = \'\' '.$sql_department_insert.$valins.$tablesort.', s.uid ASC', 40);
  $i=$_GET['page']*40+1;
  if(!$rdbo) {
          $rows[][] = array('data'=> t('N/A'), 'colspan'=>(string)count($header));
  }
  else
  while($r = db_fetch_object($rdbo)) {
          switch($r->ucategory) {
                  case uc_OWN_STUDENT:
                          $province = t('Our own student');
                          $per = t('Our own student');
                          $plink = '000000';
                          break;
                  case uc_MAINLAND_STUDENT:
                  case uc_HKTW_STUDENT:
                          $province = $r->province ? db_result(db_query('SELECT p.simplified_name FROM {vl_province} p WHERE p.pid=\'%s\'', $r->province)) : t('N/A');
                          $per = $r->personnel_record_at;
                          if(!$per) $per=t('N/A');
                          $plink = $r->province;
                          break;
                  case uc_OVERSEA_STUDENT:
                          $province = db_result(db_query('SELECT cd.name FROM {vl_city_district} cd WHERE cd.cid = \'%s\'', $r->city_district));
                          $per = t('N/A');
                          $plink = $r->province;
                          break;
          }

          $profession_major = t('!dname!pname', array(
                  '!dname' => db_result(db_query('SELECT d.dname FROM {vl_department} d WHERE d.did=\'%s\'', substr($r->profession_major, 0, 2))),
                  '!pname' => db_result(db_query('SELECT p.pname FROM {vl_professions} p WHERE p.pid=\'%s\'', $r->profession_major))));
	  //var_dump($r);
          $rows[] = array(
		$i++,
                '<nobr>'.l($r->uid, 'user/'.db_result(db_query('SELECT u.uid FROM {users} u INNER JOIN {students} s ON u.name=s.uid WHERE s.uid=\'%s\'', $r->uid))).'</nobr>',
                '<nobr>'.$r->name.'</nobr>',
                //$r->gender == 1 ? t('Male'): t('Female'),
		$r->status==-1?t('To be determined'):t('Determined'),
                //l($province, 'signup/overview/province/'.$plink),
                $province,
	  );
	  foreach($r as $key=>$val) {
		  if(substr($key,0,2)=='e3')
			if($key=='e350') $rows[count($rows)-1][]=$val;
			else $rows[count($rows)-1][]=number_format($val,2);
	  }
	  $rows[count($rows)-1][]=number_format($r->total_score,2);
	  $rows[count($rows)-1][]=$per;
  }

  $output .= theme('table', $header, $rows);
  $output .= theme('pager', NULL, 40);
  $output .= "</div>";

  $output .= l(t('<< Back to full student list'), 'signup/3rdround/profession');

  drupal_set_title(t('By Profession').' - '.db_result(db_query('SELECT p.pname FROM {vl_professions} p WHERE p.pid=\'%s\'', $prof)));

  return $output;
}

*/

function sign_up_report($account) {

	$result = db_select('students','s')->fields('s')->condition('s.uid',$account->name)->execute()->fetchObject();
	$result_gk = db_select('students_gk','s')->fields('s')->condition('s.uid',$account->name)->execute()->fetchObject();
	$result_contact = db_select('students_contact','s')->fields('s')->condition('s.uid',$account->name)->execute()->fetchObject();
	//var_dump($account);
	require_once(drupal_get_path('module','signup').'/../tcpdf/config/lang/eng.php');
	require_once(drupal_get_path('module','signup').'/../tcpdf/tcpdf.php');
	require_once(drupal_get_path('module','signup').'/../tcpdf/barcodes.php');
	
	ini_set('max_execution_time','500');

	// create new PDF document
	$pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

	// set document information
	$pdf->SetCreator(PDF_CREATOR);

	// Set font
	// dejavusans is a UTF-8 Unicode font, if you only need to
	// print standard ASCII chars, you can use core fonts like
	// helvetica or times to reduce file size.
	$pdf->SetFont('droidsansfallback', 'B', 14, '', true);
	// set default font subsetting mode
	$pdf->setFontSubsetting(false);
	
	$pdf->setPrintHeader(false);
	$pdf->setPrintFooter(false);

	$pdf->SetMargins(6, 6, 6);
	$pdf->SetAutoPageBreak(false);

	//set some language-dependent strings
	$pdf->setLanguageArray($l);

	// ---------------------------------------------------------

	// Add a page
	// This method has several options, check the source code documentation for more information.
	$pdf->AddPage();
	$pdf->SetFillColor(216,216,216);
	$pdf->SetDrawColor(255,255,255);
	$pdf->SetLineWidth(0.5);


	// Header
	$pdf->SetFontSize(27);
	$pdf->Text(6,6,'中央音乐学院'.variable_get('zhaoban_current_year',date('Y')).'年本科招生专业考试报名表');
	$pdf->LN();
	
	$pdf->SetFontSize(18);
	$pdf->Cell(165,7.5,'个人信息',1,1,'C',true);

	$pdf->SetFontSize(10);
	$pdf->Cell(10,6,'姓名',1,0,'C',true);
	$pdf->Cell(80,6,$result->foreign_name==''?$result->name:$result->foreign_name.' / '.$result->name,0,0,'L',false);
	$pdf->Cell(20,6,'证件号码',1,0,'C',true);
	$pdf->Cell(30,6,$result->idcard_number,0,1,'L',false);
	
	
	$pdf->SetX(6);
	$pdf->Cell(10,6,'性别',1,0,'C',true);
	$pdf->Cell(10,6,$result->gender==2?'女':'男',0,0,'L',false);
	$pdf->Cell(20,6,'出生日期',1,0,'C',true);
	$pdf->Cell(20,6,$result->date_of_birth,0,0,'L',false);
	$pdf->Cell(10,6,'民族',1,0,'C',true);
	$pdf->Cell(20,6,db_select('vl_nationality','n')->fields('n',array('name'))->condition('n.nid',$result->nationality)->execute()->fetchField(),0,0,'L',false);
	$pdf->Cell(15,6,'生源地',1,0,'C',true);
	$pdf->Cell(60,6,db_select('vl_city_district','cd')->fields('cd',array('name_simp'))->condition('cd.cid',$result_gk->city_district)->execute()->fetchField(),0,1,'L',false);
	
	$pdf->SetX(6);
	$pdf->Cell(20,6,'档案所在地',1,0,'C',true);
	$pdf->Cell(90,6,isset($result_contact->personnel_record_at)?$result_contact->personnel_record_at:'',0,0,'L',false);
	$pdf->Cell(20,6,'政治面貌',1,0,'C',true);
	$pdf->Cell(30,6,db_select('vl_politics_features','p')->fields('p',array('name'))->condition('p.pid',$result->politics_feature)->execute()->fetchField(),0,1,'L',false);

	$pdf->SetX(6);
	$pdf->SetFontSize(18);
	
	$pdf->Cell(115,7.5,'报考专业信息',1,0,'C',true);
	$pdf->Cell(79,7.5,'高考考生信息',1,1,'C',true);

	$pdf->SetX(6);
	$pdf->SetFontSize(10);
	$pdf->Cell(20,6,'报考专业',1,0,'C',true);
	$pdf->Cell(95,6,db_select('vl_professions','p')->fields('p',array('pname'))->condition('p.pid',$result->profession_major)->execute()->fetchField(),0,0,'L',false);
	$pdf->Cell(20,6,'高考报名号',1,0,'C',true);
	$pdf->Cell(50,6,$result_gk->sid==''?'暂无':$result_gk->sid,0,0,'L',false);
	$pdf->Cell(8.3,6,$result_gk->is_math_subjects?'理科':'',0,1,'C',$result_gk->is_math_subjects);
	
	$pdf->SetX(6);
	$pdf->SetFontSize(18);
	$pdf->LN();

	$pdf->Cell(194,7.5,'考试科目及曲目',1,1,'C',true);

	$pdf->SetFontSize(10);
	$pdf->Cell(60,7,'考试科目',1,0,'C',true);
	$pdf->Cell(20,7,'考试形式',1,0,'C',true);
	$pdf->Cell(114,7,'考试曲目',1,1,'C',true);

	//$rdbo = db_query("SELECT sg.eid, sg.opus, e.ename, e.elevel, e.etype FROM {students_going} sg INNER JOIN {vl_exam} e ON sg.eid=e.eid WHERE sg.uid='".$account->name."' ORDER BY e.eid");
	$query = db_select('students_going','sg');
	$query->innerJoin('vl_exam','e','sg.eid=e.eid');
	$rdbo=$query->fields('sg',array('eid','opus'))->fields('e',array('ename','elevel','etype'))->condition('sg.uid',$account->name)->orderBy('e.eid')->execute();
	//$rdbo=$query->execute();
	foreach($rdbo as $r) {
		$exams =unserialize($r->opus);
		$pdf->SetX(6);
		$pdf->Cell(60, 7, $r->ename.($r->elevel?$r->elevel:''));
		$pdf->Cell(20, 7, $r->etype==1?'笔试':'面试',1,0,'C');
		if(is_null($r->opus)) $pdf->LN();
		else
		foreach($exams as $enum => $evalue) {
			$pdf->setX(86);
			if($enum=='eadditional') {
				if($evalue!=='')
					$t='主试乐器: '.t($evalue);
				else
					$t='主试乐器: 钢琴';
			}
			else
				$t='('.substr($enum,-1).') '.$evalue;
			$pdf->Cell(114, 7, $t, 0,1,'L',false);
		}
	}
	$pdf->LN();

	$pdf->SetX(6);
	$pdf->SetFontSize(18);
	$pdf->Cell(194,7.5,'联系方式',1,1,'C',true);
	
	$pdf->SetFontSize(10);
	$pdf->Cell(35,7,'考试期间联系电话',1,0,'C',true);
	$pdf->Cell(120,7,isset($result_contact->contact_phone)?$result_contact->contact_phone:'',1,0,'L',false);
	$pdf->Cell(20,7,'乘车区间',1,0,'C',true);
	$pdf->Cell(25,7,isset($result_contact->terminus_of_train)?$result_contact->terminus_of_train:'',1,1,'L',false);
	
	$pdf->Cell(35,7,'文考通知书邮寄地址',1,0,'C',true);
	$pdf->Cell(150,7,isset($result_contact->address_round3)?$result_contact->address_round3:'',1,1,'L',false);
	$pdf->Cell(10,7,'邮编',1,0,'C',true);
	$pdf->Cell(25,7,isset($result_contact->zip_round3)?$result_contact->zip_round3:'',1,0,'L',false);
	$pdf->Cell(15,7,'收件人',1,0,'C',true);
	$pdf->Cell(100,7,isset($result_contact->recipient_round3)?$result_contact->recipient_round3:'',1,1,'L',false);
	
	$pdf->Cell(35,7,'录取通知书邮寄地址',1,0,'C',true);
	$pdf->Cell(150,7,isset($result_contact->address_roundg)?$result_contact->address_roundg:'',1,1,'L',false);
	$pdf->Cell(10,7,'邮编',1,0,'C',true);
	$pdf->Cell(25,7,isset($result_contact->zip_roundg)?$result_contact->zip_roundg:'',1,0,'L',false);
	$pdf->Cell(15,7,'收件人',1,0,'C',true);
	$pdf->Cell(80,7,isset($result_contact->recipient_roundg)?$result_contact->recipient_roundg:'',1,0,'L',false);
	$pdf->Cell(20,7,'收件人电话',1,0,'C',true);
	$pdf->Cell(25,7,isset($result_contact->phone_roundg)?$result_contact->phone_roundg:'',1,1,'L',false);
	
	if(isset($result_contact->address_of_home))
		$address_of_home=unserialize($result_contact->address_of_home);
	else {
		$address_of_home=array(
			'address_school'=>'',
			'zip_school'=>'',
			'recipient_school'=>'',
		);
	}
	
	$pdf->Cell(35,7,'家庭通讯地址',1,0,'C',true);
	$pdf->Cell(95,7,$address_of_home['address_school'],1,0,'L',false);
	$pdf->Cell(10,7,'邮编',1,0,'C',true);
	$pdf->Cell(20,7,$address_of_home['zip_school'],1,0,'L',false);
	$pdf->Cell(15,7,'收件人',1,0,'C',true);
	$pdf->Cell(30,7,$address_of_home['recipient_school'],1,1,'L',false);

	$pdf->SetX(6);
	$pdf->SetFontSize(18);
	$pdf->Cell(194,7.5,'信息确认',1,1,'C',true);
	
	$pdf->SetFontSize(10);
	$pdf->MultiCell(0,0,'    本人确认以上信息均为本人填写，真实有效。如有虚假内容，因此产生的一切后果由本人自行承担。受托代表人可完全代表本人意愿。');
	//$pdf->Cell(194,7,'&nbsp;&nbsp;&nbsp;本人确认以上信息均为本人填写，真实有效。如有虚假内容，因此产生的一切后果由本人自行承担。受托代表人可完全代表本人意愿。',1,'L',false,1,'','',true,0,true);
	
	$pdf->SetX(100);
	$pdf->Cell(38,7.5,'考生(或受托代表人)签名',1,0,'C',false);
	$pdf->SetDrawColor(0,0,0);
	$pdf->Cell(40,7.5,'','B',0,'C',false);
	$pdf->SetDrawColor(255,255,255);
	
	$pdf->setX(6);
	$pdf->setY(-18);
	$pdf->SetFontSize(28);
	
	if($result->ucategory)
		$pro=db_select('vl_province','p')->fields('p',array('simplified_name'))->condition('pid',$result_gk->province)->execute()->fetchField();
	else
		$pro='辅修';
	$pdf->Cell(40,15,$pro,1,0,'L',false);
	$pdf->Cell(63,15,$result->name,1,0,'R',false);
	$pdf->setX(112);
	
	$pdf->write1DBarcode($result->uid,'C128B','','',37,14,0.4,array('stretch'=>TRUE));
	
	$pdf->setX(137);
	$pdf->Cell(65,15,$result->uid,1,1,'R',false);
	
	// ---------------------------------------------------------
	// Close and output PDF document
	// This method has several options, check the source code documentation for more information.
	$pdf->Output('signup_report.pdf', 'I');

}

function sign_up_picture($account) {
	$query=db_select('students','s')->fields('s',array('picture'))->condition('s.uid',$account->name);
	$img_tmp=$query->execute()->fetchField();
	if(!$img_tmp) return NULL;
	$img=imagecreatefromstring(base64_decode($img_tmp));
	$newheight=100;
	$newwidth=imagesx($img)*100/imagesy($img);
	
	$newimg=imagecreatetruecolor($newwidth, $newheight);
	imagecopyresampled($newimg, $img, 0, 0, 0, 0, $newwidth, $newheight, imagesx($img), imagesy($img));
	
	drupal_add_http_header('Content-type', 'image/jpg; charset=binary', TRUE);
	drupal_add_http_header('Content-Transfer-Encoding', 'binary', TRUE);

	// Do not expire image file, because it causes overload of server :(
	// seconds, minutes, hours, days
	$expires = 60*60*24*300;
	drupal_add_http_header("Pragma", "public", TRUE);
	drupal_add_http_header("Cache-Control", "maxage=".$expires, TRUE);
	drupal_add_http_header('Expires', gmdate('D, d M Y H:i:s', time()+$expires) . ' GMT', TRUE);
	imagejpeg($newimg, NULL, 100);
	imagedestroy($img);
	imagedestroy($newimg);
}

function signup_schools_autocomplete($string) {
  $matches = array();
  if ($string) {
  	$result = db_select('vl_schools','s')->fields('s',array('sname'))->condition('s.sname', db_like($string) . '%', 'LIKE')->range(0, 10)->execute();
    //$result = db_query_range("SELECT sname FROM {vl_schools} WHERE sname LIKE LOWER('%s%%')", $string, 0, 10);
    foreach ($result as $school) {
      $matches[$school->sname] = check_plain($school->sname);
    }
  }

  drupal_json_output($matches);
}

function signup_cron() {
	// Force set those passthrough students's status
	$result = db_select('students_passthrough','s')->fields('s')->execute();
	foreach ($result as $r) {
		db_update('students')
			->fields(array(
				'pass_round1_major' => 1,
				'pass_round3_major' => 10,
			))
			->condition('idcard_number',$r->idcard_number)
			->execute();
	}
}
?>
