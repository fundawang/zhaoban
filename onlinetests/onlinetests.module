<?php

/*
 * This file is licensed under GPLv2+.
*/

/**
 * @file
 * Provides the operations of online tests.
 */
define("ONLINETEST_STATUS_ABOUT_TO_BEGIN",1);
define("ONLINETEST_STATUS_ONGOING",2);
define("ONLINETEST_STATUS_ENDED",3);
define("ONLINETEST_STATUS_INTERVIEWING",4);
define("ONLINETEST_STATUS_FINISHED",5);

define("ONLINETEST_ACCESSCODE_LENGTH", 8);


/**
 * Implementation of hook_help().
 */
function onlinetests_help($path, $arg) {
	$output = '';
	switch ($path) {
		case 'definations/itemspec':
			$output = t('Define specification of online examinations.');
			break;
		case 'definations/onlinetests':
			$output = t('Organize online tests.');
			break;
		default:
			return;
	}
	return '<p>'.$output.'</p>';
}

/**
 * Implements hook_permission
 */
function onlinetests_permission() {
	return array(
		'administer online exams' => array(
			'title' => t('Administrater online tests'),
		),
		'participate online exams' => array(
			'title' => t('Participate online tests'),
		),
	);
}

/**
 * Implementation of hook_menu().
 */
function onlinetests_menu() {
	$items['definations/onlinetests'] = array(
		'title' => 'Online tests',
		'description' => "Organize online tests.",
		'weight' => 13,
		'page callback' => 'onlinetests_onlinetests_list',
		'access callback' => 'onlinetests_onlinetests_list_perm',
	);
	$items['definations/onlinetests/modify/%'] = array(
		'title' => 'Modify paper',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('onlinetests_modify_quest',3),
		'access callback' => 'onlinetests_onlinetests_list_perm',
		'access arguments' => array(3),
		'type' => MENU_VISIBLE_IN_BREADCRUMB,
	);
	$items['definations/onlinetests/op/%'] = array(
		'title' => 'Operation on tests',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('onlinetests_operations',3),
		'access callback' => 'onlinetests_onlinetests_list_perm',
		'access arguments' => array(3),
		'type' => MENU_VISIBLE_IN_BREADCRUMB,
	);
	$items['definations/onlinetests/quest/%'] = array(
		'title' => 'Output all students quest',
		'page callback' => 'onlinetests_quest_report',
		'page arguments' => array(3),
		'access callback' => 'onlinetests_onlinetests_quest_perm',
		'access arguments' => array(3),
		'type' => MENU_VISIBLE_IN_BREADCRUMB,
	);
	$items['definations/onlinetests/answers/%'] = array(
		'title' => 'Download the answers files',
		'page callback' => 'onlinetests_answer_list',
		'page arguments' => array(3),
		'access callback' => 'onlinetests_print_score_report_perm',
		'access arguments' => array(3),
		'type' => MENU_VISIBLE_IN_BREADCRUMB,
	);
	$items['definations/onlinetests/printonlinetestscore/%'] = array(
		'title' => 'Print Scroe Report',
		'page callback' => 'onlinetests_print_score_report',
		'page arguments' => array(3),
		'access callback' => 'onlinetests_print_score_report_perm',
		'access arguments' => array(3),
		'type' => MENU_CALLBACK,
	);
	$items['myonlinetests'] = array(
		'title' => 'My Online tests',
		'description' => "Participate online examinations.",
		'weight' => -2,
		'page callback' => 'drupal_get_form',
		'page arguments' => array('onlinetests_myonlinetests_for_students'),
		'access callback' => 'onlinetests_myonlinetests_perm',
	);
	return $items;
}

function onlinetests_admin_perm($eid=NULL) {
	$query=db_select('vl_exam','e')->condition('e.uid',$GLOBALS['user']->name)->fields('e')->condition('e.etype',3);
	if(!empty($eid)) $query=$query->condition('eid',$eid);
	$is_dep_only=$query->countQuery()->execute()->fetchField();
	return user_access('administer online exams') && ($GLOBALS['user']->uid==1? 1: $is_dep_only);
}

function onlinetests_onlinetests_list() {
	$is_dep_only=db_select('vl_exam','e')->condition('uid',$GLOBALS['user']->name)->fields('e')->countQuery()->execute()->fetchField();

	$header = array(
		array('data'=>t('Status'), 'field'=>'status'),
		array('data'=>t('Schedule Name'), 'field'=>'gid', 'sort'=>'asc'),
		array('data'=>t('Place'), 'field'=>'g.place'),
		array('data'=>t('Existing people')),
		array('data'=>t('Time'), 'field'=>'g.time'),
		array('data'=>t('Operations'), 'colspan'=>'2'),
	);

	$query=db_select('vl_going', 'g')
		->fields('g')
		->extend('TableSort')
		->orderByHeader($header);

	$result = $query->execute();

	$rows=array();

	foreach($result as $r) {
		$exam_ids=explode(' ',$r->valid_exams);
		$etype=db_select('vl_exam','e')->condition('e.eid',$exam_ids[0])->fields('e',array('etype'))->execute()->fetchField();
		if($etype != 3) continue;
		$num=db_select('students_going','sg')
			->fields('sg')
			->groupBy('sg.uid')
			->condition('sg.gid',$r->gid)
			->countQuery()
			->execute()->fetchField();
		if($num) {
			$tmp_status=t('N/A');
			switch($r->status) {
				case ONLINETEST_STATUS_ABOUT_TO_BEGIN:
					$tmp_status=t("About to begin"); break;
				case ONLINETEST_STATUS_ONGOING:
					$tmp_status=t("Now performing").' '.l('<img src="'.base_path().drupal_get_path('module', 'going').'/printer.png" title="'.t('Print Quest Paper').'"/>',"definations/onlinetests/quest/$r->gid", array('html'=>true));
					break;
				case ONLINETEST_STATUS_ENDED:
					$tmp_status=t("Ended"); break;
				case ONLINETEST_STATUS_INTERVIEWING:
					$tmp_status=t("Now interviewing").' '.l('<img src="'.base_path().drupal_get_path('module', 'going').'/calculator.png" title="'.t('Print Score sheet').'"/>',"definations/onlinetests/printonlinetestscore/$r->gid", array('html'=>true));
					break;
				case ONLINETEST_STATUS_FINISHED:
					$tmp_status=t("Finished").' '.l('<img src="'.base_path().drupal_get_path('module', 'going').'/calculator.png" title="'.t('Print Score sheet').'"/>',"definations/onlinetests/printonlinetestscore/$r->gid", array('html'=>true));
					break;
			}
		}
		else
			$tmp_status=t('About to begin');
		
		$rows[] = array(
			'<nobr>'.$tmp_status.'</nobr>',
			$r->gname,
			db_select('vl_room', 'r')->fields('r',array('rname'))->condition('r.rid', $r->place)->execute()->fetchField(),
			$num,
			'<nobr>'.implode('</nobr><br/><nobr>',explode(' ',_going_datetime_to_string($r->time))).'</nobr>',
		);
		if($num) {
			if($r->status===FALSE) $status=ONLINETEST_STATUS_ABOUT_TO_BEGIN;
			switch($r->status) {
				case ONLINETEST_STATUS_ABOUT_TO_BEGIN:
					$rows[count($rows)-1][]='<nobr>'.l(t('Modify paper'), "definations/onlinetests/modify/$r->gid").'</nobr>';
					$stem=db_select('vl_quest','q')->condition('q.gid',$going->gid)->fields('q',array('stem'))->execute()->fetchField();
					if($stem)
						$rows[count($rows)-1][]='<nobr>'.l(t('Start'), "definations/onlinetests/op/$r->gid").'</nobr>';
					else
						$rows[count($rows)-1][]='';
					break;
				case ONLINETEST_STATUS_ONGOING:
					$rows[count($rows)-1][]='<nobr>'.l(t('View paper'), "definations/onlinetests/modify/$r->gid").'</nobr>';
					$rows[count($rows)-1][]='<nobr>'.l(t('End'), "definations/onlinetests/op/$r->gid").'</nobr>';
					break;
				case ONLINETEST_STATUS_ENDED:
					$rows[count($rows)-1][]='<nobr>'.l(t('View paper'), "definations/onlinetests/modify/$r->gid").'</nobr>';
					$rows[count($rows)-1][]='<nobr>'.l(t('Begin review'), "definations/onlinetests/op/$r->gid").'</nobr>';
					break;
				case ONLINETEST_STATUS_INTERVIEWING:
					$rows[count($rows)-1][]='<nobr>'.l(t('View paper'), "definations/onlinetests/modify/$r->gid").'<br/>'.
						l(t('View answer files'), "definations/onlinetests/answers/$r->gid").
					'</nobr>';
					$rows[count($rows)-1][]='<nobr>'.l(t('Stop review'), "definations/onlinetests/op/$r->gid").'</nobr>';
					break;
				case ONLINETEST_STATUS_FINISHED:
					$rows[count($rows)-1][]=array(
						'data'=>'<nobr>'.l(t('View paper'), "definations/onlinetests/modify/$r->gid").'<br/>'.
							l(t('View answer files'), "definations/onlinetests/answers/$r->gid").
							'</nobr>',
					);
					$rows[count($rows)-1][]='';
					break;
				default:
					$rows[count($rows)-1][]='<nobr>'.l(t('Modify paper'), "definations/onlinetests/modify/$r->gid").'</nobr>';
					$rows[count($rows)-1][]='';
					break;
			}
		}
	}

	if(count($rows)==0)
		$rows[] = array(array('data' => t('No going have been filled.'), 'colspan' => $should_list_paper_admin?'8':'7'));

	$output = '';
	$output .= theme('table', array('header'=>$header, 'rows'=>$rows));
	$output .= theme('pager');

	return $output;
}

function onlinetests_onlinetests_list_perm($gid=NULL) {
	if($GLOBALS['user']->uid==0) return FALSE;
	$is_dep_only=db_select('vl_exam','e')->condition('uid',$GLOBALS['user']->name)->fields('e')->countQuery()->execute()->fetchField();
	if(!$is_dep_only)
		return user_access('administer online exams');
	else { 
		$goingexams=array();
		$query=db_select('vl_going','g')->condition('department',$GLOBALS['user']->name)->fields('g');
		if($gid) $query->condition('gid',$gid);
		$result=$query->execute();
		foreach($result as $r) {
			$goingexams+=explode(', ',$r->valid_exams);
		}
		foreach($goingexams as $eid) {
			$etype=db_select('vl_exam','e')->fields('e',array('etype'))->condition('eid',$eid)->execute()->fetchField();
			if($etype==3) return TRUE;
		}
	}
	return FALSE; 
}

function onlinetests_modify_quest($form, $form_state, $gid) {
	$going=db_select('vl_going','g')->condition('gid',$gid)->fields('g')->execute()->fetchObject();

	$is_passed = (isset($going->status) && $going->status != ONLINETEST_STATUS_ABOUT_TO_BEGIN);
	if($is_passed)
		drupal_set_title(t('View paper').' - '.$going->gname);
	else
		drupal_set_title(t('Modify paper').' - '.$going->gname);;

	$exam_id=$going->valid_exams;
	$form=array();
	$default_values=db_select('vl_quest','q')->fields('q')->condition('gid',$gid)->condition('eid',$exam_id)->execute()->fetchObject();

	$form['stem']=array(
		'#type' => 'textarea',
		'#title' => t('Stem'),
		'#rows' => 10,
		'#disabled' => $is_passed,
		'#default_value' => isset($default_values->stem)?$default_values->stem:'',
		'#required' => TRUE,
	);

	if(!empty($default_values->materials)) {
		$materials=explode(', ', $default_values->materials);
		$i=1;
		$form['orig_material']=array(
			'#type' => 'fieldset',
			'#title' => t('Existing Material'),
			'#collapsible' => TRUE,
			'#collapsed' => FALSE,
		);

		foreach($materials as $material) {
			$q=db_select('file_managed','f')->fields('f',array('uri','filename'))->condition('fid',$material)->execute()->fetchObject();
			$form['orig_material']['orig_material'.$i]=array(
				'#type' => 'item',
				'#title' => t('Material @i', array('@i'=>$i++)),
				'#markup' => l($q->filename,file_create_url($q->uri)),
			);
		}
	}

	if(!$is_passed) {
		$form['materialframe']=array(
			'#type' => 'fieldset',
			'#title' => t('New Materials'),
			'#collapsible' => TRUE,
			'#collapsed' => count($materials),
		);
		if(!empty($default_values->materials))
			$form['materialframe']['#description']=t('Please note that existing materails will be removed completely, if you upload new materials.');
		$form['materialframe']['materials']=array(
			'#type' => 'plupload',
			'#title' => t('Materials'),
			'#required' => !count($materials),
			'#upload_validators' => array(
				'file_validate_extensions' => NULL,
			),
			'#plupload_settings' => array(
				'max_file_size' => '800mb',
			),
		);
	}

	if(!$is_passed)	{
		$form['submit'] = array('#type' => 'submit', '#value' =>t('Save'));
		$form['cancel'] = array('#markup' => l(t('Cancel'), 'definations/onlinetests'));
	}

	return $form;
}

function onlinetests_modify_quest_submit($form, &$form_state) {
	$going=db_select('vl_going','g')->condition('gid',arg(3))->fields('g')->execute()->fetchObject();

	// First delete all the existing materials
	$orig_materials=explode(', ',db_select('vl_quest','q')->fields('q',array('materials'))->condition('gid',$going->gid)->condition('eid',$going->valid_exams)->execute()->fetchField());
	if($orig_materials && count($form_state['values']['materials'])>0)
		foreach($orig_materials as $fileid) {
			$file = file_load($fileid);
			if($file) {
				file_usage_delete($file, 'onlinetests', 'quest', $GLOBALS['user']->uid);
				file_delete($file);
			}
		}

	// Then upload all new files into file_managed
	$files=array();
	foreach($form_state['values']['materials'] as $material) {
		$file=array(
			'uid' => $GLOBALS['user']->uid,
			'filename' => $material['name'],
			'uri' => $material['tmppath'],
			'filemime' => file_get_mimetype($material['tmppath']),
			'filesize' => filesize($material['tmppath']),
			'status' => FILE_STATUS_PERMANENT,
			'timestamp' => time(),
		);
		$fileobj=(object)$file;
		$fileobj=file_save($fileobj);
		file_move($fileobj,'private://onlinetests/quests/'.$material['name']);
		file_usage_add($fileobj, 'onlinetests', 'quest', $GLOBALS['user']->uid);
		$files[]=$fileobj->fid;
	}

	if(empty($files)) $files=$orig_materials;

	db_delete('vl_quest')->condition('gid',$going->gid)->condition('eid',$going->valid_exams)->execute();
	db_insert('vl_quest')->fields(array(
		'gid' => $going->gid,
		'eid' => $going->valid_exams,
		'stem' => $form_state['values']['stem'],
		'materials' => implode(', ', $files),
	))->execute();

	watchdog('onlinetests','!user modified online tests !gname.',
		array(
			'!user'=>$GLOBALS['user']->name,
			'!gname'=>$going->gname,
		),
		WATCHDOG_INFO
	);

	drupal_set_message(t('Modification saved.'));
	$form_state['redirect']='definations/onlinetests';
}

function onlinetests_operations($form, $form_state, $gid=NULL) {
	$query=db_select('vl_going','g')->condition('gid',$gid)->fields('g');
	$query->innerJoin('vl_room','r','g.place=r.rid');
	$query->fields('r',array('rname'));
	$going=$query->execute()->fetchObject();
	if($going===false || is_null($going->status)) { drupal_access_denied(); return; }
	$operation_impossible=array('status' => 0);
	$form=array();
	switch($going->status) {
		case ONLINETEST_STATUS_ABOUT_TO_BEGIN: // Now to start
			// First check whether the students are available
			$result=db_select('students_going','sg')->condition('sg.gid',$gid)->fields('sg',array('uid'))->execute();
			foreach($result as $r) {
				$query=db_select('students_going','sg')->condition('sg.gid',$gid,'<>')->condition('sg.uid',$r->uid)->condition('sg.status',ONLINETEST_STATUS_ONGOING)->fields('sg');
				if($query->countQuery()->execute()->fetchField()) {
					$operation_impossible=array(
						'status' => 1,
						'description' => t('Operation cannot be done.').t('Some of the students are participating other exams.'),
					);
				}
			}
			if($operation_impossible['status']) break;
			// Now provides information to start the test
			$form['info']=array(
				'#type' => 'markup',
				'#markup'=>'<div class="messages">'._going_datetime_to_string($going->time).' / '.$going->gname.' / '.$going->rname.'</div>',
			);
			$title=t('About to start following test');
			$description=t('The students will be able to view the quest online after the test begins.');
			$submit=t('Start the test');
			break;
		case ONLINETEST_STATUS_ONGOING: // Now about to end the test
			// First to check if students are still performing examination
			$query=db_select('students_going','sg')->condition('sg.gid',$gid)->condition('sg.status',array(ONLINETEST_STATUS_ABOUT_TO_BEGIN,ONLINETEST_STATUS_ONGOING),'in');
			$query->innerJoin('students','s','s.uid=sg.uid');
			$query->addField('s','name');
			$query->fields('sg',array('uid','status'));
			$query->distinct();
			$query->orderBy('sg.uid');
			$result=$query->execute();
			$rows=array();
			foreach($result as $r) {
				$rows[]=array(
					$r->uid,
					$r->name,
					$r->status==ONLINETEST_STATUS_ABOUT_TO_BEGIN?t("About to begin"):t("Now performing"),
				);
			}
			$header=array(
				array('data'=>t('Student ID')),
				array('data'=>t('Real Name')),
				array('data'=>t('Status')),
			);
			// Now provides information to start the test
			$form['info']=array(
				'#type' => 'markup',
				'#markup'=>'<div class="messages">'._going_datetime_to_string($going->time).' / '.$going->gname.' / '.$going->rname.'</div>',
			);
			$title=t('About to end the test').' - '.$going->gname;
			$description=t('The students will be forced to end the test.');
			$submit=t('End the test');
			if(count($rows)) {
				$description.=t('Above students have not submit their papers till now. Please check with them.');
				$form['students']=array(
					'#type' => 'markup',
					'#markup' => theme('table', array('header'=>$header, 'rows'=>$rows)),
				);
			}
			break;
		case ONLINETEST_STATUS_ENDED: //No about to review the answers
			$title=t('Begin review').' - '.$going->gname;
			// Now provides information to start the test
			$form['info']=array(
				'#type' => 'markup',
				'#markup'=>'<div class="messages">'._going_datetime_to_string($going->time).' / '.$going->gname.' / '.$going->rname.'</div>',
			);
			// Now fetch the total assigned number of students
			$total=db_select('students_going','sg')->condition('sg.gid',$going->gid)->fields('sg')->countQuery()->execute()->fetchField();
			// Now calculate the valid answers
			$valid=db_select('students_going','sg')->condition('sg.gid',$going->gid)->condition('sg.status',ONLINETEST_STATUS_ENDED)->isNotNull('sg.answers')->fields('sg')->countQuery()->execute()->fetchField();

			$description=t('There are @total students in this going in total, while @valid of them has finished their answers.',array('@total'=>$total, '@valid'=>$valid));
			$description.='<br/>';
			$description.=t('Now will start to review the answers.');
			$submit=t('Begin review');
			break;
		case ONLINETEST_STATUS_INTERVIEWING: // Now about to end the interviewing
			$title=t('Stop review').' - '.$going->gname;
			$form['info']=array(
				'#type' => 'markup',
				'#markup'=>'<div class="messages">'._going_datetime_to_string($going->time).' / '.$going->gname.' / '.$going->rname.'</div>',
			);
			$description=t('Stop the reviewing will cause students id showing in score report and the answer files downloading page.');
			break;
	}
	if($operation_impossible['status'] ) {
		drupal_set_message($operation_impossible['description'], 'error');
		drupal_goto('definations/onlinetests');
	}
	return confirm_form($form, $title,
		'definations/onlinetests',
		$description,
		$submit
	);
}

function onlinetests_operations_submit($form, &$form_state) {
	
	$st=db_select('vl_going','g')->condition('gid',arg(3))->fields('g',array('status'))->execute()->fetchField();
	db_update('vl_going')->condition('gid',arg(3))
		->fields(array(
			'status'=>$st+1,
		))->execute();
	// If about to start the exam, the initialize the students' status
	if($st==ONLINETEST_STATUS_ABOUT_TO_BEGIN) {
		$query=db_select('students_going','sg')->condition('gid',arg(3))->fields('sg',array('uid'))->distinct();
		$result=$query->execute();
		foreach($result as $r) {
			// Generate an eight-digit acccess code for students to use
			$accesscode='';
			$allowable_characters = 'ABCDEFHKLMNPQRSTUVXYZ';
			$len = strlen($allowable_characters) - 1;
			for($i=0;$i<ONLINETEST_ACCESSCODE_LENGTH;$i++)
				$accesscode.=$allowable_characters[mt_rand(0, $len)];
			db_update('students_going')->condition('gid',arg(3))->condition('uid',$r->uid)
				->fields(array(
					'accesscode'=>$accesscode,
					'status'=>ONLINETEST_STATUS_ABOUT_TO_BEGIN,
				))->execute();
		}
	}
	// If about the end the exam, the force end individual student's status
	if($st==ONLINETEST_STATUS_ONGOING) {
		db_update('students_going')->condition('gid',arg(3))
			->fields(array(
				'status'=>ONLINETEST_STATUS_ENDED,
			))->execute();
	}
	// If about to start review the answer, then we need to rename the answer files.
	if($st==ONLINETEST_STATUS_ENDED) {
		$query=db_select('students_going','sg')->condition('sg.gid',arg(3))
			->condition('sg.status',ONLINETEST_STATUS_ENDED)->isNotNull('sg.answers')->fields('sg',array('uid','eid','answers'));
		$result=$query->execute();
		$i=0;
		foreach ($result as $r) {
			$i++;
			$uniqid=sprintf('%c%02d_%s', mt_rand(65,90), mt_rand(0,99), $r->eid);
			$answers=explode(', ', $r->answers);
			foreach($answers as $fileid) {
				$f=file_load($fileid);
				$ext=strrchr($f->filename, '.');
				file_move($f, 'private://onlinetests/answers/'.$uniqid.$ext);
			}
		}
		drupal_set_message(t('@num students\' answer files have been reordered randomly. Please print your score sheet at the page where you can assign the students.', array('@num'=>$i)));
	}
	drupal_set_message(t('Operation done.'));
	$form_state['redirect']='definations/onlinetests';
}

function onlinetests_file_download($uri) {
	$target=file_uri_target($uri);
	if(preg_match('/^onlinetests\/quests/', $target)) {
		if(!user_access('administer online exams') && !user_access('participate online exams')) return -1;
		$query=db_select('file_managed','f')->condition('f.uri',$uri)->fields('f');
		$r=$query->execute()->fetchObject();
		$headers=array(
			'Content-Type' => $r->filemime,
			'Content-Transfer-Encoding' => 'binary',
			'Content-Length' => $r->filesize,
		);

		$ua = $_SERVER["HTTP_USER_AGENT"];
		$filename=$r->filename;
		$encoded_filename = urlencode($filename);
		if (preg_match("/MSIE/", $ua) || preg_match("/Chrome/", $ua)) {
			$headers['Content-Disposition'] = 'attachment; filename="' . $encoded_filename . '"';
		} else if (preg_match("/Firefox/", $ua)) {
			$headers['Content-Disposition'] = 'attachment; filename*="utf8\'\'' . $filename . '"';
		} else {
			$headers['Content-Disposition'] = 'attachment; filename="' . $filename . '"';
		}
		return $headers;
	}
	if(preg_match('/^onlinetests\/answers/', $target)) {
		$query=db_select('file_managed','f')->condition('f.uid',$GLOBALS['user']->uid)->condition('f.uri',$uri)->fields('f')->countQuery();
		$r=$query->execute()->fetchField();
		if($r==1 || $GLOBALS['user']->uid==1) {
			$query=db_select('file_managed','f')->condition('f.uri',$uri)->fields('f');
			$r=$query->execute()->fetchObject();
			$headers=array(
				'Content-Type' => $r->filemime,
				'Content-Transfer-Encoding' => 'binary',
				'Content-Length' => $r->filesize,
			);

			$ua = $_SERVER["HTTP_USER_AGENT"];
			$filename=$r->filename;
			$encoded_filename = urlencode($filename);
			if (preg_match("/MSIE/", $ua) || preg_match("/Chrome/", $ua)) {
				$headers['Content-Disposition'] = 'attachment; filename="' . $encoded_filename . '"';
			} else if (preg_match("/Firefox/", $ua)) {
				$headers['Content-Disposition'] = 'attachment; filename*="utf8\'\'' . $filename . '"';
			} else {
				$headers['Content-Disposition'] = 'attachment; filename="' . $filename . '"';
			}
			return $headers;
		}
	}
	return NULL;
}

function onlinetests_myonlinetests_perm($eid=NULL) {
	$query=db_select('vl_exam','e')->condition('e.etype',3);
	$query->innerJoin('students_going','sg','sg.eid=e.eid');
	$query->innerJoin('vl_going','g','g.gid=sg.gid');
	$query->condition('g.status',ONLINETEST_STATUS_ONGOING);
	$query->fields('sg')->isNotNull('sg.gid')->condition('sg.uid',isset($GLOBALS['user']->name)?$GLOBALS['user']->name:NULL);
	return user_access('participate online exams') && $query->countQuery()->execute()->fetchField();
}

function onlinetests_myonlinetests_for_students($form, $form_state) {
	$uid=$GLOBALS['user']->name;
	$query=db_select('vl_going','g')->condition('g.status',array(ONLINETEST_STATUS_ONGOING, ONLINETEST_STATUS_ENDED),'in');
	$query->innerJoin('students_going','sg','g.gid=sg.gid');
	$query->innerJoin('vl_exam','e','sg.eid=e.eid');
	$query->condition('sg.uid',$uid);
	$query->fields('e',array('ename','eid'))->fields('g',array('gid','gname'))->fields('sg',array('status'));
	$r=$query->execute()->fetchObject();
	drupal_set_title(sprintf("%s - %s", t('My Online tests'), $r->gname));

	$form=array();

	// If the student has not start his exam, show the access code to enter
	if($r->status==ONLINETEST_STATUS_ABOUT_TO_BEGIN) {
		$form['gid']=array(
			'#type'=>'hidden',
			'#value'=>$r->gid,
		);
		$form['eid']=array(
			'#type'=>'hidden',
			'#value'=>$r->eid,
		);
		$form['gname']=array(
			'#type'=>'hidden',
			'#value'=>$r->gname,
		);
		$form['accesscode']=array(
			'#type'=>'textfield',
			'#title'=>t('Access Code'),
			'#required'=>TRUE,
			'#size'=>ONLINETEST_ACCESSCODE_LENGTH+5,
			'#maxlength'=>ONLINETEST_ACCESSCODE_LENGTH,
			'#attributes'=>array('style'=>'font-size: 40px'),
		);
		return confirm_form($form, sprintf("%s - %s", t('My Online tests'), $r->gname),
			'<front>',
			t('Please input the access code given by the administrator.').t('Case Insensitive.'),
			t('Start the test'), t('Back to Home')
		);
	}

	$query=db_select('watchdog','w')->fields('w',array('hostname'))->condition('uid',$GLOBALS['user']->uid)->condition('type','onlinetests')
		->condition('severity',WATCHDOG_INFO)->orderBy('timestamp', 'DESC');
	$valid_remote_address=$query->execute()->fetchField();
	if($valid_remote_address!=$_SERVER['REMOTE_ADDR']) {
		$form['notice']=array(
			'#markup'=>'<div class="messages error">'.t('You are not logged in from registered machine. Please check with administrator.').'</div>'
		);
		return $form;
	}

	$query=db_select('students_going','sg')->fields('sg',array('gid','eid','status','answers'))
		->condition('sg.uid',$GLOBALS['user']->name)->condition('sg.gid',$r->gid)->condition('sg.status',array(ONLINETEST_STATUS_ONGOING,ONLINETEST_STATUS_ENDED),'in');
	$query->innerJoin('vl_exam','e','sg.eid=e.eid');
	$query->fields('e',array('ename'));
	$query->innerJoin('vl_quest','q','q.gid=sg.gid AND q.eid=sg.eid');
	$query->fields('q',array('stem','materials','descriptivetext'));
	$r=$query->execute()->fetchObject();

	$form['gid']=array(
		'#type' => 'hidden',
		'#value' => $r->gid,
	);

	$form['stem']=array(
		'#type' => 'item',
		'#title' => t('Stem'),
		'#markup' => $r->stem,
	);

	$materials=explode(', ', $r->materials);
	$i=1;
	foreach($materials as $material) {
		$q=db_select('file_managed','f')->fields('f',array('uri','filename'))->condition('fid',$material)->execute()->fetchObject();
		$form['orig_material'.$i]=array(
			'#type' => 'item',
			'#title' => t('Material @i', array('@i'=>$i++)),
			'#markup' => l($q->filename,file_create_url($q->uri)),
		);
	}

	if(!empty($r->answers)) {
		$answers=explode(', ', $r->answers);
		$i=1;
		$form['orig_answers']=array(
			'#type' => 'fieldset',
			'#title' => t('Existing Answers'),
			'#collapsible' => TRUE,
			'#collapsed' => FALSE,
		);

		foreach($answers as $answer) {
			$q=db_select('file_managed','f')->fields('f',array('uri','filename'))->condition('fid',$answer)->execute()->fetchObject();
			$form['orig_answers']['orig_answer'.$i]=array(
				'#type' => 'item',
				'#title' => t('Answer @i', array('@i'=>$i++)),
				'#markup' => l($q->filename,file_create_url($q->uri)),
			);
		}
	}

	if($r->status != ONLINETEST_STATUS_ENDED) {
		$form['answersframe']=array(
			'#type' => 'fieldset',
			'#title' => t('Upload new answers'),
			'#description' => '<span style="font-weight: bold; color:red">'.t('Please note that existing answer files will be removed completely, if you upload new answers.').'</span>',
			'#collapsible' => TRUE,
			'#collapsed' => count($answers),
		);
		$form['answersframe']['answers']=array(
			'#type' => 'plupload',
			'#title' => t('Answers'),
			'#required' => !count($answers),
			'#upload_validators' => array(
				'file_validate_extensions' => NULL,
			),
			'#plupload_settings' => array(
				'max_file_size' => '2000mb',
			),
		);
		if(!count($answers)) {
			$form['answers']=$form['answersframe']['answers'];
			unset($form['answersframe']);
		}
		$form['save']=array(
			'#type' => 'submit',
			'#value' => t('Save my work for later use, but do not submit it'),
		);
		$form['submit']=array(
			'#type' => 'submit',
			'#value' => t('Submit my work and end the test'),
		);
	} else {
		drupal_set_message(t('Online tests ended.'));
	}
	return $form;
}

function onlinetests_myonlinetests_for_students_validate($form, $form_state) {
	if(isset($form['accesscode']) && $form_state['values']['accesscode']) {
		$accesscode=db_select('students_going','sg')->condition('uid',$GLOBALS['user']->name)
			->condition('eid',$form_state['values']['eid'])->fields('sg',array('accesscode'))
			->execute()->fetchField();
		if(strtoupper($accesscode)!==trim(strtoupper($form_state['values']['accesscode'])))
			form_set_error('accesscode', t('The Access Code you have entered does not match with our record.'));
	}
}

function onlinetests_myonlinetests_for_students_submit($form, $form_state) {
	if(isset($form['accesscode']) && $form_state['values']['accesscode']) {
		db_update('students_going')->condition('uid',$GLOBALS['user']->name)->condition('gid',$form_state['values']['gid'])->fields(array(
			'status' => ONLINETEST_STATUS_ONGOING
		))->execute();

		watchdog('onlinetests','!user started online tests !gname.',
			array(
				'!user'=>$GLOBALS['user']->name,
				'!gname'=>$form_state['values']['gname'],
			),
			WATCHDOG_INFO
		);
		drupal_set_message(t('Online tests started.'));
	} else {
		$eid=db_select('vl_going','g')->condition('gid',$form_state['values']['gid'])->fields('g',array('valid_exams'))->execute()->fetchField();
		switch($form_state['clicked_button']['#id']) {
			case 'edit-submit':
			case 'edit-save':
				// Let's upload all new files into file_managed
				$files=array();
				foreach($form_state['values']['answers'] as $answer) {
					$file=array(
						'uid' => $GLOBALS['user']->uid,
						'filename' => $answer['name'],
						'uri' => $answer['tmppath'],
						'filemime' => file_get_mimetype($answer['tmppath']),
						'filesize' => filesize($answer['tmppath']),
						'timestamp' => time(),
					);
					$fileobj=(object)$file;
					$fileobj=file_save($fileobj);
					file_usage_add($fileobj, 'onlinetests', 'answer', $GLOBALS['user']->uid);
					$files[]=$fileobj->fid;
				}
				if(count($files)>0) {
					$result=db_select('students_going','sg')->condition('uid',$GLOBALS['user']->name)->condition('gid',$form_state['values']['gid'])->condition('status',2)->fields('sg',array('answers'))->execute();
					foreach($result as $r) {
						$orig_answers=explode(', ', $r->answers);
						foreach($orig_answers as $fileid) {
							$file = file_load($fileid);
							if($file) {
								file_usage_delete($file, 'onlinetests', 'quest', $GLOBALS['user']->uid);
								file_delete($file);
							}
						}
					}
					db_update('students_going')->condition('uid',$GLOBALS['user']->name)->condition('gid',$form_state['values']['gid'])->condition('status',2)->condition('eid',$eid)->fields(array(
						'answers' => implode(', ', $files),
					))->execute();
				}
				if($form_state['clicked_button']['#id']=='edit-submit') {
					$i=1;
					$answers=explode(', ',db_select('students_going','sg')->condition('uid',$GLOBALS['user']->name)->condition('gid',$form_state['values']['gid'])->condition('status',2)->fields('sg',array('answers'))->execute()->fetchField());
					foreach($answers as $answer) {
						$f=file_load($answer);
						$ext=strrchr($f->filename, '.');
						$f->status=FILE_STATUS_PERMANENT;
						$f=file_save($f);
						file_move($f, 'private://onlinetests/answers/'.$GLOBALS['user']->name.'_'.$eid.'_'.$i.$ext);
						$i++;
					}

					db_update('students_going')->condition('uid',$GLOBALS['user']->name)->condition('eid',$eid)->fields(array(
						'status' => ONLINETEST_STATUS_ENDED
					))->execute();
				}
		}
		if($form_state['clicked_button']['#id']=='edit-save') drupal_set_message(t('File saved.'));
		else {
			drupal_set_message(t('Online tests ended.'));
		}
	}
}

function onlinetests_onlinetests_quest_perm($gid=NULL) {
	$query=db_select('vl_going','g')->condition('g.gid',$gid)->condition('g.status',ONLINETEST_STATUS_ONGOING)->fields('g')->countQuery();
	return onlinetests_admin_perm() && $query->execute()->fetchField();
}

function onlinetests_quest_report($gid=NULL) {
	$query=db_select('vl_going','g')->condition('g.gid',$gid)->condition('g.status',ONLINETEST_STATUS_ONGOING)->fields('g');
	$query->innerJoin('vl_room','r','g.place=r.rid');
	$query->addField('r','rname');
	$query->innerJoin('students_going','sg','sg.gid=g.gid');
	$query->addField('sg','accesscode');
	$query->innerJoin('students','s','sg.uid=s.uid');
	$query->fields('s',array('uid','name'));
	$query->distinct();
	$r=$query->execute();

	if(!$r) { return MENU_ACCESS_DENIED; }

	require_once(drupal_get_path('module','onlinetests').'/../tcpdf/config/lang/eng.php');
	require_once(drupal_get_path('module','onlinetests').'/../tcpdf/tcpdf.php');

	ini_set('max_execution_time','500');

	// create new PDF document
	$pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

	// set document information
	$pdf->SetCreator(PDF_CREATOR);
	$pdf->SetTitle('中央音乐学院'.variable_get('zhaoban_current_year',date('Y')).'年本科招生专业考试在线考试试题及考试说明');
	$pdf->SetAuthor('中央音乐学院');

	$pdf->SetFont('droidsansfallbackfull', 'B', 14, '', true);
	// set default font subsetting mode
	$pdf->setFontSubsetting(false);

	$pdf->setPrintHeader(false);
	$pdf->setPrintFooter(false);

	$pdf->SetMargins(6, 6, 6);
	$pdf->SetAutoPageBreak(false);

	//set some language-dependent strings
	$pdf->setLanguageArray($l);
	$pdf->SetFillColor(216,216,216);
	$pdf->SetDrawColor(255,255,255);
	$pdf->SetLineWidth(0.5);

	foreach($r as $s) {
		$pdf->AddPage();
		$pdf->SetDrawColor(255,255,255);

		// Header
		$pdf->SetFontSize(25);
		$pdf->setX(6);$pdf->setY(6);
		$pdf->Cell(198,20,'中央音乐学院'.variable_get('zhaoban_current_year',date('Y')).'年本科招生在线考试试题',1,1,'C',true);

		$pdf->SetFontSize(16);
		$pdf->Cell(198,12,_going_datetime_to_string($s->time).' / '.$s->gname.' / '.$s->rname,1,1,'C',false);

		$pdf->SetFontSize(10);
		$description ='&nbsp;<br/>答题要求：<br/><br/>';
		$description.='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;① 使用自己的准考证号和密码登录 '.$GLOBALS['base_url'].' 网站。如遗忘密码可在网站自行重设密码。<br/>';
		$description.='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;② 登录后选择【我的在线考试】功能。<br/>';
		$description.='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;③ 根据网站提示输入本试题中提供的试题访问代码，可查看试题及下载有关材料。下载材料后请先进行试听，确认无误后等待考试开始信号发出再行作答。<br/>';
		$description.='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;④ 答题结束，将有关答案文件上传至该网站。请先选择【临时保存】，上传结束后请从网站重新下载上传的答案文件，确定可以正常打开后，再点击网站上的【交卷结束考试】按钮，并在本试题页结尾处签名。因上传大文件需要一定时间，为避免临近考试结束时出现网络拥堵，请考生合理安排自己的答题时间。<br/>';
		$description.='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;考试时间终了时仍未点击【交卷结束考试】的考生，将被视为白卷。后果由考生自负。<br/>';
		$pdf->SetCellPaddings(3,3,3,3);
		$pdf->WriteHTMLCell(198,40,6,38,$description,1,1,'L',true,'',0,false,'T','T');

		$pdf->Cell(20,6,'准考证号',1,0,'C',true);
		$pdf->Cell(40,6,$s->uid,0,0,'L',false);
		$pdf->Cell(20,6,'姓名',1,0,'C',true);
		$pdf->Cell(60,6,$s->name,0,0,'L',false);
		$pdf->Cell(30,6,'试题访问代码',1,0,'C',true);
		$pdf->Cell(80,6,$s->accesscode,0,0,'L',false);

		$query=db_select('vl_quest','q')->condition('q.gid',$gid);
		$query->innerJoin('vl_exam','e','q.eid=e.eid');
		$query->addField('e','ename');
		$query->fields('q',array('gid','eid','stem'));
		$query->innerJoin('students_going','sg','sg.gid=q.gid AND sg.eid=e.eid');
		$query->condition('sg.uid',$s->uid);
		$query->orderBy('e.eid');
		$exams=$query->execute();
		foreach($exams as $e) {
			$pdf->SetDrawColor(0,0,0);
			$pdf->Line(6,$pdf->GetY()+12,204,$pdf->GetY()+12);
			$pdf->SetFontSize(20);
			$pdf->setY($pdf->GetY()+10);
			$pdf->Cell(200,4,$e->ename.' 试题',0,0,'L',false);
			$pdf->SetFontSize(12);
			$pdf->Ln();
			$pdf->MultiCell(200,6,$e->stem,0,'L',false);
		}
		$pdf->Line(6,$pdf->GetY()+12,204,$pdf->GetY()+12);
		$pdf->Ln();
		$pdf->Cell(30,6,'交卷签名：');
		$pdf->Ln();
		$pdf->MultiCell(200,6,'交卷签名即表示我已经将所有的答案文件上传至规定网站，所有文件重新下载后均可正常打开。',0,'L',false);
	}
	$pdf->Output(variable_get('zhaoban_current_year',date('Y')).'_'.$gid.'.pdf', 'I');
}

function onlinetests_print_score_report($gid=NULL)
{
	require_once(drupal_get_path('module','going').'/../tcpdf/config/lang/eng.php');
	require_once(drupal_get_path('module','going').'/../tcpdf/tcpdf.php');
	
	$query=db_select('vl_going','g')->fields('g')->condition('g.gid',$gid);
	$query->innerJoin('vl_room','r','g.place=r.rid');
	$going=$query->fields('r')->execute()->fetchObject();
	$exam_ids=explode(', ', $going->valid_exams);
	
	set_time_limit(300);

	// Extend the TCPDF class to create custom Header and Footer
	class MYPDF extends TCPDF {

	//Page header
	public function Header() {
		$this->setHeaderMargin(30);
		$this->SetX(10);
		$this->SetY(8);
	// Set font
	$this->SetFont('droidsansfallbackfull', 'B', 24, '', true);
	// Title
	$header_titles=explode(',', $this->header_title);
	$this->Cell(0, 10, $header_titles[0], 0, false, 'C', 0, '', 0, false, 'M', 'M');
	$this->Ln();
	$this->SetFont('droidsansfallbackfull', 'B', 15, '', true);
	$this->Cell(60, 5, $header_titles[1], 0, false, 'C', 0, '', 0, false, 'M', 'M');
	$this->Cell(0, 5, $header_titles[2], 0, false, 'C', 0, '', 0, false, 'M', 'M');
	$this->SetFont('droidsansfallbackfull', 'B', 12, '', true);
	$this->Ln();
	$this->Cell(10, 2, '序号',0, false, 'C');
	$this->Cell(40, 2, t('考生编号'),0, false, 'C');
	$this->Cell(30, 2, '专业',0, false, 'C');
	$this->Cell(55, 2, '成绩',0, false, 'C');
	$this->Cell(52, 2, '备注',0, false, 'C');
	$this->Line(6,32,200,32);
	}

	// Page footer
	public function Footer() {
	// Position at 15 mm from bottom
	$this->SetY(-13);
	$this->SetX(5);
	//$this->Line(5,198,292,198,array('width'=>0.5));
	// Set font
	// Page number
	$this->SetFont('droidsansfallbackfull', 'B', 11, '', true);
	$this->Cell(220,12, '评委签字', 0, false, 'C');
	}
	}
	// create new PDF document
	$pdf = new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
	$datetime=intval(substr($going->time,4,2)).'月'.intval(substr($going->time,6,2)).'日 '.intval(substr($going->time,8,2)).':'.substr($going->time,10,2).' ';
	$datetime.=db_select('vl_room','r')->condition('r.rid',$going->place)->fields('r',array('rname'))->execute()->fetchField();
	$pdf->setHeaderData('',0,variable_get('zhaoban_current_year',date('Y')).'年中央音乐学院本科招生考试打分表,'.$datetime.','.$going->gname,'');
	$pdf->SetProtection(array('modify','copy','extract'));

	// set document information
	$pdf->SetCreator(PDF_CREATOR);

	// Set font
	// dejavusans is a UTF-8 Unicode font, if you only need to
	// print standard ASCII chars, you can use core fonts like
	// helvetica or times to reduce file size.
	//$pdf->SetFont('droidsansfallback', 'B', 10, '', true);
	// set default font subsetting mode
	$pdf->setFontSubsetting(true);

	$pdf->setPrintHeader(true);
	$pdf->setPrintFooter(true);

	$pdf->SetMargins(6, 33, 6);
	$pdf->SetAutoPageBreak(true, 15);

	//set some language-dependent strings
	$pdf->setLanguageArray($l);
	
	$query=db_select('students_going','sg')->condition('sg.gid',$gid)->condition('sg.status',ONLINETEST_STATUS_ENDED)->isNotNull('sg.answers');
	$query->innerJoin('students','s','sg.uid=s.uid');
	$query->innerJoin('vl_professions','p','s.profession_major=p.pid');
	$query->groupBy('s.uid')->fields('s',array('uid','name'))->fields('sg',array('uid','gorder','answers'))->fields('p',array('pname'))->orderRandom();

	$pdf->AddPage();
	$pdf->SetFillColor(216,216,216);
	$pdf->SetDrawColor(0,0,0);
	$pdf->SetLineWidth(0.5);
	$pdf->SetLineStyle(array('dash'=>2));
	
	$results=$query->execute();
	$pdf->SetFont('droidsansfallbackfull', 'B', 12, '', true);
	$i=1;
	foreach($results as $r) {
		$pdf->SetFillColor(216,216,216);
		$pdf->Cell(10,2,$i++, 0, false, 'C',true);
		$pdf->SetFillColor(255,255,255);
		$answers=explode(',',$r->answers);
		foreach($answers as $fileid) {
			$f=file_load($fileid);
			$fname=substr($f->filename, 0,3);
			break;
		}
		if($going->status==ONLINETEST_STATUS_INTERVIEWING)
			$pdf->Cell(40,2,$fname, 0, false, 'C',true);
		else
			$pdf->Cell(40,2,sprintf("%s %s", $r->uid, $r->name), 0, false, 'C',true);
		$pdf->Cell(30,2,$r->pname, 0, false, 'C',true);

		$pdf->Ln();
		$pdf->Ln();
		$pdf->Line(6,$pdf->GetY()-2,200,$pdf->GetY()-2);
	}
	$pdf->Output('score_report.pdf', 'I');
	
}

function onlinetests_print_score_report_perm($gid=NULL) {
	$query=db_select('vl_going','g')->condition('g.gid',$gid)->condition('g.status',ONLINETEST_STATUS_INTERVIEWING,'>=')->fields('sg');
	$r=$query->countQuery()->execute()->fetchField();
	return user_access('print order list') && $r;
}

function _onlinetests_formatRawSize($bytes) {
	if(!empty($bytes)) {
		$s = array(t('bytes'), 'kb', 'MB', 'GB', 'TB', 'PB');
		$e = floor(log($bytes)/log(1024));
		$output = sprintf('%.2f '.$s[$e], ($bytes/pow(1024, floor($e))));
		return $output;
	}
}

function onlinetests_answer_list($gid=NULL) {
	$query=db_select('vl_going','g')->condition('gid',$gid)->fields('g');
	$query->innerJoin('vl_room','r','g.place=r.rid');
	$query->fields('r',array('rname'));
	$going=$query->execute()->fetchObject();
	drupal_set_title(sprintf('%s - %s', t('Download the answers files'), $going->gname));
	$output='';
	
	$output.='<div class="messages">'._going_datetime_to_string($going->time).' / '.$going->gname.' / '.$going->rname.'</div>';

	// Now fetch the total assigned number of students
	$total=db_select('students_going','sg')->condition('sg.gid',$gid)->fields('sg')->countQuery()->execute()->fetchField();
	// Now calculate the valid answers
	$valid=db_select('students_going','sg')->condition('sg.gid',$gid)->condition('sg.status',ONLINETEST_STATUS_ENDED)->isNotNull('sg.answers')->fields('sg')->countQuery()->execute()->fetchField();
	$output.=t('There are @total students in this going in total, while @valid of them has finished their answers.',array('@total'=>$total, '@valid'=>$valid));
	$header=array(
		t('No.'),
		t('Raw number'),
		t('Student ID'),
		t('Answer files'),
	);
	if($going->status==ONLINETEST_STATUS_INTERVIEWING)
		unset($header[2]);
	$rows=array();
	$query=db_select('students_going','sg')->condition('sg.gid',$gid)->condition('sg.status',ONLINETEST_STATUS_ENDED)->isNotNull('sg.answers')->fields('sg')->orderRandom();
	$query->innerJoin('students','s','sg.uid=s.uid');
	$query->fields('s',array('name'));
	$result=$query->execute();
	$i=1;
	foreach($result as $r) {
		$answers=explode(',',$r->answers);
		$fileid=$answers[0];
		$f=file_load($fileid);
		$fname=substr($f->filename, 0,3);
		unset($f);
		$links=array();
		foreach($answers as $f) {
			$f=file_load($fileid);
			$links[]=sprintf('%s (%s)',l($f->filename,file_create_url($f->uri)), _onlinetests_formatRawSize($f->filesize));
		}
		$rows[]=array(
			$i,
			$fname,
			sprintf("%s %s", $r->uid, $r->name),
			(count($links)==1)?$links[0]:'<ul><li>'.implode('</li><li>',$links).'</li></ul>',
		);
		if($going->status==ONLINETEST_STATUS_INTERVIEWING)
			unset($rows[count($rows)-1][2]);
	}
	$output .= theme('table', array('header'=>$header, 'rows'=>$rows, 'empty'=>t('No suitable students.')));
	return $output;
}
