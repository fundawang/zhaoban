<?php

/*
 * This file is licensed under GPLv2+.
*/

/**
 * @file
 * Provides the basic information of signup program, such as provinces and nationalities.
 */

/**
 * Implementation of hook_help().
 */
function essential_help($path, $arg) {
  return NULL;
}

/**
 * Implementation of hook_menu().
 */
function essential_menu() {
}

/**
 * Implements hook_block_info().
 */
function essential_block_info() {
	$result=array();
	
	$result['weather'] = array(
		'info' => t('Weather'),
		'cache' => DRUPAL_CACHE_GLOBAL,
	);
	return $result;
}

/**
 * Implements hook_block_view().
 */
function essential_block_view($delta = '') {
	global $user;
	$block = array();
	switch ($delta) {
		case 'weather':
			$options=array('timeout'=>1);
			$valid_code=array('302','200');
			$r=drupal_http_request("http://m.weather.com.cn/data/101010100.html",$options);
			if(in_array($r->code, $valid_code)) {
				$r=json_decode($r->data)->weatherinfo;
				$block['subject'] = t('Weather of @city',array('@city'=>$r->city));
				$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/d%02d.gif",$r->img1),$options);
				if(!in_array($h->code, $valid_code)) return;
				$img=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">', base64_encode($h->data), $r->img_title1);
				$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/n%02d.gif",($r->img2==99?$r->img1:$r->img2)),$options);
				if(!in_array($h->code, $valid_code)) return;
				$img.=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">&nbsp;', base64_encode($h->data), $r->img_title2);
				$block['content'] = t('Today: ').$img.$r->weather1.' '.$r->temp1;
				$block['content'].= '<br/>';
				$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/d%02d.gif",$r->img3),$options);
				if(!in_array($h->code, $valid_code)) return;
				$img=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">', base64_encode($h->data), $r->img_title3);
				$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/n%02d.gif",($r->img4==99?$r->img3:$r->img4)),$options);
				if(!in_array($h->code, $valid_code)) return;
				$img.=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">&nbsp;', base64_encode($h->data), $r->img_title4);
				$block['content'].= t('Tomorrow: ').$img.$r->weather2.' '.$r->temp2;
				$block['content'].= '<br/>';
				$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/d%02d.gif",$r->img5),$options);
				if(!in_array($h->code, $valid_code)) return;
				$img=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">', base64_encode($h->data), $r->img_title5);
				$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/n%02d.gif",($r->img6==99?$r->img5:$r->img6)),$options);
				if(!in_array($h->code, $valid_code)) return;
				$img.=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">&nbsp;', base64_encode($h->data), $r->img_title6);
				$block['content'].= t('The day after tommorrow: ').$img.$r->weather3.' '.$r->temp3;
			}
	}
	return $block;
}
