<?php

/*
 * This file is licensed under GPLv2+.
*/

/**
 * @file
 * Provides the basic information of signup program, such as provinces and nationalities.
 */

/**
 * Implementation of hook_help().
 */
function essential_help($path, $arg) {
  return NULL;
}

/**
 * Implementation of hook_menu().
 */
function essential_menu() {
}

/**
 * Implements hook_block_info().
 */
function essential_block_info() {
	$result=array();
	
	$result['weather'] = array(
		'info' => t('Weather'),
		'cache' => DRUPAL_CACHE_GLOBAL,
	);
	return $result;
}

/**
 * Implements hook_block_view().
 */
function essential_block_view($delta = '') {
	global $user;
	$block = array();
	switch ($delta) {
		case 'weather':
			$options=array('timeout'=>1);
			$valid_code=array('302','200');
			$r=json_decode(variable_get('current_weather',''))->weatherinfo;
			if($r===FALSE) return;
			$block['subject'] = t('Weather of @city',array('@city'=>$r->city));
			$c=($r->fchh>=15?'n':'d');
			$period=($r->fchh>=15?t('night to tomorrow day'):t('day to night'));
			$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/%s%02d.gif",$c,$r->img1),$options);
			if(!in_array($h->code, $valid_code)) return;
			$img=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">', base64_encode($h->data), $r->img_title1);
			$c=($r->fchh>=15?'d':'n');
			$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/%s%02d.gif",$c,($r->img2==99?$r->img1:$r->img2)),$options);
			if(!in_array($h->code, $valid_code)) return;
			$img.=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">&nbsp;', base64_encode($h->data), $r->img_title2);
			$block['content'] = '<b>'.t('This @period',array('@period'=>$period)).'</b><br/>'.$img.$r->weather1.' '.$r->temp1;
			$block['content'].= '<br/>';
			$c=($r->fchh>=15?'n':'d');
			$period=($r->fchh>=15?t('night to the day after tomorrow day'):t('day to night'));
			$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/%s%02d.gif",$c,$r->img3),$options);
			if(!in_array($h->code, $valid_code)) return;
			$img=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">', base64_encode($h->data), $r->img_title3);
			$c=($r->fchh>=15?'d':'n');
			$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/%s%02d.gif",$c,($r->img4==99?$r->img3:$r->img4)),$options);
			if(!in_array($h->code, $valid_code)) return;
			$img.=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">&nbsp;', base64_encode($h->data), $r->img_title4);
			$block['content'].= '<b>'.t('Tomorrow @period',array('@period'=>$period)).'</b><br/>'.$img.$r->weather2.' '.$r->temp2;
			$block['content'].= '<br/>';
			$c=($r->fchh>=15?'n':'d');
			$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/%s%02d.gif",$c,$r->img5),$options);
			if(!in_array($h->code, $valid_code)) return;
			$img=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">', base64_encode($h->data), $r->img_title5);
			$c=($r->fchh>=15?'d':'n');
			$period=($r->fchh>=15?t('night to the next day'):t('day to night'));
			$h=drupal_http_request(sprintf("http://www.weather.com.cn/m2/i/icon_weather/29x20/%s%02d.gif",$c,($r->img6==99?$r->img5:$r->img6)),$options);
			if(!in_array($h->code, $valid_code)) return;
			$img.=sprintf('&nbsp;<img src="data:image/gif;base64,%s" title="%s">&nbsp;', base64_encode($h->data), $r->img_title6);
			$block['content'].= '<b>'.t('The day after tommorrow @period',array('@period'=>$period)).'</b><br/>'.$img.$r->weather3.' '.$r->temp3;
	}
	return $block;
}

/**
 * Implements hook_cron().
 */
function essential_cron() {
	$options=array('timeout'=>1);
	$valid_code=array('302','200');
	$r=drupal_http_request("http://m.weather.com.cn/data/101010100.html",$options);
	if($r->code=='200') variable_set('current_weather', $r->data);
	else variable_del('current_weather');
}
